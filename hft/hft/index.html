
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../simulator/performance/">
      
      
        <link rel="next" href="../feed/">
      
      
      <link rel="icon" href="../../icons/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>quantpylib.hft - quantpylib</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="lime">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#examples" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="quantpylib" class="md-header__button md-logo" aria-label="quantpylib" data-md-component="logo">
      
  <img src="../../icons/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            quantpylib
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              quantpylib.hft
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../simulator/simulator/" class="md-tabs__link">
          
  
  
  User Documentation

        </a>
      </li>
    
  

    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../scripts/market_making/" class="md-tabs__link">
          
  
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../learn/learn/" class="md-tabs__link">
          
  
  
  Learn

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../bounties/" class="md-tabs__link">
          
  
  
  Bounties

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="quantpylib" class="md-nav__button md-logo" aria-label="quantpylib" data-md-component="logo">
      
  <img src="../../icons/logo.png" alt="logo">

    </a>
    quantpylib
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    User Documentation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    quantpylib
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            quantpylib
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1_1" id="__nav_2_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.simulator
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.simulator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulator/simulator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.simulator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulator/alpha/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.simulator.alpha
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulator/gene/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.simulator.gene
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulator/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.simulator.models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulator/operators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.simulator.operators
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulator/performance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.simulator.performance
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1_2" id="__nav_2_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.hft
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.hft
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    quantpylib.hft
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    <span class="md-ellipsis">
      Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-feed" class="md-nav__link">
    <span class="md-ellipsis">
      Data Feed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-archival" class="md-nav__link">
    <span class="md-ellipsis">
      Data Archival
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#oms" class="md-nav__link">
    <span class="md-ellipsis">
      OMS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#market-making" class="md-nav__link">
    <span class="md-ellipsis">
      Market-Making
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit-order-book" class="md-nav__link">
    <span class="md-ellipsis">
      Limit-Order Book
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trades" class="md-nav__link">
    <span class="md-ellipsis">
      Trades
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statistics" class="md-nav__link">
    <span class="md-ellipsis">
      Statistics
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../feed/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.feed
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../oms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.oms
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mocks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.mocks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lob/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.lob
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trades/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.trades
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.features
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../stats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.stats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_3" >
        
          
          <label class="md-nav__link" for="__nav_2_1_3" id="__nav_2_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.throttler
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_3">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.throttler
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../throttler/throttler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.throttler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../throttler/aiohttp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.throttler.aiohttp
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../throttler/aiosonic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.throttler.aiosonic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../throttler/httpx/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.throttler.httpx
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../throttler/rate_semaphore/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.throttler.rate_semaphore
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../throttler/decorators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.throttler.decorators
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_4" >
        
          
          <label class="md-nav__link" for="__nav_2_1_4" id="__nav_2_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.utilities
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_4">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.utilities
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/utilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.utilities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/general/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.utilities.general
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/math/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.utilities.math
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/cringbuffer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.utilities.cringbuffer
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_5" >
        
          
          <label class="md-nav__link" for="__nav_2_1_5" id="__nav_2_1_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_5">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.datapoller
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/datapoller/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/master/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.master
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.base
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/crypto/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.crypto
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/currencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.currencies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/equities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.equities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/exchange/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.exchange
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/metadata/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.metadata
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_6" >
        
          
          <label class="md-nav__link" for="__nav_2_1_6" id="__nav_2_1_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.gateway
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_6">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.gateway
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/gateway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/account/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.account
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.base
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/exchange/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.exchange
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/executor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.executor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/master/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.master
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/orders/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.orders
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/positions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.positions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_7" >
        
          
          <label class="md-nav__link" for="__nav_2_1_7" id="__nav_2_1_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.standards
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_7">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.standards
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/standards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.standards
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/intervals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.standards.intervals
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/markets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.standards.markets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/portfolio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.standards.portfolio
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_8" >
        
          
          <label class="md-nav__link" for="__nav_2_1_8" id="__nav_2_1_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_8">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.wrappers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/wrappers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/binance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.binance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/bybit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.bybit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/hyperliquid/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.hyperliquid
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/paradex/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.paradex
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/woox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.woox
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/polymarket/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.polymarket
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/eodhd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.eodhd
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/oanda/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.oanda
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/yfinance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.yfinance
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_9" >
        
          
          <label class="md-nav__link" for="__nav_2_1_9" id="__nav_2_1_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.logger
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_9">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.logger
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logger/logger/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.logger
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logger/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.logger.utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logger/formatters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.logger.formatters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logger/handlers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.logger.handlers
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/market_making/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Market Maker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/tick_archival/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tick Archival
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/trend_following/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trend Follower
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Learn
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Learn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learn/learn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Learn
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../learn/scientific_programming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scientific Programming
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Bounties
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Bounties
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bounties/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bounties
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>quantpylib.hft</h1>

<p><a href="."><code>quantpylib.hft</code></a> is our core module designed for hft-trading purposes, including modelling, analysis and simulation of high-frequency data.</p>
<p><a href="./alpha.md"><code>quantpylib.hft.alpha</code></a> is our simulator, modeller and backtester. You may simulate fills, portfolio wealth and do statistical modelling, such as fair price analysis.</p>
<p><a href="../feed/"><code>quantpylib.hft.feed</code></a> is our data feeder for public information and market data such as order book and trade feeds.</p>
<p><a href="../oms/"><code>quantpylib.hft.oms</code></a> is our order management system for positions, orders tracking and trade execution + management.</p>
<p><a href="../lob/"><code>quantpylib.hft.lob</code></a> is our internal limit-order book representation, and is designed to store orderbook states and buffers. There are utility functions to keep accurate representations of the internal state for both book snapshots and incremental updates. A host of other utility functions related to orderbook modelling can be found.</p>
<p><a href="../trades/"><code>quantpylib.hft.trades</code></a> is our internal trade buffer. There are utility functions to compute useful information and statistics from the data stored in the buffer.</p>
<p><a href="./statistics.md"><code>quantpylib.hft.statistics</code></a> is a statistics library for hft modelling - in addition it should work seamlessly with the data structures in the <code>quantpylib.hft.lob.LOB</code> and <code>quantpylib.hft.trades.Trades</code> object instances.</p>
<h2 id="examples">Examples</h2>
<h3 id="data-feed">Data Feed</h3>
<p>Obtaining data feeds are extremely simple with <a href="../feed/"><code>quantpylib.hft.feed.Feed</code></a> objects. Simply - create a gateway object with the correct keys
and pass them in</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span> 
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="n">load_dotenv</span><span class="p">()</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.gateway.master</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gateway</span> 
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.feed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Feed</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="n">keys</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="s2">&quot;binance&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;secret&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">},</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>    <span class="s2">&quot;hyperliquid&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;secret&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">},</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="p">}</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">printer</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">printer_1</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">printer_2</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;2</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>    <span class="n">exchange</span><span class="p">,</span><span class="n">ticker</span> <span class="o">=</span> <span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span> <span class="s1">&#39;BTC&#39;</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>    <span class="c1"># exchange,ticker = &#39;binance&#39;, &#39;BTCUSDT&#39;</span>
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Gateway</span><span class="p">(</span><span class="n">config_keys</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>    <span class="k">await</span> <span class="n">gateway</span><span class="o">.</span><span class="n">init_clients</span><span class="p">()</span>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>    <span class="n">feed</span> <span class="o">=</span> <span class="n">Feed</span><span class="p">(</span><span class="n">gateway</span><span class="o">=</span><span class="n">gateway</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>    <span class="c1">#code goes here</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>    <span class="k">pass</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
To use binance, simply uncomment the line above. Proceeding... </p>
<p>To get a order book feed, we can write:
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>    <span class="n">l2_feed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">feed</span><span class="o">.</span><span class="n">add_l2_book_feed</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exchange</span><span class="p">,</span><span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="n">printer_1</span><span class="p">)</span>
</code></pre></div>
and we get <code>hyperliquid/perp/l2book/BTC_depth20</code>. Notice how we added a handler here - this is optional. We can add arbitrary number of coroutine handlers -
when the feed is received, it will be broadcast to all handlers asynchronously. All the schema is standardized - there is no need to write exchange-dependent code.
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>feed.add_handler_to_feed(l2_feed,printer_2)
</code></pre></div>
We will get (the same message)
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>1
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a> {&#39;ts&#39;: 1725903430442, 
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a> &#39;bids&#39;: array([[5.65460e+04, 8.75000e-03],
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>       [5.65430e+04, 9.33710e-01],
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>       ...
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>       [5.65220e+04, 1.98847e+00]]), 
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a> &#39;asks&#39;: array([[5.65470e+04, 2.20767e+00],
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>       [5.65480e+04, 1.67035e+00],
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>       ...
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>       [5.65710e+04, 2.64770e-01]])}
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>2
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a> {&#39;ts&#39;: 1725903430442, 
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a> &#39;bids&#39;: array([[5.65460e+04, 8.75000e-03],
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>       [5.65430e+04, 9.33710e-01],
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>       ...
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>       [5.65220e+04, 1.98847e+00]]), 
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a> &#39;asks&#39;: array([[5.65470e+04, 2.20767e+00],
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>       [5.65480e+04, 1.67035e+00],
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>       ...
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>       [5.65710e+04, 2.64770e-01]])}
</code></pre></div>
This message is constructed from order-book delta updates - it is a local order book state. We can also control the depth of the streams, speed of update and how much data buffer we keep. This data buffer is actually given to us as a <a href="../lob/"><code>quantpylib.hft.lob.LOB</code></a> object -  we can retrieve it using the feed id.
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">lob</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">get_feed</span><span class="p">(</span><span class="n">l2_feed</span><span class="p">)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nb">print</span><span class="p">(</span><span class="n">l2_feed</span><span class="p">)</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="nb">print</span><span class="p">(</span><span class="n">lob</span><span class="p">)</span> <span class="c1">#`quantpylib.hft.lob.LOB` object</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="nb">print</span><span class="p">(</span><span class="n">lob</span><span class="o">.</span><span class="n">get_mid</span><span class="p">(),</span> <span class="n">lob</span><span class="o">.</span><span class="n">get_vamp</span><span class="p">(</span><span class="n">notional</span><span class="o">=</span><span class="mi">30000</span><span class="p">))</span> <span class="c1">#54884.5 54883.872068603436</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">lob</span><span class="o">.</span><span class="n">get_bids_buffer</span><span class="p">())</span>
</code></pre></div>
We can get the time-series of bids, most recent mid-price, bba, vamp indicators and what not from this object.
It is equally simple to get the trades feed, obtain a <code>quantpylib.hft.trades.Trades</code> object and get the running buffer, statistics and what not:
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">trades_feed</span> <span class="o">=</span> <span class="k">await</span> <span class="n">feed</span><span class="o">.</span><span class="n">add_trades_feed</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exchange</span><span class="p">,</span><span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="n">printer</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">trades</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">get_feed</span><span class="p">(</span><span class="n">trades_feed</span><span class="p">)</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="nb">print</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span> <span class="c1">#`quantpylib.hft.trades.Trades` object</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="nb">print</span><span class="p">(</span><span class="n">trades</span><span class="o">.</span><span class="n">get_imbalance</span><span class="p">())</span> <span class="c1">#0.8328041302230744</span>
</code></pre></div>
The messages look like this:
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>(1725904146989, 56497.0, 0.00037, -1)
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>(1725904147170, 56498.0, 0.01171, 1)
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>(1725904147773, 56498.0, 0.02284, 1)
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>(1725904148396, 56497.0, 0.03539, -1)
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>(1725904148401, 56498.0, 0.14221, 1)
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>(1725904148401, 56498.0, 0.52174, 1)
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>(1725904148401, 56498.0, 1.06198, 1)
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>(1725904148401, 56498.0, 0.27407, 1)
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>(1725904153032, 56492.0, 0.00887, 1)
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>(1725904154037, 56490.0, 0.00022, 1)
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>(1725904157831, 56476.0, 0.002, 1)
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>(1725904158024, 56475.0, 0.00021, -1)
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>(1725904159031, 56476.0, 0.00963, 1)
</code></pre></div>
It is simple to interpret: <code>time, price, size, dir</code>. When <code>dir = 1</code>, it means a taker buy initiated trade. </p>
<p>Get all the running feed ids here:
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nb">print</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">get_feed_ids</span><span class="p">())</span>
</code></pre></div></p>
<h3 id="data-archival">Data Archival</h3>
<p>In the <a href="#data-feed">previous section</a> we have seen how easy it is to run tick data streams, add handlers and use <code>LOB</code> and <code>Trade</code> buffers to compute live statistics efficiently for high-frequency strategies. We would also like to have a data archival feature that allows us to store tick-data in a seamless manner to disk.</p>
<p>Like, one-liner seamless. Let me demonstrate. We will do the same imports and setup:
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span> 
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="n">load_dotenv</span><span class="p">()</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.feed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Feed</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.gateway.master</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gateway</span> 
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="n">keys</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>    <span class="s2">&quot;binance&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;secret&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">},</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>    <span class="s2">&quot;hyperliquid&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;secret&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">},</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="p">}</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="n">exchanges</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">]</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>    <span class="k">pass</span> <span class="c1">#&lt;&lt;&lt;</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
except this time we instantiate the feed with a flag <code>archiver=True</code> and list of tickers we want to archive:
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="n">l2_feeds</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>        <span class="s2">&quot;binance&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;BTCUSDT&#39;</span><span class="p">,</span><span class="s1">&#39;ETHUSDT&#39;</span><span class="p">],</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>        <span class="s2">&quot;hyperliquid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span><span class="s1">&#39;SOL&#39;</span><span class="p">]</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="p">}</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="n">trade_feeds</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        <span class="s2">&quot;binance&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;BTCUSDT&#39;</span><span class="p">,</span><span class="s1">&#39;ETHUSDT&#39;</span><span class="p">],</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>        <span class="s2">&quot;hyperliquid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span><span class="s1">&#39;SOL&#39;</span><span class="p">]</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    <span class="p">}</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>    <span class="n">gateway</span> <span class="o">=</span> <span class="n">Gateway</span><span class="p">(</span><span class="n">config_keys</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>    <span class="k">await</span> <span class="n">gateway</span><span class="o">.</span><span class="n">init_clients</span><span class="p">()</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="n">feed</span> <span class="o">=</span> <span class="n">Feed</span><span class="p">(</span><span class="n">gateway</span><span class="o">=</span><span class="n">gateway</span><span class="p">,</span><span class="n">archiver</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#enable archiver</span>
</code></pre></div>
then we add the magic line:
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>    <span class="k">await</span> <span class="n">feed</span><span class="o">.</span><span class="n">run_archive_scheduler</span><span class="p">()</span>
</code></pre></div>
and the rest is as per normal (we skip the optional handler) and let the data stream forever.
The <code>run_archive_scheduler</code> can be configured to flush data to disk and free up RAM quicker in large
scale data archival with <code>splits</code> argument - by default <code>splits=1</code>.
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>    <span class="k">for</span> <span class="n">exchange</span> <span class="ow">in</span> <span class="n">exchanges</span><span class="p">:</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>        <span class="n">l2_feed_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>            <span class="n">feed</span><span class="o">.</span><span class="n">add_l2_book_feed</span><span class="p">(</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>                <span class="n">exc</span><span class="o">=</span><span class="n">exchange</span><span class="p">,</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>                <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>                <span class="n">depth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>            <span class="p">)</span> <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">l2_feeds</span><span class="p">[</span><span class="n">exchange</span><span class="p">]</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>        <span class="p">])</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">l2_feed_ids</span><span class="p">)</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="sd">        [&#39;binance/perp/l2book/BTCUSDT_depth20&#39;, &#39;binance/perp/l2book/ETHUSDT_depth20&#39;]</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="sd">        [&#39;hyperliquid/perp/l2book/BTC_depth20&#39;, &#39;hyperliquid/perp/l2book/SOL_depth20&#39;]</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="sd">        &#39;&#39;&#39;</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        <span class="n">trade_feed_ids</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>            <span class="n">feed</span><span class="o">.</span><span class="n">add_trades_feed</span><span class="p">(</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>                <span class="n">exc</span><span class="o">=</span><span class="n">exchange</span><span class="p">,</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>                <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>            <span class="p">)</span> <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">trade_feeds</span><span class="p">[</span><span class="n">exchange</span><span class="p">]</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>        <span class="p">])</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>        <span class="nb">print</span><span class="p">(</span><span class="n">trade_feed_ids</span><span class="p">)</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="sd">        [&#39;binance/perp/trades/BTCUSDT&#39;, &#39;binance/perp/trades/ETHUSDT&#39;]</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="sd">        [&#39;hyperliquid/perp/trades/BTC&#39;, &#39;hyperliquid/perp/trades/SOL&#39;]</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="sd">        &#39;&#39;&#39;</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1e59</span><span class="p">)</span>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>    <span class="k">await</span> <span class="n">feed</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    <span class="k">await</span> <span class="n">gateway</span><span class="o">.</span><span class="n">cleanup_clients</span><span class="p">()</span>
</code></pre></div></p>
<p>And you will see that at the turn of every hour, the data for that hourly period is saved like this:
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>./archives/{exchange}/{feed_cls}/{feed_type}/{yy}/{mm}/{ticker}{_metadata}_{ddhh}.parquet
</code></pre></div>
so from the <code>archives/</code> folder:
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>./binance/perp/trades/2024/12/BTCUSDT_3014.parquet
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>./binance/perp/trades/2024/12/ETHUSDT_3014.parquet
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>./binance/perp/l2book/2024/12/BTCUSDT_depth20_3014.parquet
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>./binance/perp/l2book/2024/12/ETHUSDT_depth20_3014.parquet
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>...
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>./hyperliquid/perp/trades/2024/12/BTC_3014.parquet
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>./hyperliquid/perp/trades/2024/12/SOL_3014.parquet
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>./hyperliquid/perp/l2book/2024/12/BTC_depth20_3014.parquet
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>./hyperliquid/perp/l2book/2024/12/SOL_depth20_3014.parquet
</code></pre></div>
The archives can be loaded like this which loads sequential chronological, archived data from Dec-30th to Dec-31st of 2024:
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">lob</span> <span class="o">=</span> <span class="n">Feed</span><span class="o">.</span><span class="n">load_lob_archives</span><span class="p">(</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>    <span class="n">exc</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;BTCUSDT&#39;</span><span class="p">,</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    <span class="n">depth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2024-12-30:00&#39;</span><span class="p">,</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2024-12-31:23&#39;</span><span class="p">,</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="p">)</span>
</code></pre></div>
with format:
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="p">[</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    <span class="p">{</span><span class="s1">&#39;ts&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">},</span> <span class="p">{</span><span class="o">...</span><span class="p">},</span> <span class="o">...</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="p">]</span>
</code></pre></div>
and similarly:
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">trades</span> <span class="o">=</span> <span class="n">Feed</span><span class="o">.</span><span class="n">load_trade_archives</span><span class="p">(</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    <span class="n">exc</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;BTCUSDT&#39;</span><span class="p">,</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2024-12-30:00&#39;</span><span class="p">,</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>    <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2024-12-31:23&#39;</span><span class="p">,</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="p">)</span>
</code></pre></div>
to give
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>[
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    [ts,price,size,dir],
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>    [ts,price,size,dir],
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    ...
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>]
</code></pre></div>
We can also decide to run our own scheduler, if we don't want to run the hourly-archiver. With <code>archiver=True</code> and no scheduler -
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">feed</span> <span class="o">=</span> <span class="n">Feed</span><span class="p">(</span><span class="n">gateway</span><span class="o">=</span><span class="n">gateway</span><span class="p">,</span><span class="n">archiver</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="c1"># await feed.run_archive_scheduler() </span>
</code></pre></div>
we simply need to call 
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">feed</span><span class="o">.</span><span class="n">flush_archives</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;./data_archives/&#39;</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">postfix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</code></pre></div>
at any point in our code and the existing buffer is emptied into a parquet file with location:
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>{path}/{exchange}/{feed_cls}/{feed_type}/{prefix}{ticker}{_metadata}{postfix}.parquet
</code></pre></div>
For example the above call would save existing buffer to
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>.data_archives/hyperliquid/perp/trades/SOL.parquet
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>.data_archives/hyperliquid/perp/trades/BTC.parquet
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>.data_archives/hyperliquid/perp/l2book/BTC_depth20.parquet
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>.data_archives/hyperliquid/perp/l2book/SOL_depth20.parquet
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>#same for binance
</code></pre></div>
and this can be loaded:
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">lobs</span> <span class="o">=</span> <span class="n">Feed</span><span class="o">.</span><span class="n">load_lob_archive</span><span class="p">(</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>    <span class="n">exc</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>    <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;BTCUSDT&#39;</span><span class="p">,</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>    <span class="n">depth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./data_archives/&#39;</span><span class="p">,</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>    <span class="c1"># raw=True</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="p">)</span>
</code></pre></div>
or as raw parquet with columns (ts,bp,bs,ap,as) timestamp, bid price, bid size, ask price, ask size.
Same goes with trades
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">trades</span> <span class="o">=</span> <span class="n">Feed</span><span class="o">.</span><span class="n">load_trade_archive</span><span class="p">(</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>    <span class="n">exc</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>    <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;BTCUSDT&#39;</span><span class="p">,</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>    <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./data_archives/&#39;</span><span class="p">,</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>    <span class="c1"># raw=True</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="p">)</span>
</code></pre></div>
and raw parquet:
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>                ts    price   size  dir
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>0    1735569691383  92514.9  0.517    1
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>1    1735569691480  92514.8  0.051   -1
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>2    1735569691539  92514.9  0.051    1
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>...
</code></pre></div></p>
<h3 id="oms">OMS</h3>
<p>It is easy to create a manager class - it is similar to the<a href="../feed/"><code>quantpylib.hft.feed.Feed</code></a> objects. Simply - create a gateway object with the correct keys and pass them in.</p>
<p>We will demonstrate with examples:
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span> 
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> 
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span> 
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="n">load_dotenv</span><span class="p">()</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.oms</span><span class="w"> </span><span class="kn">import</span> <span class="n">OMS</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.gateway.master</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gateway</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">quantpylib.standards.markets</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">markets</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="n">config_keys</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>    <span class="s1">&#39;binance&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>        <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;1234&#39;</span><span class="p">,</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>        <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="s1">&#39;1234&#39;</span><span class="p">,</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>    <span class="p">},</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>    <span class="s1">&#39;hyperliquid&#39;</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>        <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;1234&#39;</span><span class="p">,</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>        <span class="s1">&#39;secret&#39;</span><span class="p">:</span> <span class="s1">&#39;1234&#39;</span><span class="p">,</span>
<a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>    <span class="p">}</span>
<a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="p">}</span>
<a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="n">gateway</span> <span class="o">=</span> <span class="n">Gateway</span><span class="p">(</span><span class="n">config_keys</span><span class="p">)</span>
<a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a>
<a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>    <span class="k">await</span> <span class="n">gateway</span><span class="o">.</span><span class="n">init_clients</span><span class="p">()</span>
<a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>    <span class="n">oms</span> <span class="o">=</span> <span class="n">OMS</span><span class="p">(</span><span class="n">gateway</span><span class="p">)</span>
<a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>    <span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>    <span class="c1">#code goes here... </span>
<a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>    <span class="c1">###</span>
<a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>    <span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
<a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a>
<a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div></p>
<p>For all of our socket-based message handlers, we will use a generic printer to showcase results:
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">printer</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>        <span class="n">pprint</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>        <span class="k">try</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>        <span class="k">except</span><span class="p">:</span> <span class="n">pprint</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">as_list</span><span class="p">())</span>
</code></pre></div>
Now, let us take a look at the functionalities. We can get trading specifications for the contracts on initiated exchanges:
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">pprint</span><span class="p">(</span><span class="n">oms</span><span class="o">.</span><span class="n">contract_specs</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">))</span>
</code></pre></div>
we get
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>{&#39;base_asset&#39;: &#39;BTC&#39;,
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>&#39;min_notional&#39;: Decimal(&#39;10.0&#39;),
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>&#39;price_precision&#39;: 1,
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>&#39;quantity_precision&#39;: 5,
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>&#39;quote_asset&#39;: &#39;USDT&#39;}
</code></pre></div>
Some useful statistics and utilities:
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">pprint</span><span class="p">(</span><span class="n">oms</span><span class="o">.</span><span class="n">lagged_price</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;ETH&#39;</span><span class="p">))</span> <span class="c1">#Decimal(&#39;2368.25&#39;)</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="n">pprint</span><span class="p">(</span><span class="n">oms</span><span class="o">.</span><span class="n">lot_precision</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">))</span> <span class="c1">#5</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="n">pprint</span><span class="p">(</span><span class="n">oms</span><span class="o">.</span><span class="n">price_precision</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;DOGE&#39;</span><span class="p">))</span> <span class="c1">#6</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="n">pprint</span><span class="p">(</span><span class="n">oms</span><span class="o">.</span><span class="n">rounded_lots</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span><span class="n">amount</span><span class="o">=</span><span class="mf">0.0023032</span><span class="p">))</span> <span class="c1">#0.0023</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="n">pprint</span><span class="p">(</span><span class="n">oms</span><span class="o">.</span><span class="n">rounded_price</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span><span class="n">price</span><span class="o">=</span><span class="mf">62000.1234</span><span class="p">))</span> <span class="c1">#62000.1</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="n">pprint</span><span class="p">(</span><span class="n">oms</span><span class="o">.</span><span class="n">min_notional</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">))</span> <span class="c1">#Decimal(&#39;10.0&#39;)</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="n">pprint</span><span class="p">(</span><span class="n">oms</span><span class="o">.</span><span class="n">rand_cloid</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">))</span> <span class="c1">#&#39;b486130e1b35986abc803bb79d2e675d&#39;</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="n">pprint</span><span class="p">(</span><span class="n">oms</span><span class="o">.</span><span class="n">common_lot_precision</span><span class="p">(</span><span class="n">ex1</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span><span class="n">ex2</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span><span class="n">ticker1</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span><span class="n">ticker2</span><span class="o">=</span><span class="s1">&#39;BTCUSDT&#39;</span><span class="p">))</span> <span class="c1">#3</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="n">pprint</span><span class="p">(</span><span class="n">oms</span><span class="o">.</span><span class="n">common_price_precision</span><span class="p">(</span><span class="n">ex1</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span><span class="n">ex2</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span><span class="n">ticker1</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span><span class="n">ticker2</span><span class="o">=</span><span class="s1">&#39;BTCUSDT&#39;</span><span class="p">))</span> <span class="c1">#1</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="n">pprint</span><span class="p">(</span><span class="n">oms</span><span class="o">.</span><span class="n">common_min_notional</span><span class="p">(</span><span class="n">ex1</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span><span class="n">ex2</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span><span class="n">ticker1</span><span class="o">=</span><span class="s1">&#39;BTC&#39;</span><span class="p">,</span><span class="n">ticker2</span><span class="o">=</span><span class="s1">&#39;BTCUSDT&#39;</span><span class="p">))</span> <span class="c1">#Decimal(&#39;100&#39;)</span>
</code></pre></div>
We can get account informations for the included exchanges:
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">pprint</span><span class="p">(</span><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">))</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="n">pprint</span><span class="p">(</span><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">get_all_balances</span><span class="p">())</span>
</code></pre></div></p>
<p>We would like to get some positions data. Note that when <code>oms.init()</code> is called, all orders and positions are automatically mirrored using underlying exchange socket subscriptions. We can make connection-less request by retrieving local state:
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">pprint</span><span class="p">(</span><span class="n">oms</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;SOL&#39;</span><span class="p">))</span> <span class="c1">#Decimal(&#39;1.0&#39;) (no requests made)</span>
</code></pre></div>
or we can force the OMS to make a HTTP request:
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="n">pprint</span><span class="p">(</span><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">positions_get</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">))</span> <span class="c1">#HTTP requests made</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">pprint</span><span class="p">(</span><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">positions_get_all</span><span class="p">())</span>
</code></pre></div>
which gives us outputs
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>{&#39;SOL&#39;: {&#39;amount&#39;: Decimal(&#39;1.0&#39;),
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>         &#39;entry&#39;: Decimal(&#39;134.81&#39;),
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>         &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>         &#39;unrealized_pnl&#39;: -0.3,
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>         &#39;value&#39;: Decimal(&#39;134.51&#39;)}}
</code></pre></div>
and
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>{&#39;binance&#39;: {&#39;QUANTUSDT&#39;: {&#39;amount&#39;: Decimal(&#39;826&#39;),
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>                         &#39;entry&#39;: Decimal(&#39;0.1250522412206&#39;),
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>                         &#39;ticker&#39;: &#39;QUANTUSDT&#39;,
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>                         &#39;unrealized_pnl&#39;: 1.03231002,
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>                         &#39;value&#39;: Decimal(&#39;104.32546026&#39;)}},
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a> &#39;hyperliquid&#39;: {&#39;SOL&#39;: {&#39;amount&#39;: Decimal(&#39;1.0&#39;),
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>                         &#39;entry&#39;: Decimal(&#39;134.81&#39;),
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>                         &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>                         &#39;unrealized_pnl&#39;: -0.3,
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>                         &#39;value&#39;: Decimal(&#39;134.51&#39;)}}}
</code></pre></div>
respectively. Only one of each schema level is shown - obviously if more positions were held, more entries would be seen.</p>
<p>If we want to get the live positions object that tracks all positions, or register a handler on position change, we may do so. In particular, we can register handler <code>on_update</code> which passes the entire positions page (and/or) <code>on_delta</code> which passes the change in positions. Furthermore, the return value is the <code>Positions</code> object which is 'alive', so to speak, and keeps up to date with filled orders.
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">live_positions</span> <span class="o">=</span> <span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">positions_mirror</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span><span class="n">on_update</span><span class="o">=</span><span class="n">printer</span><span class="p">,</span><span class="n">on_delta</span><span class="o">=</span><span class="n">printer</span><span class="p">)</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="nb">print</span><span class="p">(</span><span class="n">live_positions</span><span class="p">)</span><span class="c1">#&lt;quantpylib.standards.portfolio.Positions object at 0x12a98c8f0&gt;</span>
</code></pre></div></p>
<p>We may do the same with orders:
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">pprint</span><span class="p">(</span><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">orders_get</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">))</span> <span class="c1">#HTTP</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="n">pprint</span><span class="p">(</span><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">orders_get_all</span><span class="p">())</span>
</code></pre></div>
for output:
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>{1234: {
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>        &#39;amount&#39;: Decimal(&#39;1.0&#39;),
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>        &#39;cloid&#39;: &#39;&#39;,
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>        &#39;filled_sz&#39;: Decimal(&#39;0.0&#39;),
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>        &#39;oid&#39;: &#39;1234&#39;,
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>        &#39;ord_status&#39;: &#39;NEW&#39;,
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>        &#39;price&#39;: Decimal(&#39;100.0&#39;),
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>        &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>        &#39;timestamp&#39;: 1726113126684
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>        }
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>}
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a>{&#39;hyperliquid&#39;: {1234: {&#39;amount&#39;: Decimal(&#39;1.0&#39;),
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>                        &#39;cloid&#39;: &#39;&#39;,
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>                        &#39;filled_sz&#39;: Decimal(&#39;0.0&#39;),
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a>                        &#39;oid&#39;: &#39;1234&#39;,
<a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a>                        &#39;ord_status&#39;: &#39;NEW&#39;,
<a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a>                        &#39;price&#39;: Decimal(&#39;100.0&#39;),
<a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a>                        &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a>                        &#39;timestamp&#39;: 1726113126684}}}
<a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a>&#39;binance&#39;: .... {}
</code></pre></div>
Or...register handlers for orders page snapshot (and/or) just the changes. This also returns us a live <code>Orders</code> object:
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">live_orders</span> <span class="o">=</span> <span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">orders_mirror</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span><span class="n">on_update</span><span class="o">=</span><span class="n">printer</span><span class="p">,</span><span class="n">on_delta</span><span class="o">=</span><span class="n">printer</span><span class="p">)</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="nb">print</span><span class="p">(</span><span class="n">live_orders</span><span class="p">)</span><span class="c1">#&lt;quantpylib.standards.portfolio.Orders object at 0x13252f050&gt;</span>
</code></pre></div></p>
<p>Now that we have registered some handlers for orders, and what not - let us see what the messages look like. We can make a limit order through the OMS - the parameters are the same as in <code>Gateway</code> usage:
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">cloid</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">rand_cloid</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">)</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">limit_order</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span><span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;SOL&#39;</span><span class="p">,</span><span class="n">amount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">price</span><span class="o">=</span><span class="mf">129.56</span><span class="p">,</span><span class="n">cloid</span><span class="o">=</span><span class="n">cloid</span><span class="p">)</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">limit_order</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span><span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;SOLUSDT&#39;</span><span class="p">,</span><span class="n">price_match</span><span class="o">=</span><span class="n">markets</span><span class="o">.</span><span class="n">PRICE_MATCH_QUEUE_1</span><span class="p">,</span><span class="n">amount</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
Recall that our handlers are registered for <code>hyperliquid</code>, so let's see what gets printed:
The <code>on_delta</code> handler receives two messages:
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>{&#39;amount&#39;: Decimal(&#39;1&#39;),
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a> &#39;cloid&#39;: &#39;0x272e45bf06706c3259f41079a1d48d2a&#39;,
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a> &#39;exc&#39;: &#39;hyperliquid&#39;,
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a> &#39;filled_sz&#39;: Decimal(&#39;0&#39;),
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a> &#39;last_fill_sz&#39;: Decimal(&#39;0&#39;),
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a> &#39;oid&#39;: None,
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a> &#39;ord_status&#39;: &#39;PENDING&#39;,
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a> &#39;ord_type&#39;: None,
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a> &#39;price&#39;: Decimal(&#39;129.56&#39;),
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a> &#39;price_match&#39;: None,
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a> &#39;reduce_only&#39;: None,
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a> &#39;sl&#39;: None,
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a> &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a> &#39;tif&#39;: None,
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a> &#39;timestamp&#39;: 1726154778980,
<a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a> &#39;tp&#39;: None}
<a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a>{&#39;amount&#39;: Decimal(&#39;1.0&#39;),
<a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a> &#39;cloid&#39;: &#39;0x272e45bf06706c3259f41079a1d48d2a&#39;,
<a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a> &#39;exc&#39;: &#39;hyperliquid&#39;,
<a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a> &#39;filled_sz&#39;: Decimal(&#39;0.0&#39;),
<a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a> &#39;last_fill_sz&#39;: Decimal(&#39;0.0&#39;),
<a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a> &#39;oid&#39;: &#39;1234&#39;,
<a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a> &#39;ord_status&#39;: &#39;NEW&#39;,
<a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a> &#39;ord_type&#39;: None,
<a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a> &#39;price&#39;: Decimal(&#39;129.56&#39;),
<a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a> &#39;price_match&#39;: None,
<a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a> &#39;reduce_only&#39;: None,
<a id="__codelineno-40-28" name="__codelineno-40-28" href="#__codelineno-40-28"></a> &#39;sl&#39;: None,
<a id="__codelineno-40-29" name="__codelineno-40-29" href="#__codelineno-40-29"></a> &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-40-30" name="__codelineno-40-30" href="#__codelineno-40-30"></a> &#39;tif&#39;: None,
<a id="__codelineno-40-31" name="__codelineno-40-31" href="#__codelineno-40-31"></a> &#39;timestamp&#39;: 1726154781307,
<a id="__codelineno-40-32" name="__codelineno-40-32" href="#__codelineno-40-32"></a> &#39;tp&#39;: None}
</code></pre></div>
The first is order-creation: a request has been sent to the exchange, but not yet acknowledged. Only the local trading agent is aware, but the order is possibly unsuccessful; hence <code>PENDING</code> status. This is followed by a <code>NEW</code> order which means the order was acknowledged successful by the exchange. The <code>on_update</code> handler sends this order, along with all the other open orders - which we print as a list:
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>[{&#39;amount&#39;: Decimal(&#39;1.0&#39;),
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>  ...
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>  &#39;timestamp&#39;: 1726123317580,
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>  &#39;tp&#39;: None},
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a> {&#39;amount&#39;: Decimal(&#39;1.0&#39;),
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>  &#39;cloid&#39;: &#39;0x272e45bf06706c3259f41079a1d48d2a&#39;,
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>  &#39;exc&#39;: &#39;hyperliquid&#39;,
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>  &#39;filled_sz&#39;: Decimal(&#39;0.0&#39;),
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a>  &#39;last_fill_sz&#39;: Decimal(&#39;0.0&#39;),
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a>  &#39;oid&#39;: &#39;1234&#39;,
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a>  &#39;ord_status&#39;: &#39;NEW&#39;,
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a>  &#39;ord_type&#39;: None,
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a>  &#39;price&#39;: Decimal(&#39;129.56&#39;),
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a>  &#39;price_match&#39;: None,
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a>  &#39;reduce_only&#39;: None,
<a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a>  &#39;sl&#39;: None,
<a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a>  &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a>  &#39;tif&#39;: None,
<a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a>  &#39;timestamp&#39;: 1726154781307,
<a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a>  &#39;tp&#39;: None}]
</code></pre></div>
Next we submit an order cancel:
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">cancel_order</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span><span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;SOL&#39;</span><span class="p">,</span><span class="n">cloid</span><span class="o">=</span><span class="n">cloid</span><span class="p">)</span> <span class="c1">#or use oid</span>
</code></pre></div>
and this is acknowledged <code>on_delta</code>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>{&#39;amount&#39;: Decimal(&#39;1.0&#39;),
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a> &#39;cloid&#39;: &#39;0x272e45bf06706c3259f41079a1d48d2a&#39;,
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a> &#39;exc&#39;: &#39;hyperliquid&#39;,
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a> &#39;filled_sz&#39;: Decimal(&#39;0.0&#39;),
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a> &#39;last_fill_sz&#39;: Decimal(&#39;0.0&#39;),
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a> &#39;oid&#39;: &#39;1234&#39;,
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a> &#39;ord_status&#39;: &#39;CANCELLED&#39;,
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a> &#39;ord_type&#39;: None,
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a> &#39;price&#39;: Decimal(&#39;129.56&#39;),
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a> &#39;price_match&#39;: None,
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a> &#39;reduce_only&#39;: None,
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a> &#39;sl&#39;: None,
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a> &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a> &#39;tif&#39;: None,
<a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a> &#39;timestamp&#39;: 1726154781307,
<a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a> &#39;tp&#39;: None}
</code></pre></div>
and the <code>on_update</code> prints the new list (not shown), this time without the cancelled order - since it is not on the orders page anymore (it is no longer open).</p>
<p>We can of course, do a market-order:
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">market_order</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span><span class="p">,</span><span class="n">ticker</span><span class="o">=</span><span class="s1">&#39;SOL&#39;</span><span class="p">,</span><span class="n">amount</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
Which also gives a <code>on_delta</code>, <code>PENDING</code> message:
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>{&#39;amount&#39;: Decimal(&#39;-1&#39;),
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a> &#39;cloid&#39;: &#39;0xa70c993f525b2e8106ffd60fd19af35e&#39;,
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a> &#39;exc&#39;: &#39;hyperliquid&#39;,
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a> &#39;filled_sz&#39;: Decimal(&#39;0&#39;),
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a> &#39;last_fill_sz&#39;: Decimal(&#39;0&#39;),
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a> &#39;oid&#39;: None,
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a> &#39;ord_status&#39;: &#39;PENDING&#39;,
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a> &#39;ord_type&#39;: None,
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a> &#39;price&#39;: None,
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a> &#39;price_match&#39;: None,
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a> &#39;reduce_only&#39;: None,
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a> &#39;sl&#39;: None,
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a> &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a> &#39;tif&#39;: None,
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a> &#39;timestamp&#39;: 1726154778980,
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a> &#39;tp&#39;: None}
</code></pre></div>
This is filled immediately in two blocks, and the <code>positions</code>'s <code>on_delta</code> message is called with each fill
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>{&#39;amount&#39;: Decimal(&#39;0.19&#39;),
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a> &#39;delta&#39;: Decimal(&#39;-0.81&#39;),
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a> &#39;entry&#39;: Decimal(&#39;134.81&#39;),
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a> &#39;ticker&#39;: &#39;SOL&#39;}
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>{&#39;amount&#39;: Decimal(&#39;0.00&#39;),
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a> &#39;delta&#39;: Decimal(&#39;-0.19&#39;),
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a> &#39;entry&#39;: Decimal(&#39;134.79&#39;),
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a> &#39;ticker&#39;: &#39;SOL&#39;}
</code></pre></div>
where <code>amount</code> is the new signed position held after <code>delta</code> is filled - at the end of this market order our <code>SOL</code> position is closed fully, so our <code>positions</code>'s <code>on_update</code> receives the positions page (no open positions):
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>{}
</code></pre></div>
on the other hand the <code>PENDING</code> order created is acknowledged by exchange to <code>NEW</code> and then immediately <code>FILLED</code> on creation with <code>on_delta</code> triggers:
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>{&#39;amount&#39;: Decimal(&#39;-1.0&#39;),
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a> &#39;cloid&#39;: &#39;0xa70c993f525b2e8106ffd60fd19af35e&#39;,
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a> &#39;exc&#39;: &#39;hyperliquid&#39;,
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a> &#39;filled_sz&#39;: Decimal(&#39;0.0&#39;),
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a> &#39;last_fill_sz&#39;: Decimal(&#39;0.0&#39;),
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a> &#39;oid&#39;: &#39;yomama&#39;,
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a> &#39;ord_status&#39;: &#39;NEW&#39;,
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a> &#39;ord_type&#39;: None,
<a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a> &#39;price&#39;: Decimal(&#39;127.69&#39;), #hyperliquid&#39;s market order is an aggressive limit order
<a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a> &#39;price_match&#39;: None,
<a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a> &#39;reduce_only&#39;: None,
<a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a> &#39;sl&#39;: None,
<a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a> &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a> &#39;tif&#39;: None,
<a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a> &#39;timestamp&#39;: 1726154797325,
<a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a> &#39;tp&#39;: None}
<a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a>{&#39;amount&#39;: Decimal(&#39;-1.0&#39;),
<a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a> &#39;cloid&#39;: &#39;0xa70c993f525b2e8106ffd60fd19af35e&#39;,
<a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a> &#39;exc&#39;: &#39;hyperliquid&#39;,
<a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a> &#39;filled_sz&#39;: Decimal(&#39;1.0&#39;),
<a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a> &#39;last_fill_sz&#39;: Decimal(&#39;1.0&#39;),
<a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a> &#39;oid&#39;: &#39;yomama&#39;,
<a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a> &#39;ord_status&#39;: &#39;FILLED&#39;,
<a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a> &#39;ord_type&#39;: None,
<a id="__codelineno-48-25" name="__codelineno-48-25" href="#__codelineno-48-25"></a> &#39;price&#39;: Decimal(&#39;127.69&#39;),
<a id="__codelineno-48-26" name="__codelineno-48-26" href="#__codelineno-48-26"></a> &#39;price_match&#39;: None,
<a id="__codelineno-48-27" name="__codelineno-48-27" href="#__codelineno-48-27"></a> &#39;reduce_only&#39;: None,
<a id="__codelineno-48-28" name="__codelineno-48-28" href="#__codelineno-48-28"></a> &#39;sl&#39;: None,
<a id="__codelineno-48-29" name="__codelineno-48-29" href="#__codelineno-48-29"></a> &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-48-30" name="__codelineno-48-30" href="#__codelineno-48-30"></a> &#39;tif&#39;: None,
<a id="__codelineno-48-31" name="__codelineno-48-31" href="#__codelineno-48-31"></a> &#39;timestamp&#39;: 1726154797325,
<a id="__codelineno-48-32" name="__codelineno-48-32" href="#__codelineno-48-32"></a> &#39;tp&#39;: None}
</code></pre></div>
and <code>on_update</code> triggers:
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>[{&#39;amount&#39;: Decimal(&#39;1.0&#39;),
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>  ...
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>  &#39;timestamp&#39;: 1726123317580,
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>  &#39;tp&#39;: None},]
</code></pre></div>
We will demonstrate a complex order supported by the OMS - let's call it <code>hedge_order</code>. It is quite often that we want one order to trigger another in a multi-leg trade. For instance, a triangular arbitrage, cross-exchange market making, funding arbitrage and l/s arbitrage all often use similar fixtures. A hedge order allows us to submit a maker-order, and the matching taker order is triggered with size matching that of the filled amount on the maker-leg. When lot size rounding doesn't allow for complete hedging, the remaining balance is stored and flushed with the next best available order. Let's see how we can make use of this. To get information from both exchanges, we wil add the binance handlers:
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">positions_mirror</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span><span class="n">on_update</span><span class="o">=</span><span class="n">printer</span><span class="p">,</span><span class="n">on_delta</span><span class="o">=</span><span class="n">printer</span><span class="p">)</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">orders_mirror</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="s1">&#39;binance&#39;</span><span class="p">,</span><span class="n">on_update</span><span class="o">=</span><span class="n">printer</span><span class="p">,</span><span class="n">on_delta</span><span class="o">=</span><span class="n">printer</span><span class="p">)</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>
and then make a hedge order
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="k">await</span> <span class="n">oms</span><span class="o">.</span><span class="n">hedge_order</span><span class="p">(</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>    <span class="n">maker_order</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>        <span class="s2">&quot;exc&quot;</span><span class="p">:</span> <span class="s2">&quot;binance&quot;</span><span class="p">,</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>        <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="s2">&quot;SOLUSDT&quot;</span><span class="p">,</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>        <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>        <span class="s2">&quot;price_match&quot;</span><span class="p">:</span> <span class="n">markets</span><span class="o">.</span><span class="n">PRICE_MATCH_QUEUE_5</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>    <span class="p">},</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>    <span class="n">hedge_order</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>        <span class="s2">&quot;exc&quot;</span><span class="p">:</span> <span class="s2">&quot;hyperliquid&quot;</span><span class="p">,</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>        <span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="s2">&quot;SOL&quot;</span><span class="p">,</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>    <span class="p">}</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="p">)</span>
</code></pre></div>
Note that an amount is not specified for the hedge-order - since we are listening for the filled sizes on binance.
First - a pending order is created on binance, then acknowledged
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>&gt;&gt; orders delta:
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>{&#39;amount&#39;: Decimal(&#39;-3&#39;),
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a> &#39;cloid&#39;: &#39;c484811d8ce145004eeb26c917013c29&#39;,
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a> &#39;exc&#39;: &#39;binance&#39;,
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a> &#39;filled_sz&#39;: Decimal(&#39;0&#39;),
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a> &#39;last_fill_sz&#39;: Decimal(&#39;0&#39;),
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a> &#39;oid&#39;: None,
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a> &#39;ord_status&#39;: &#39;PENDING&#39;,
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a> &#39;ord_type&#39;: None,
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a> &#39;price&#39;: None,
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a> &#39;price_match&#39;: &#39;QUEUE_5&#39;,
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a> &#39;reduce_only&#39;: None,
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a> &#39;sl&#39;: None,
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a> &#39;ticker&#39;: &#39;SOLUSDT&#39;,
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a> &#39;tif&#39;: None,
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a> &#39;timestamp&#39;: 1726199235551,
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a> &#39;tp&#39;: None}
<a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a>{&#39;amount&#39;: Decimal(&#39;-3&#39;),
<a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a> &#39;cloid&#39;: &#39;c484811d8ce145004eeb26c917013c29&#39;,
<a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a> &#39;exc&#39;: &#39;binance&#39;,
<a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a> &#39;filled_sz&#39;: Decimal(&#39;0&#39;),
<a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a> &#39;last_fill_sz&#39;: Decimal(&#39;0&#39;),
<a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a> &#39;oid&#39;: &#39;68254554715&#39;,
<a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a> &#39;ord_status&#39;: &#39;NEW&#39;,
<a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a> &#39;ord_type&#39;: &#39;LIMIT&#39;,
<a id="__codelineno-52-26" name="__codelineno-52-26" href="#__codelineno-52-26"></a> &#39;price&#39;: Decimal(&#39;134.5460&#39;),
<a id="__codelineno-52-27" name="__codelineno-52-27" href="#__codelineno-52-27"></a> &#39;price_match&#39;: &#39;QUEUE_5&#39;,
<a id="__codelineno-52-28" name="__codelineno-52-28" href="#__codelineno-52-28"></a> &#39;reduce_only&#39;: False,
<a id="__codelineno-52-29" name="__codelineno-52-29" href="#__codelineno-52-29"></a> &#39;sl&#39;: None,
<a id="__codelineno-52-30" name="__codelineno-52-30" href="#__codelineno-52-30"></a> &#39;ticker&#39;: &#39;SOLUSDT&#39;,
<a id="__codelineno-52-31" name="__codelineno-52-31" href="#__codelineno-52-31"></a> &#39;tif&#39;: &#39;GTC&#39;,
<a id="__codelineno-52-32" name="__codelineno-52-32" href="#__codelineno-52-32"></a> &#39;timestamp&#39;: 1726199241966,
<a id="__codelineno-52-33" name="__codelineno-52-33" href="#__codelineno-52-33"></a> &#39;tp&#39;: None}
<a id="__codelineno-52-34" name="__codelineno-52-34" href="#__codelineno-52-34"></a>&gt;&gt; orders snapshot:
<a id="__codelineno-52-35" name="__codelineno-52-35" href="#__codelineno-52-35"></a>[{&#39;amount&#39;: Decimal(&#39;-3&#39;),
<a id="__codelineno-52-36" name="__codelineno-52-36" href="#__codelineno-52-36"></a>  &#39;cloid&#39;: &#39;c484811d8ce145004eeb26c917013c29&#39;,
<a id="__codelineno-52-37" name="__codelineno-52-37" href="#__codelineno-52-37"></a>  &#39;exc&#39;: &#39;binance&#39;,
<a id="__codelineno-52-38" name="__codelineno-52-38" href="#__codelineno-52-38"></a>  &#39;filled_sz&#39;: Decimal(&#39;0&#39;),
<a id="__codelineno-52-39" name="__codelineno-52-39" href="#__codelineno-52-39"></a>  &#39;last_fill_sz&#39;: Decimal(&#39;0&#39;),
<a id="__codelineno-52-40" name="__codelineno-52-40" href="#__codelineno-52-40"></a>  &#39;oid&#39;: &#39;68254554715&#39;,
<a id="__codelineno-52-41" name="__codelineno-52-41" href="#__codelineno-52-41"></a>  &#39;ord_status&#39;: &#39;NEW&#39;,
<a id="__codelineno-52-42" name="__codelineno-52-42" href="#__codelineno-52-42"></a>  &#39;ord_type&#39;: &#39;LIMIT&#39;,
<a id="__codelineno-52-43" name="__codelineno-52-43" href="#__codelineno-52-43"></a>  &#39;price&#39;: Decimal(&#39;134.5460&#39;),
<a id="__codelineno-52-44" name="__codelineno-52-44" href="#__codelineno-52-44"></a>  &#39;price_match&#39;: &#39;QUEUE_5&#39;,
<a id="__codelineno-52-45" name="__codelineno-52-45" href="#__codelineno-52-45"></a>  &#39;reduce_only&#39;: False,
<a id="__codelineno-52-46" name="__codelineno-52-46" href="#__codelineno-52-46"></a>  &#39;sl&#39;: None,
<a id="__codelineno-52-47" name="__codelineno-52-47" href="#__codelineno-52-47"></a>  &#39;ticker&#39;: &#39;SOLUSDT&#39;,
<a id="__codelineno-52-48" name="__codelineno-52-48" href="#__codelineno-52-48"></a>  &#39;tif&#39;: &#39;GTC&#39;,
<a id="__codelineno-52-49" name="__codelineno-52-49" href="#__codelineno-52-49"></a>  &#39;timestamp&#39;: 1726199241966,
<a id="__codelineno-52-50" name="__codelineno-52-50" href="#__codelineno-52-50"></a>  &#39;tp&#39;: None}]
</code></pre></div>
It is later filled:
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>&gt;&gt; positions delta:
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>{&#39;amount&#39;: Decimal(&#39;-3&#39;),
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a> &#39;delta&#39;: Decimal(&#39;-3&#39;),
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a> &#39;entry&#39;: Decimal(&#39;134.546&#39;),
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a> &#39;ticker&#39;: &#39;SOLUSDT&#39;}
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>&gt;&gt; positions snapshot:
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>{&#39;SOLUSDT&#39;: {&#39;amount&#39;: Decimal(&#39;-3&#39;),
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>            &#39;entry&#39;: Decimal(&#39;134.546&#39;),
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>            &#39;ticker&#39;: &#39;SOLUSDT&#39;}}
</code></pre></div>
Which also shows up in the orders:
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>{&#39;amount&#39;: Decimal(&#39;-3&#39;),
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a> &#39;cloid&#39;: &#39;c484811d8ce145004eeb26c917013c29&#39;,
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a> &#39;exc&#39;: &#39;binance&#39;,
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a> &#39;filled_sz&#39;: Decimal(&#39;3&#39;),
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a> &#39;last_fill_sz&#39;: Decimal(&#39;3&#39;),
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a> &#39;oid&#39;: &#39;68254554715&#39;,
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a> &#39;ord_status&#39;: &#39;FILLED&#39;,
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a> &#39;ord_type&#39;: &#39;LIMIT&#39;,
<a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a> &#39;price&#39;: Decimal(&#39;134.5460&#39;),
<a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a> &#39;price_match&#39;: &#39;QUEUE_5&#39;,
<a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a> &#39;reduce_only&#39;: False,
<a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a> &#39;sl&#39;: None,
<a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a> &#39;ticker&#39;: &#39;SOLUSDT&#39;,
<a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a> &#39;tif&#39;: &#39;GTC&#39;,
<a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a> &#39;timestamp&#39;: 1726199256915,
<a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a> &#39;tp&#39;: None}
</code></pre></div>
This triggers a taker order on hyperliquid - which goes from <code>PENDING</code> to <code>NEW</code> to <code>FILLED</code>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>{&#39;amount&#39;: Decimal(&#39;3.0&#39;),
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a> &#39;cloid&#39;: &#39;0xb09f965b3b58613bce2b12f15a94ad47&#39;,
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a> &#39;exc&#39;: &#39;hyperliquid&#39;,
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a> &#39;filled_sz&#39;: Decimal(&#39;0&#39;),
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a> &#39;last_fill_sz&#39;: Decimal(&#39;0&#39;),
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a> &#39;oid&#39;: None,
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a> &#39;ord_status&#39;: &#39;PENDING&#39;,
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a> &#39;ord_type&#39;: None,
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a> &#39;price&#39;: None,
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a> &#39;price_match&#39;: None,
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a> &#39;reduce_only&#39;: None,
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a> &#39;sl&#39;: None,
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a> &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a> &#39;tif&#39;: None,
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a> &#39;timestamp&#39;: 1726199235551,
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a> &#39;tp&#39;: None}
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a> {&#39;amount&#39;: Decimal(&#39;3.0&#39;),
<a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a> &#39;cloid&#39;: &#39;0xb09f965b3b58613bce2b12f15a94ad47&#39;,
<a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a> &#39;exc&#39;: &#39;hyperliquid&#39;,
<a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a> &#39;filled_sz&#39;: Decimal(&#39;0.0&#39;),
<a id="__codelineno-55-21" name="__codelineno-55-21" href="#__codelineno-55-21"></a> &#39;last_fill_sz&#39;: Decimal(&#39;0.0&#39;),
<a id="__codelineno-55-22" name="__codelineno-55-22" href="#__codelineno-55-22"></a> &#39;oid&#39;: &#39;37771235449&#39;,
<a id="__codelineno-55-23" name="__codelineno-55-23" href="#__codelineno-55-23"></a> &#39;ord_status&#39;: &#39;NEW&#39;,
<a id="__codelineno-55-24" name="__codelineno-55-24" href="#__codelineno-55-24"></a> &#39;ord_type&#39;: None,
<a id="__codelineno-55-25" name="__codelineno-55-25" href="#__codelineno-55-25"></a> &#39;price&#39;: Decimal(&#39;141.36&#39;),
<a id="__codelineno-55-26" name="__codelineno-55-26" href="#__codelineno-55-26"></a> &#39;price_match&#39;: None,
<a id="__codelineno-55-27" name="__codelineno-55-27" href="#__codelineno-55-27"></a> &#39;reduce_only&#39;: None,
<a id="__codelineno-55-28" name="__codelineno-55-28" href="#__codelineno-55-28"></a> &#39;sl&#39;: None,
<a id="__codelineno-55-29" name="__codelineno-55-29" href="#__codelineno-55-29"></a> &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-55-30" name="__codelineno-55-30" href="#__codelineno-55-30"></a> &#39;tif&#39;: None,
<a id="__codelineno-55-31" name="__codelineno-55-31" href="#__codelineno-55-31"></a> &#39;timestamp&#39;: 1726199257706,
<a id="__codelineno-55-32" name="__codelineno-55-32" href="#__codelineno-55-32"></a> &#39;tp&#39;: None}
<a id="__codelineno-55-33" name="__codelineno-55-33" href="#__codelineno-55-33"></a>{&#39;amount&#39;: Decimal(&#39;3.0&#39;),
<a id="__codelineno-55-34" name="__codelineno-55-34" href="#__codelineno-55-34"></a> &#39;cloid&#39;: &#39;0xb09f965b3b58613bce2b12f15a94ad47&#39;,
<a id="__codelineno-55-35" name="__codelineno-55-35" href="#__codelineno-55-35"></a> &#39;exc&#39;: &#39;hyperliquid&#39;,
<a id="__codelineno-55-36" name="__codelineno-55-36" href="#__codelineno-55-36"></a> &#39;filled_sz&#39;: Decimal(&#39;3.0&#39;),
<a id="__codelineno-55-37" name="__codelineno-55-37" href="#__codelineno-55-37"></a> &#39;last_fill_sz&#39;: Decimal(&#39;3.0&#39;),
<a id="__codelineno-55-38" name="__codelineno-55-38" href="#__codelineno-55-38"></a> &#39;oid&#39;: &#39;37771235449&#39;,
<a id="__codelineno-55-39" name="__codelineno-55-39" href="#__codelineno-55-39"></a> &#39;ord_status&#39;: &#39;FILLED&#39;,
<a id="__codelineno-55-40" name="__codelineno-55-40" href="#__codelineno-55-40"></a> &#39;ord_type&#39;: None,
<a id="__codelineno-55-41" name="__codelineno-55-41" href="#__codelineno-55-41"></a> &#39;price&#39;: Decimal(&#39;141.36&#39;),
<a id="__codelineno-55-42" name="__codelineno-55-42" href="#__codelineno-55-42"></a> &#39;price_match&#39;: None,
<a id="__codelineno-55-43" name="__codelineno-55-43" href="#__codelineno-55-43"></a> &#39;reduce_only&#39;: None,
<a id="__codelineno-55-44" name="__codelineno-55-44" href="#__codelineno-55-44"></a> &#39;sl&#39;: None,
<a id="__codelineno-55-45" name="__codelineno-55-45" href="#__codelineno-55-45"></a> &#39;ticker&#39;: &#39;SOL&#39;,
<a id="__codelineno-55-46" name="__codelineno-55-46" href="#__codelineno-55-46"></a> &#39;tif&#39;: None,
<a id="__codelineno-55-47" name="__codelineno-55-47" href="#__codelineno-55-47"></a> &#39;timestamp&#39;: 1726199257706,
<a id="__codelineno-55-48" name="__codelineno-55-48" href="#__codelineno-55-48"></a> &#39;tp&#39;: None}
</code></pre></div>
We also get the positions delta and snapshots on hyperliquid:
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>{&#39;amount&#39;: Decimal(&#39;3.0&#39;),
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a> &#39;delta&#39;: Decimal(&#39;3.0&#39;),
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a> &#39;entry&#39;: Decimal(&#39;134.65&#39;),
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a> &#39;ticker&#39;: &#39;SOL&#39;}
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>{&#39;SOL&#39;: {&#39;amount&#39;: Decimal(&#39;3.0&#39;), &#39;entry&#39;: Decimal(&#39;134.65&#39;), &#39;ticker&#39;: &#39;SOL&#39;}}
</code></pre></div>
Note that the orders are sent even if it is a partial-fill with matching size - we don't have to wait for the entire maker order to be complete.</p>
<h3 id="market-making">Market-Making</h3>
<p>Please refer to the <a href="../../scripts/market_making">market-making tutorial</a> using the <code>Feed</code> and <code>OMS</code> object to write cross-exchange, cross environment (live, backtest and modelling) code for high-frequency data.</p>
<!-- ### Modelling
Instead of judging the trading problem by terminal wealth, which is certainly affected by a large number of factors - we may be interested in modelling subproblems in market microstructure. Here the `quantpylib.hft.alpha.Model` is of help - which also extends the `Simulator` class as did the `Alpha` backtester. Hence the same logic applies to `compute_*_features` methods - they are pre-processing logic. Here the `Model` class only take in the orderbook and trades data without cash, fees et cetera.

#### VAMP-Demo
For instance, we may interested in a fair price estimator that deviates from the mid price using orderbook features. One example is that of the Volume-Adjusted Mid Price estimator, brought up in this [paper](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4351947) on short-term crypto price prediction. 

Here is the definition (with some improvements to notation):

![alt text](../archives/vamp_def.png)

It is purported that the VAMP is a better estimate for short-term price prediction, as opposed to the mid-price itself. Let's use the same dataset (here, the sample size is about 6000 for 1hour of orderbook data, reduced to conform to Github LFS restrictions; we encourage you to use your own data archives. The conclusions, however, are fairly typical.)

Here is the data-loading and imports:
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.utilities.general</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_pickle</span> 
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="p">(</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a>    <span class="n">ob_timestamps</span><span class="p">,</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>    <span class="n">bids</span><span class="p">,</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>    <span class="n">asks</span><span class="p">,</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>    <span class="n">mids</span><span class="p">,</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a>    <span class="n">trades</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="p">)</span> <span class="o">=</span> <span class="n">load_pickle</span><span class="p">(</span><span class="s2">&quot;hft_data&quot;</span><span class="p">)</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span>
<a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.alpha</span><span class="w"> </span><span class="kn">import</span> <span class="n">EVENT_CLOCK</span><span class="p">,</span> <span class="n">EVENT_LOB</span><span class="p">,</span> <span class="n">EVENT_TRADE</span>
<a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.alpha</span><span class="w"> </span><span class="kn">import</span> <span class="n">Model</span>
<a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.features</span><span class="w"> </span><span class="kn">import</span> <span class="n">vamp</span>
</code></pre></div>
This time, we would like to extend the `Model` class:
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">VAMP</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>    <span class="c1">#def compute_clock_features ...</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>    <span class="c1">#def compute_lob_features ...</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>    <span class="c1">#def compute_trade_features ...</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">event_estimator</span><span class="p">(</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>        <span class="bp">self</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span><span class="n">event_type</span><span class="p">,</span><span class="n">event_id</span><span class="p">,</span><span class="n">type_id</span><span class="p">,</span>
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>        <span class="n">trade_buffer</span><span class="p">,</span><span class="n">ob_timestamps</span><span class="p">,</span><span class="n">ob_bids</span><span class="p">,</span><span class="n">ob_asks</span><span class="p">,</span><span class="n">ob_mids</span><span class="p">,</span><span class="n">features</span><span class="p">,</span>
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>        <span class="n">running_event_ids</span><span class="p">,</span><span class="n">running_type_ids</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a>    <span class="p">):</span>
<a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a>        <span class="k">pass</span>        
</code></pre></div>
Here, instead of pre-processing the order book VAMP features, we will just compute it on the fly. Let us compare four different estimators, mid, and VAMP for notional value at 200, 1000 and 3000 - here the dataset is actually from a 'thinner' book taken from Hyperliquid's spot pair `PURR/USDC`. The notional value should be adjusted w.r.t to the actual exchange volume - a VAMP of 1000 for `BTCUSDT` on Binance would likely just be the mid price itself, since only the bba is involved.

We are going to use `vamp` from `quantpylib.hft.features` - the implementation is rather simple:
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">volume_weighted_price</span><span class="p">(</span><span class="n">ob_levels</span><span class="p">,</span> <span class="n">notional</span><span class="p">):</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>    <span class="n">cumvol</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>    <span class="n">wsum</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>    <span class="k">for</span> <span class="n">price</span><span class="p">,</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">ob_levels</span><span class="p">:</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>        <span class="k">if</span> <span class="n">cumvol</span> <span class="o">+</span> <span class="n">volume</span> <span class="o">&gt;=</span> <span class="n">notional</span><span class="p">:</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>            <span class="n">volume</span> <span class="o">=</span> <span class="n">notional</span> <span class="o">-</span> <span class="n">cumvol</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>        <span class="n">wsum</span> <span class="o">+=</span> <span class="n">price</span> <span class="o">*</span> <span class="n">volume</span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a>        <span class="n">cumvol</span> <span class="o">+=</span> <span class="n">volume</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a>        <span class="k">if</span> <span class="n">cumvol</span> <span class="o">&gt;=</span> <span class="n">notional</span><span class="p">:</span>
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a>            <span class="k">break</span>
<a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a>    <span class="k">return</span> <span class="n">wsum</span> <span class="o">/</span> <span class="n">notional</span>
<a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a>
<a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="k">def</span><span class="w"> </span><span class="nf">vamp</span><span class="p">(</span><span class="n">bids</span><span class="p">,</span> <span class="n">asks</span><span class="p">,</span> <span class="n">notional</span><span class="p">):</span>
<a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a>    <span class="n">P_b</span> <span class="o">=</span> <span class="n">volume_weighted_price</span><span class="p">(</span><span class="n">bids</span><span class="p">,</span> <span class="n">notional</span><span class="p">)</span>
<a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a>    <span class="n">P_a</span> <span class="o">=</span> <span class="n">volume_weighted_price</span><span class="p">(</span><span class="n">asks</span><span class="p">,</span> <span class="n">notional</span><span class="p">)</span>
<a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">P_b</span> <span class="o">+</span> <span class="n">P_a</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</code></pre></div>
Our `event_estimator` should just return a dictionary of valid estimates. We are only making estimates on order book events.
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">event_estimator</span><span class="p">(</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>        <span class="bp">self</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span><span class="n">event_type</span><span class="p">,</span><span class="n">event_id</span><span class="p">,</span><span class="n">type_id</span><span class="p">,</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>        <span class="n">trade_buffer</span><span class="p">,</span><span class="n">ob_timestamps</span><span class="p">,</span><span class="n">ob_bids</span><span class="p">,</span><span class="n">ob_asks</span><span class="p">,</span><span class="n">ob_mids</span><span class="p">,</span><span class="n">features</span><span class="p">,</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>        <span class="n">running_event_ids</span><span class="p">,</span><span class="n">running_type_ids</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a>    <span class="p">):</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>        <span class="n">estimates</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="n">EVENT_LOB</span><span class="p">:</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>            <span class="n">mid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>            <span class="n">estimates</span><span class="p">[</span><span class="s2">&quot;mid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mid</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a>            <span class="n">bids</span><span class="p">,</span><span class="n">asks</span> <span class="o">=</span> <span class="n">ob_bids</span><span class="p">[</span><span class="n">type_id</span><span class="p">],</span><span class="n">ob_asks</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a>            <span class="n">vamp200</span> <span class="o">=</span> <span class="n">vamp</span><span class="p">(</span><span class="n">bids</span><span class="p">,</span><span class="n">asks</span><span class="p">,</span><span class="n">notional</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a>            <span class="n">vamp1000</span> <span class="o">=</span> <span class="n">vamp</span><span class="p">(</span><span class="n">bids</span><span class="p">,</span><span class="n">asks</span><span class="p">,</span><span class="n">notional</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a>            <span class="n">vamp3000</span> <span class="o">=</span> <span class="n">vamp</span><span class="p">(</span><span class="n">bids</span><span class="p">,</span><span class="n">asks</span><span class="p">,</span><span class="n">notional</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a>            <span class="n">estimates</span><span class="p">[</span><span class="s1">&#39;vamp200&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vamp200</span>
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a>            <span class="n">estimates</span><span class="p">[</span><span class="s1">&#39;vamp1000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vamp1000</span>
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a>            <span class="n">estimates</span><span class="p">[</span><span class="s1">&#39;vamp3000&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vamp3000</span>
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a>        <span class="k">return</span> <span class="n">estimates</span>
</code></pre></div>
Running it is simple
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="n">alpha</span> <span class="o">=</span> <span class="n">VAMP</span><span class="p">(</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>    <span class="n">ob_timestamps</span><span class="o">=</span><span class="n">ob_timestamps</span><span class="p">,</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>    <span class="n">ob_bids</span><span class="o">=</span><span class="n">bids</span><span class="p">,</span>
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>    <span class="n">ob_asks</span><span class="o">=</span><span class="n">asks</span><span class="p">,</span>
<a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>    <span class="n">ob_mids</span><span class="o">=</span><span class="n">mids</span><span class="p">,</span>
<a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>    <span class="n">trade_buffer</span><span class="o">=</span><span class="n">trades</span><span class="p">,</span>
<a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="p">)</span>
<a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="n">alpha</span><span class="o">.</span><span class="n">run_estimator</span><span class="p">()</span>
</code></pre></div>
Since our case study involve statistical estimators, in particular fair price estimators, we can use `df_fairprice` to get some useful dataframes and plots.
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="n">pprint</span><span class="p">(</span><span class="n">alpha</span><span class="o">.</span><span class="n">df_fairprices</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</code></pre></div>
For example, we obtain plots of the difference `price_{t + x} - estimator_t` for different `x` intervals. We can see that at short distances:
![alt text](../archives/vamp_t1.png)

the `mid` estimator is best and thinnest in spread. That is, the `mid` price is probably a good estimator of the mid price in the next second. This is less clear, say thirty seconds out:
![alt text](../archives/vamp_t30.png)

In fact the `df_fairprices` method prints out some useful statistics:
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>({&#39;t1&#39;:
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>                  mid       vamp200      vamp1000      vamp3000
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>MSE     1.263283e-09  1.318690e-09  1.593077e-09  2.173601e-09
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>MAD     7.467348e-06  1.055727e-05  1.837794e-05  3.000805e-05
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>Q3      5.000000e-06  9.375000e-06  2.276000e-05  3.833000e-05
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>Q1      0.000000e+00  0.000000e+00  4.085000e-06  1.375750e-05
<a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>Median  0.000000e+00  3.150000e-06  1.047000e-05  2.525750e-05,
<a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>  &#39;t5&#39;:
<a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a>                    mid       vamp200      vamp1000      vamp3000
<a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>MSE     1.059491e-08  1.057470e-08  1.039111e-08  1.054808e-08
<a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a>MAD     3.701356e-05  3.820434e-05  4.156697e-05  4.989065e-05
<a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a>Q3      4.000000e-05  3.860000e-05  4.199625e-05  4.848083e-05
<a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a>Q1      0.000000e+00  2.925000e-06  6.315000e-06  1.808167e-05
<a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a>Median  1.000000e-05  1.062500e-05  1.850500e-05  3.192917e-05,
<a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a>  &#39;t15&#39;:
<a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a>                    mid       vamp200      vamp1000      vamp3000
<a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a>MSE     2.972277e-08  2.954644e-08  2.893512e-08  2.886935e-08
<a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a>MAD     8.059360e-05  8.102625e-05  8.183297e-05  8.628753e-05
<a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a>Q3      8.000000e-05  8.000000e-05  7.799500e-05  7.926542e-05
<a id="__codelineno-63-20" name="__codelineno-63-20" href="#__codelineno-63-20"></a>Q1      1.000000e-05  1.000000e-05  1.402500e-05  2.502417e-05
<a id="__codelineno-63-21" name="__codelineno-63-21" href="#__codelineno-63-21"></a>Median  3.500000e-05  3.562500e-05  3.755750e-05  4.391167e-05,
<a id="__codelineno-63-22" name="__codelineno-63-22" href="#__codelineno-63-22"></a>  &#39;t30&#39;:
<a id="__codelineno-63-23" name="__codelineno-63-23" href="#__codelineno-63-23"></a>                    mid       vamp200      vamp1000      vamp3000
<a id="__codelineno-63-24" name="__codelineno-63-24" href="#__codelineno-63-24"></a>MSE     5.757793e-08  5.727437e-08  5.650527e-08  5.595095e-08
<a id="__codelineno-63-25" name="__codelineno-63-25" href="#__codelineno-63-25"></a>MAD     1.264484e-04  1.272426e-04  1.283955e-04  1.310334e-04
<a id="__codelineno-63-26" name="__codelineno-63-26" href="#__codelineno-63-26"></a>Q3      1.200000e-04  1.200000e-04  1.175287e-04  1.153988e-04
<a id="__codelineno-63-27" name="__codelineno-63-27" href="#__codelineno-63-27"></a>Q1      2.000000e-05  2.000000e-05  2.407625e-05  3.529458e-05
<a id="__codelineno-63-28" name="__codelineno-63-28" href="#__codelineno-63-28"></a>Median  5.500000e-05  5.625000e-05  5.992500e-05  6.022833e-05,
<a id="__codelineno-63-29" name="__codelineno-63-29" href="#__codelineno-63-29"></a>  &#39;t60&#39;:
<a id="__codelineno-63-30" name="__codelineno-63-30" href="#__codelineno-63-30"></a>                    mid       vamp200      vamp1000      vamp3000
<a id="__codelineno-63-31" name="__codelineno-63-31" href="#__codelineno-63-31"></a>MSE     1.007904e-07  1.000718e-07  9.870321e-08  9.699616e-08
<a id="__codelineno-63-32" name="__codelineno-63-32" href="#__codelineno-63-32"></a>MAD     1.961512e-04  1.959267e-04  1.962974e-04  1.968203e-04
<a id="__codelineno-63-33" name="__codelineno-63-33" href="#__codelineno-63-33"></a>Q3      2.400000e-04  2.439063e-04  2.441700e-04  2.331175e-04
<a id="__codelineno-63-34" name="__codelineno-63-34" href="#__codelineno-63-34"></a>Q1      3.500000e-05  3.500000e-05  3.868875e-05  4.891542e-05
<a id="__codelineno-63-35" name="__codelineno-63-35" href="#__codelineno-63-35"></a>Median  1.050000e-04  1.050000e-04  1.085200e-04  1.075792e-04}, ...)
</code></pre></div>
One second out, the `mid` estimator has the lowest mean-squared error.
From five seconds out and further, the `vamp*` estimators have lower mean-squared errors due to orderbook imbalance being realized.

Another interesting feature that I have noticed reflected in this dataset and larger datasets, if not somewhat anecdotal, is that as the time interval increases, the notional value of the `vamp` estimator increases up to certain depths before worsening sharply. This is quite intuitive - longer term price movements take into account deeper structural imbalance; but as we traverse into deeper levels, we start picking up more noise and spoof orders. 

#### TI-Demo

Not all estimators are fair price estimators - in the same [paper](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4351947) - another feature studied was the trade imbalance (TI) estimator. It can be a feature in fair price estimation, but a mathematical model needs to be proposed to make fair price estimates from a TI estimate. The idea is simple;
short term lop-sided trading on the bid or ask side are likely to lead to further price moves in the same direction. Here is the definition from the paper:

![alt text](../archives/ti_alt_def.png)

A positive correlation is assumed between the trade imbalance and mid price changes, to reflect demand for the asset when there is trend of market bids. The gamma weight decay gives more weightage to recent trades.

However, this formula is unsatisfactory for a number of general purposes. First, if there is consensus that information decay exists; then there serves no specific reason as to why such decay should not be applied to higher resolutions within each aggregated interval. This may be a trivial concern for second intervals. A bigger issue is that the trade imbalance would be jumpy, or inestimable in the case of illiquid markets where trades occur at infrequent intervals. For example, one buy two minutes ago, and then one sell a minute later would give trade imbalance figures: -1,1 respectively. One may attend to this by widening the interval at which trades are aggregated - for which then the issue waved trivial earlier is no longer so. Imagine a aggregation interval of five minutes: a buy and sell order in the most recent interval 4.59m ago and another 0.01m ago contain significantly different amount of priced-in 'information' to market participants.

That there should be a decay is almost undisputed in finance. Nature of decay, and whether the decay should be w.r.t to trade arrivals in numbers, time distance or some other axis is philosophical. We propose a generalized estimator:

![alt text](../archives/ti_def.png)

The aformentioned TI formula would be a specific instance of this generalization, where `n = number of trades within x` seconds, and omega is a piecewise constant decay function.

Again, let's load the same dataset:
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.utilities.general</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_pickle</span> 
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="p">(</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>    <span class="n">ob_timestamps</span><span class="p">,</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>    <span class="n">bids</span><span class="p">,</span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>    <span class="n">asks</span><span class="p">,</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>    <span class="n">mids</span><span class="p">,</span>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>    <span class="n">trades</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="p">)</span> <span class="o">=</span> <span class="n">load_pickle</span><span class="p">(</span><span class="s2">&quot;hft_data&quot;</span><span class="p">)</span>
<a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>
<a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span>
<a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.alpha</span><span class="w"> </span><span class="kn">import</span> <span class="n">EVENT_CLOCK</span><span class="p">,</span> <span class="n">EVENT_LOB</span><span class="p">,</span> <span class="n">EVENT_TRADE</span>
<a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.alpha</span><span class="w"> </span><span class="kn">import</span> <span class="n">Model</span>
<a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">rolling_apply</span>
<a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.features</span><span class="w"> </span><span class="kn">import</span> <span class="n">trade_imbalance</span>
<a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a>
<a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a><span class="k">class</span><span class="w"> </span><span class="nc">TI</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
<a id="__codelineno-64-20" name="__codelineno-64-20" href="#__codelineno-64-20"></a>
<a id="__codelineno-64-21" name="__codelineno-64-21" href="#__codelineno-64-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_trade_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">trade_buffer</span><span class="p">):</span>  
<a id="__codelineno-64-22" name="__codelineno-64-22" href="#__codelineno-64-22"></a>        <span class="k">pass</span>
<a id="__codelineno-64-23" name="__codelineno-64-23" href="#__codelineno-64-23"></a>
<a id="__codelineno-64-24" name="__codelineno-64-24" href="#__codelineno-64-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">event_estimator</span><span class="p">(</span>
<a id="__codelineno-64-25" name="__codelineno-64-25" href="#__codelineno-64-25"></a>        <span class="bp">self</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span><span class="n">event_type</span><span class="p">,</span><span class="n">event_id</span><span class="p">,</span><span class="n">type_id</span><span class="p">,</span>
<a id="__codelineno-64-26" name="__codelineno-64-26" href="#__codelineno-64-26"></a>        <span class="n">trade_buffer</span><span class="p">,</span><span class="n">ob_timestamps</span><span class="p">,</span><span class="n">ob_bids</span><span class="p">,</span><span class="n">ob_asks</span><span class="p">,</span><span class="n">ob_mids</span><span class="p">,</span><span class="n">features</span><span class="p">,</span>
<a id="__codelineno-64-27" name="__codelineno-64-27" href="#__codelineno-64-27"></a>        <span class="n">running_event_ids</span><span class="p">,</span><span class="n">running_type_ids</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-64-28" name="__codelineno-64-28" href="#__codelineno-64-28"></a>    <span class="p">):</span>
<a id="__codelineno-64-29" name="__codelineno-64-29" href="#__codelineno-64-29"></a>        <span class="k">pass</span>
</code></pre></div>
This time, the feature is trade-related. So we will pre-process the TI estimates and then make estimates on each `EVENT_TRADE`. We can do this using the `quantpylib.hft.utils`'s `rolling_apply` function that does what the name-suggests, on rolling numpy array samples:
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute_trade_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">trade_buffer</span><span class="p">):</span>  
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>        <span class="n">tis</span> <span class="o">=</span> <span class="n">rolling_apply</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">trade_buffer</span><span class="p">,</span><span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">trade_imbalance</span><span class="p">)</span>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>            <span class="s2">&quot;TI&quot;</span><span class="p">:</span><span class="n">tis</span>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>        <span class="p">}</span>
</code></pre></div>
The trade-imbalance from `quantpylib.hft.features` has implementation like this:
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">trade_imbalance</span><span class="p">(</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>    <span class="n">trades</span><span class="p">,</span> 
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>    <span class="n">decay_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">sample</span><span class="p">:</span> <span class="n">exponential_weights</span><span class="p">(</span><span class="n">arr</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span><span class="n">unique_values</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> 
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>    <span class="n">window_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="kc">None</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="p">):</span>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>    <span class="k">if</span> <span class="n">T</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">trades</span> <span class="o">=</span> <span class="n">trades</span><span class="p">[</span><span class="n">trades</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">T</span><span class="p">]</span> 
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="n">window_n</span><span class="p">,</span><span class="n">window_s</span><span class="p">]</span> <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> 
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;sample window can only be defined by one of window_n, window_s&quot;</span><span class="p">)</span> 
<a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a>    <span class="k">if</span> <span class="n">window_n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>  <span class="n">trades</span> <span class="o">=</span> <span class="n">trades</span><span class="p">[</span><span class="o">-</span><span class="n">window_n</span><span class="p">:]</span>
<a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>    <span class="k">if</span> <span class="n">T</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">T</span> <span class="o">=</span> <span class="n">trades</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>    <span class="k">if</span> <span class="n">window_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">trades</span> <span class="o">=</span> <span class="n">trades</span> <span class="o">=</span> <span class="n">trades</span><span class="p">[</span><span class="n">trades</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="n">window_s</span><span class="o">*</span><span class="mi">1000</span><span class="p">)]</span>
<a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a>
<a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a>    <span class="c1">#trade = ts, price, size, dir </span>
<a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trades</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span> 
<a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a>    <span class="n">weights</span> <span class="o">=</span> <span class="n">decay_function</span><span class="p">(</span><span class="n">T</span> <span class="o">-</span> <span class="n">trades</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a>    <span class="n">signed_volume</span> <span class="o">=</span> <span class="n">trades</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">trades</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
<a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">signed_volume</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">trades</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
</code></pre></div>
refer to implementation of `exponential_weights` in the repository code; or use your imagination. We just used the last twenty trade events, but of course this is up to you. Making estimates are simple, we just echo this at the correct event:
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">event_estimator</span><span class="p">(</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>        <span class="bp">self</span><span class="p">,</span><span class="n">ts</span><span class="p">,</span><span class="n">event_type</span><span class="p">,</span><span class="n">event_id</span><span class="p">,</span><span class="n">type_id</span><span class="p">,</span>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>        <span class="n">trade_buffer</span><span class="p">,</span><span class="n">ob_timestamps</span><span class="p">,</span><span class="n">ob_bids</span><span class="p">,</span><span class="n">ob_asks</span><span class="p">,</span><span class="n">ob_mids</span><span class="p">,</span><span class="n">features</span><span class="p">,</span>
<a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>        <span class="n">running_event_ids</span><span class="p">,</span><span class="n">running_type_ids</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span>
<a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>    <span class="p">):</span>
<a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>        <span class="n">estimates</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a>        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="n">EVENT_TRADE</span><span class="p">:</span>
<a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>            <span class="n">estimates</span><span class="p">[</span><span class="s1">&#39;TI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">EVENT_TRADE</span><span class="p">][</span><span class="s2">&quot;TI&quot;</span><span class="p">][</span><span class="n">type_id</span><span class="p">]</span>
<a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a>        <span class="k">return</span> <span class="n">estimates</span>
</code></pre></div>
Running it is even simpler
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="n">alpha</span> <span class="o">=</span> <span class="n">TI</span><span class="p">(</span>
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>    <span class="n">ob_timestamps</span><span class="o">=</span><span class="n">ob_timestamps</span><span class="p">,</span>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>    <span class="n">ob_bids</span><span class="o">=</span><span class="n">bids</span><span class="p">,</span>
<a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>    <span class="n">ob_asks</span><span class="o">=</span><span class="n">asks</span><span class="p">,</span>
<a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>    <span class="n">ob_mids</span><span class="o">=</span><span class="n">mids</span><span class="p">,</span>
<a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>    <span class="n">trade_buffer</span><span class="o">=</span><span class="n">trades</span><span class="p">,</span>
<a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="p">)</span>
<a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="n">alpha</span><span class="o">.</span><span class="n">run_estimator</span><span class="p">()</span>
</code></pre></div>
In this case TI just ranges from -1 to 1 - it is not yet a fair price estimator. But we can ask for useful dataframes:
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="n">variable_df</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">df_estimators</span><span class="p">(</span><span class="n">include_forwards</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
which looks like this:
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>                     TI        t0        t1        t5       t15       t30       t60
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>1722092423332 -1.000000  0.202500  0.202340  0.202275  0.202275  0.202205  0.202255
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>1722092423534 -0.951384  0.202500  0.202345  0.202275  0.202275  0.202205  0.202255
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>1722092424342 -0.903858  0.202340  0.202305  0.202275  0.202275  0.202205  0.202255
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>1722092428167 -0.869708  0.202275  0.202275  0.202275  0.202275  0.202205  0.202250
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>1722092447111 -0.730021  0.202335  0.202305  0.202205  0.202245  0.202265  0.202315
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>...                 ...       ...       ...       ...       ...       ...       ...
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>1722095930541  0.784021  0.200680  0.200705  0.200740  0.200655  0.200775  0.200730
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>1722095933658  0.847519  0.200705  0.200685  0.200735  0.200635  0.200830  0.200710
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>1722095934190  0.805306  0.200755  0.200740  0.200730  0.200635  0.200830  0.200690
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>1722095938015  0.821895  0.200735  0.200730  0.200715  0.200470  0.200865  0.200730
<a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a>1722095939023  0.696006  0.200730  0.200730  0.200675  0.200465  0.200900  0.200730
</code></pre></div>
for each TI estimate at each trade event, we have preloaded a dataframe with the instantaneous mid price, and mid prices up to sixty seconds out.

Let's propose a fair price model using this TI figures. The model we choose should be determined by the average holding period - obviously if we are buying and selling out the position within one-second, the price in sixty seconds is less relevant.

We shall try a least-squares, zero-intercept simple regression model, with the help of our regression library `quantpylib.simulator.models.GeneticRegression`.
This allows us to do things like
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.simulator.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeneticRegression</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="n">regmodel</span> <span class="o">=</span> <span class="n">GeneticRegression</span><span class="p">(</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>    <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;div(minus(t1,t0),t0) ~ TI&quot;</span><span class="p">,</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>    <span class="n">df</span><span class="o">=</span><span class="n">variable_df</span><span class="p">,</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>    <span class="n">intercept</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a><span class="p">)</span>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="n">res</span> <span class="o">=</span> <span class="n">regmodel</span><span class="o">.</span><span class="n">ols</span><span class="p">()</span>
<a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="n">regmodel</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</code></pre></div>
We get a bunch of useful plots - here is one:

![alt text](../archives/ti_reg1.png)

with summary
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>                                 OLS Regression Results
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>=======================================================================================
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>Dep. Variable:                     b0   R-squared (uncentered):                   0.051
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>Model:                            OLS   Adj. R-squared (uncentered):              0.050
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>Method:                 Least Squares   F-statistic:                              44.43
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>Date:                Sat, 03 Aug 2024   Prob (F-statistic):                    4.81e-11
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>Time:                        18:56:51   Log-Likelihood:                          5116.2
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>No. Observations:                 825   AIC:                                 -1.023e+04
<a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>Df Residuals:                     824   BIC:                                 -1.023e+04
<a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>Df Model:                           1
<a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a>Covariance Type:            nonrobust
<a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a>==============================================================================
<a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a>                 coef    std err          t      P&gt;|t|      [0.025      0.975]
<a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a>------------------------------------------------------------------------------
<a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a>b1             0.0002   2.59e-05      6.666      0.000       0.000       0.000
<a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a>==============================================================================
<a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a>Omnibus:                      898.172   Durbin-Watson:                   0.984
<a id="__codelineno-72-18" name="__codelineno-72-18" href="#__codelineno-72-18"></a>Prob(Omnibus):                  0.000   Jarque-Bera (JB):           163861.949
<a id="__codelineno-72-19" name="__codelineno-72-19" href="#__codelineno-72-19"></a>Skew:                          -4.759   Prob(JB):                         0.00
<a id="__codelineno-72-20" name="__codelineno-72-20" href="#__codelineno-72-20"></a>Kurtosis:                      71.383   Cond. No.                         1.00
<a id="__codelineno-72-21" name="__codelineno-72-21" href="#__codelineno-72-21"></a>==============================================================================
</code></pre></div>
Statistically significant it says. Perhaps we would like to zoom out more and see some aggregated features. 
The `GeneticRegression.ols` allows us to bin data into blocks, and then aggregate 
the axis values. We will take defaults:
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.simulator.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bin</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="n">regmodel</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">bin_block</span><span class="o">=</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span><span class="n">binned_by</span><span class="o">=</span><span class="n">Bin</span><span class="o">.</span><span class="n">WIDTH</span><span class="p">)</span>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="n">regmodel</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>
and we see:

![alt text](../archives/ti_reg2.png)

Here the sample size is 825. Let's do the regression on some 448228 trade data samples (collect your own data boys and girls), and then binned, regressed and plotted:

![alt text](../archives/ti_reg3.png)

When more data samples are collected, here the trend is obvious. However, we can see that the residuals are non-random. The suggested relationships appears to be curvilinear. Perhaps a higher order polynomial (cubic?). We stop here, fit your own data! The tools have been provided. On the same 448228 size dataset, we try a longer prediction `div(minus(t30,t0),t0) ~ TI` and get 

![alt text](../archives/ti_reg4.png)

the result is similar.
-->

<h3 id="limit-order-book">Limit-Order Book</h3>
<p>You may want to use the orderbook with your own data stream.
Here is an example of how you can do it (speudo-code)
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.lob</span><span class="w"> </span><span class="kn">import</span> <span class="n">LOB</span> 
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="n">ob</span> <span class="o">=</span> <span class="n">LOB</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">buffer_size</span><span class="p">)</span>   
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">on_stream</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>    <span class="n">ob</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;ts&#39;</span><span class="p">],</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">],</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span><span class="n">is_snapshot</span><span class="o">=</span><span class="kc">True</span> <span class="o">/</span> <span class="kc">False</span><span class="p">)</span>
</code></pre></div></p>
<p>A limit order book object is only interesting with data already in it. Although we can create a <code>LOB</code> object directly, for demonstration - we are going to obtain it from a market data stream. Fortunately, our <code>quantpylib.gateway.executor</code> library has a <code>l2_book_mirror</code> method that returns a live orderbook object.</p>
<p>We will get data from hyperliquid through the gateway object:
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.gateway.master</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gateway</span>
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="n">gateway</span> <span class="o">=</span> <span class="n">Gateway</span><span class="p">(</span><span class="n">config_keys</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hyperliquid&quot;</span><span class="p">:{}})</span>
<a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>
<a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ob_handler</span><span class="p">(</span><span class="n">ob</span><span class="p">):</span>
<a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ob</span><span class="o">.</span><span class="n">get_mid</span><span class="p">(),</span> <span class="n">ob</span><span class="o">.</span><span class="n">get_spread</span><span class="p">())</span>
<a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a>    <span class="k">return</span>
<a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a>
<a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a>
<a id="__codelineno-75-13" name="__codelineno-75-13" href="#__codelineno-75-13"></a>    <span class="k">await</span> <span class="n">gateway</span><span class="o">.</span><span class="n">init_clients</span><span class="p">()</span>
<a id="__codelineno-75-14" name="__codelineno-75-14" href="#__codelineno-75-14"></a>    <span class="n">ob_model</span> <span class="o">=</span> <span class="k">await</span> <span class="n">gateway</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">l2_book_mirror</span><span class="p">(</span>
<a id="__codelineno-75-15" name="__codelineno-75-15" href="#__codelineno-75-15"></a>        <span class="n">ticker</span><span class="o">=</span><span class="s2">&quot;SOL&quot;</span><span class="p">,</span>
<a id="__codelineno-75-16" name="__codelineno-75-16" href="#__codelineno-75-16"></a>        <span class="n">depth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-75-17" name="__codelineno-75-17" href="#__codelineno-75-17"></a>        <span class="n">buffer_size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<a id="__codelineno-75-18" name="__codelineno-75-18" href="#__codelineno-75-18"></a>        <span class="n">as_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-75-19" name="__codelineno-75-19" href="#__codelineno-75-19"></a>        <span class="n">on_update</span><span class="o">=</span><span class="n">ob_handler</span><span class="p">,</span>
<a id="__codelineno-75-20" name="__codelineno-75-20" href="#__codelineno-75-20"></a>        <span class="n">exc</span><span class="o">=</span><span class="s1">&#39;hyperliquid&#39;</span>
<a id="__codelineno-75-21" name="__codelineno-75-21" href="#__codelineno-75-21"></a>    <span class="p">)</span>
<a id="__codelineno-75-22" name="__codelineno-75-22" href="#__codelineno-75-22"></a>
<a id="__codelineno-75-23" name="__codelineno-75-23" href="#__codelineno-75-23"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
<a id="__codelineno-75-24" name="__codelineno-75-24" href="#__codelineno-75-24"></a>
<a id="__codelineno-75-25" name="__codelineno-75-25" href="#__codelineno-75-25"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-75-26" name="__codelineno-75-26" href="#__codelineno-75-26"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
This maps to the <code>l2_book_mirror</code> method in <a href="../../wrappers/hyperliquid/#quantpylib.wrappers.hyperliquid.Hyperliquid.l2_book_mirror"><code>quantpylib.wrappers.hyperliquid</code></a> wrapper, and <code>as_dict=False</code> specifices we want a <a href=".. /lob/#quantpylib.hft.lob.LOB"><code>quantpylib.hft.lob.LOB</code></a> object.</p>
<p>We can now use the utility functions of the orderbook class. While we are sleeping, the <code>ob_handler</code> prints out...
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>182.04500000000002 0.010000000000019327
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>182.04500000000002 0.010000000000019327
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>182.04500000000002 0.010000000000019327
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>182.05 0.020000000000010232
<a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>182.075 0.010000000000019327
<a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a>182.075 0.010000000000019327
<a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>182.075 0.010000000000019327
<a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a>182.075 0.010000000000019327
</code></pre></div>
and so on. We do not have to call the <code>LOB.update</code> method here, since the mirror method takes care of the state of the orderbook on data stream. Let's take a look at some of the utility functions after sleeping:
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ob_model</span><span class="o">.</span><span class="n">get_mid</span><span class="p">(),</span><span class="n">ob_model</span><span class="o">.</span><span class="n">get_vamp</span><span class="p">(</span><span class="n">notional</span><span class="o">=</span><span class="mi">3000</span><span class="p">))</span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ob_model</span><span class="o">.</span><span class="n">get_vol</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ob_model</span><span class="o">.</span><span class="n">buffer_len</span><span class="p">())</span>
</code></pre></div>
and we get 
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a>182.085 182.06296258333333
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>0.018219811123247037
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a>104
</code></pre></div>
We get different figures for mid-price, fair-price estimator using quote volume imbalance, volatility and length of running buffer. Of course, these methods have additional parameters, such as the sample size used to compute volatility - we refer to <a href="../lob/">documentation</a>.</p>
<h3 id="trades">Trades</h3>
<p>Like the <code>LOB</code> object, <code>Trades</code> is a trade buffer stream. Using the data streamed in, we may get useful information such as trade imbalance.</p>
<p>Filling in the trade buffer is extremely easy, let's get the hyperliquid BTC trade stream:
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.trades</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trades</span>
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.wrappers.hyperliquid</span><span class="w"> </span><span class="kn">import</span> <span class="n">Hyperliquid</span>
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a>
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>    <span class="n">ticker</span> <span class="o">=</span> <span class="s2">&quot;BTC&quot;</span>
<a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a>
<a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a>    <span class="n">hpl</span> <span class="o">=</span> <span class="n">Hyperliquid</span><span class="p">()</span>
<a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a>    <span class="k">await</span> <span class="n">hpl</span><span class="o">.</span><span class="n">init_client</span><span class="p">()</span>
<a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a>    <span class="n">trades</span> <span class="o">=</span> <span class="n">Trades</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">)</span>
<a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">trade_handler</span><span class="p">(</span><span class="n">trade</span><span class="p">):</span>
<a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a>        <span class="c1">#trade is (time_ms, price, size, dir)</span>
<a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a>        <span class="c1">#&gt;&gt;&gt; (1722177301662, 67749.0, 0.0003, -1)</span>
<a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a>        <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="o">=</span><span class="n">trade</span><span class="p">)</span> 
<a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a>
<a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a>    <span class="k">await</span> <span class="n">hpl</span><span class="o">.</span><span class="n">trades_subscribe</span><span class="p">(</span><span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="n">trade_handler</span><span class="p">)</span>
<a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</code></pre></div>
That's pretty much it - from here the buffer is being populated, and we can 
compute figures such as trade imbalance and so on.</p>
<h3 id="statistics">Statistics</h3>
<p>This is our statistical library for hft modelling. It is designed to work seamlessly with the data structures from our internal state representations, such as the orderbook <code>LOB</code> and trades <code>Trades</code>, but will work just as well with external data.</p>
<p>For instance, we may be interested in computing orderbook liquidity - to do this we fit an exponential decay model for the hit and -lifted amounts against the distance to mid price. This figure is directly related to the Poisson intensity that is often taken as a model for trade arrivals.</p>
<p>Let's stream both the l2-book data and the trades occuring:
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>
<a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.lob</span><span class="w"> </span><span class="kn">import</span> <span class="n">LOB</span>
<a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.trades</span><span class="w"> </span><span class="kn">import</span> <span class="n">Trades</span>
<a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.hft.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">intensity</span>
<a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>
<a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.wrappers.hyperliquid</span><span class="w"> </span><span class="kn">import</span> <span class="n">Hyperliquid</span>
<a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>
<a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a>    <span class="n">ticker</span> <span class="o">=</span> <span class="s2">&quot;BTC&quot;</span>
<a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a>
<a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a>    <span class="n">hpl</span> <span class="o">=</span> <span class="n">Hyperliquid</span><span class="p">()</span>
<a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a>    <span class="k">await</span> <span class="n">hpl</span><span class="o">.</span><span class="n">init_client</span><span class="p">()</span>
<a id="__codelineno-80-16" name="__codelineno-80-16" href="#__codelineno-80-16"></a>
<a id="__codelineno-80-17" name="__codelineno-80-17" href="#__codelineno-80-17"></a>    <span class="n">ob</span> <span class="o">=</span> <span class="k">await</span> <span class="n">hpl</span><span class="o">.</span><span class="n">l2_book_mirror</span><span class="p">(</span>
<a id="__codelineno-80-18" name="__codelineno-80-18" href="#__codelineno-80-18"></a>        <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
<a id="__codelineno-80-19" name="__codelineno-80-19" href="#__codelineno-80-19"></a>        <span class="n">depth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-80-20" name="__codelineno-80-20" href="#__codelineno-80-20"></a>        <span class="n">buffer_size</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">,</span>
<a id="__codelineno-80-21" name="__codelineno-80-21" href="#__codelineno-80-21"></a>        <span class="n">as_dict</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-80-22" name="__codelineno-80-22" href="#__codelineno-80-22"></a>    <span class="p">)</span>
<a id="__codelineno-80-23" name="__codelineno-80-23" href="#__codelineno-80-23"></a>    <span class="n">trades</span> <span class="o">=</span> <span class="n">Trades</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">)</span>
<a id="__codelineno-80-24" name="__codelineno-80-24" href="#__codelineno-80-24"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">trade_handler</span><span class="p">(</span><span class="n">trade</span><span class="p">):</span>
<a id="__codelineno-80-25" name="__codelineno-80-25" href="#__codelineno-80-25"></a>        <span class="n">trades</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade</span><span class="o">=</span><span class="n">trade</span><span class="p">)</span>
<a id="__codelineno-80-26" name="__codelineno-80-26" href="#__codelineno-80-26"></a>
<a id="__codelineno-80-27" name="__codelineno-80-27" href="#__codelineno-80-27"></a>    <span class="k">await</span> <span class="n">hpl</span><span class="o">.</span><span class="n">trades_subscribe</span><span class="p">(</span><span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="n">trade_handler</span><span class="p">)</span>
<a id="__codelineno-80-28" name="__codelineno-80-28" href="#__codelineno-80-28"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-80-29" name="__codelineno-80-29" href="#__codelineno-80-29"></a>
<a id="__codelineno-80-30" name="__codelineno-80-30" href="#__codelineno-80-30"></a>    <span class="c1">#code goes here...</span>
<a id="__codelineno-80-31" name="__codelineno-80-31" href="#__codelineno-80-31"></a>
<a id="__codelineno-80-32" name="__codelineno-80-32" href="#__codelineno-80-32"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-80-33" name="__codelineno-80-33" href="#__codelineno-80-33"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
After twenty minutes, we get some two thousand data points and four hundred trades. Let's fit the exponential function using <code>quantpylib.hft.stats.intensity</code>, and make some plots:
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">ob</span><span class="o">.</span><span class="n">buffer_len</span><span class="p">())</span> <span class="c1">#2051</span>
<a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">trades</span><span class="o">.</span><span class="n">buffer_len</span><span class="p">())</span> <span class="c1">#408</span>
<a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>
<a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a>    <span class="n">params</span> <span class="o">=</span> <span class="n">intensity</span><span class="p">(</span>
<a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>        <span class="n">lob_timestamps</span><span class="o">=</span><span class="n">ob</span><span class="o">.</span><span class="n">get_ts_buffer</span><span class="p">(),</span>
<a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>        <span class="n">lob_mids</span><span class="o">=</span><span class="n">ob</span><span class="o">.</span><span class="n">get_mids_buffer</span><span class="p">(),</span>
<a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>        <span class="n">trades</span><span class="o">=</span><span class="n">trades</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">(),</span>
<a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>    <span class="p">)</span>   
<a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a>
<a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a>    <span class="n">alpha</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;alpha&quot;</span><span class="p">)</span>
<a id="__codelineno-81-11" name="__codelineno-81-11" href="#__codelineno-81-11"></a>    <span class="n">kappa</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kappa&quot;</span><span class="p">)</span>
<a id="__codelineno-81-12" name="__codelineno-81-12" href="#__codelineno-81-12"></a>    <span class="n">levels</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;levels&quot;</span><span class="p">)</span>
<a id="__codelineno-81-13" name="__codelineno-81-13" href="#__codelineno-81-13"></a>    <span class="n">agg_amounts</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amounts&quot;</span><span class="p">)</span>
<a id="__codelineno-81-14" name="__codelineno-81-14" href="#__codelineno-81-14"></a>    <span class="n">fitted_values</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span> <span class="o">*</span> <span class="n">levels</span><span class="p">)</span>
<a id="__codelineno-81-15" name="__codelineno-81-15" href="#__codelineno-81-15"></a>
<a id="__codelineno-81-16" name="__codelineno-81-16" href="#__codelineno-81-16"></a>    <span class="c1"># Plot the actual and fitted</span>
<a id="__codelineno-81-17" name="__codelineno-81-17" href="#__codelineno-81-17"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a id="__codelineno-81-18" name="__codelineno-81-18" href="#__codelineno-81-18"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">agg_amounts</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Aggregated Amounts&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<a id="__codelineno-81-19" name="__codelineno-81-19" href="#__codelineno-81-19"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">fitted_values</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Fitted Model: $A(d) = </span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> e^</span><span class="se">{{</span><span class="s1">-</span><span class="si">{</span><span class="n">kappa</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> d</span><span class="se">}}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<a id="__codelineno-81-20" name="__codelineno-81-20" href="#__codelineno-81-20"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Distance from Mid-Price (d)&#39;</span><span class="p">)</span>
<a id="__codelineno-81-21" name="__codelineno-81-21" href="#__codelineno-81-21"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Aggregated Trade Amount (A(d))&#39;</span><span class="p">)</span>
<a id="__codelineno-81-22" name="__codelineno-81-22" href="#__codelineno-81-22"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Exponential Decay Model Fit to Aggregated Trade Amounts&#39;</span><span class="p">)</span>
<a id="__codelineno-81-23" name="__codelineno-81-23" href="#__codelineno-81-23"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-81-24" name="__codelineno-81-24" href="#__codelineno-81-24"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-81-25" name="__codelineno-81-25" href="#__codelineno-81-25"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
Obviously, the sample size is rather small, but we will carry on for the sake of demonstration. Here is the decay function:</p>
<p><img alt="alt text" src="../../archives/example_intensity.png" /></p>
<p>Values such as kappa are often used as measures of orderbook liquidity. Higher values of kappa indicate strong decay, hence greater trading near the mid-price. Lower values indicate
weak decay - market order sizes often wipe out a few levels in the orderbook and have strong 
price impact. See <a href="https://github.com/hummingbot/hummingbot/blob/f111d1c90de9189ee4e2de3f7e7c56d8f6f2b1cf/hummingbot/strategy/__utils__/trailing_indicators/trading_intensity.pyx#L28">Hummingbot implementation</a> of computing trade intensity. In stoikov-avellaneda market making formula, kappa appears as term in optimal spread; see <a href="https://github.com/hummingbot/hummingbot/blob/f111d1c90de9189ee4e2de3f7e7c56d8f6f2b1cf/hummingbot/strategy/avellaneda_market_making/avellaneda_market_making.pyx">Hummingbot avellaneda_market_making.pyx</a>:
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>self._optimal_spread = self.gamma * vol * time_left_fraction
<a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>self._optimal_spread += 2 * Decimal(1 + self.gamma / self._kappa).ln() / self.gamma
</code></pre></div>
Optimal spread has an additive factor of log(1 + c/kappa), where smaller values of kappa encourages wider maker orders (although I am pretty sure this should be dollar-normalized first).</p>
<h2 id="hftlob"><a href="../lob/">hft.lob</a></h1>
<h2 id="hfttrades"><a href="../trades/">hft.trades</a></h1>
<h2 id="hftfeatures"><a href="../features/">hft.features</a></h1>
<h2 id="hftstats"><a href="../stats/">hft.stats</a></h1>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2024 <a href="https://hangukquant.com"  target="_blank" rel="noopener">Quanta Global Pte. Ltd. 202328387H - All Rights Reserved.</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/hangukquant" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>