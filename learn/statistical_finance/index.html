
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../scripts/trend_following/">
      
      
        <link rel="next" href="../high_frequency_trading/">
      
      
      <link rel="icon" href="../../icons/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Statistical Finance - quantpylib</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="lime">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#permutation-sampling" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="quantpylib" class="md-header__button md-logo" aria-label="quantpylib" data-md-component="logo">
      
  <img src="../../icons/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            quantpylib
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Statistical Finance
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../simulator/simulator/" class="md-tabs__link">
          
  
  
  User Documentation

        </a>
      </li>
    
  

    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../pricing/pricing/" class="md-tabs__link">
          
  
  
  Pricing

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../scripts/market_making/" class="md-tabs__link">
          
  
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  
  Learn

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../bounties/" class="md-tabs__link">
          
  
  
  Bounties

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="quantpylib" class="md-nav__button md-logo" aria-label="quantpylib" data-md-component="logo">
      
  <img src="../../icons/logo.png" alt="logo">

    </a>
    quantpylib
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Documentation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            quantpylib
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1_1" id="__nav_2_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.simulator
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.simulator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulator/simulator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.simulator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulator/alpha/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.simulator.alpha
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulator/gene/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.simulator.gene
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulator/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.simulator.models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulator/operators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.simulator.operators
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../simulator/performance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.simulator.performance
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2" >
        
          
          <label class="md-nav__link" for="__nav_2_1_2" id="__nav_2_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.hft
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.hft
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hft/hft/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hft/feed/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.feed
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hft/oms/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.oms
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hft/mocks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.mocks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hft/bars/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.bars
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hft/lob/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.lob
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hft/trades/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.trades
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hft/features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.features
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hft/stats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.stats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../hft/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.hft.utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_3" >
        
          
          <label class="md-nav__link" for="__nav_2_1_3" id="__nav_2_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.throttler
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_3">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.throttler
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../throttler/throttler/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.throttler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../throttler/aiohttp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.throttler.aiohttp
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../throttler/aiosonic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.throttler.aiosonic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../throttler/httpx/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.throttler.httpx
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../throttler/rate_semaphore/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.throttler.rate_semaphore
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../throttler/decorators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.throttler.decorators
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_4" >
        
          
          <label class="md-nav__link" for="__nav_2_1_4" id="__nav_2_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.utilities
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_4">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.utilities
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/utilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.utilities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/general/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.utilities.general
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/math/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.utilities.math
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/cringbuffer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.utilities.cringbuffer
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_5" >
        
          
          <label class="md-nav__link" for="__nav_2_1_5" id="__nav_2_1_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_5">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.datapoller
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/datapoller/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/master/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.master
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.base
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/crypto/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.crypto
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/currencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.currencies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/equities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.equities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/exchange/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.exchange
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../datapoller/metadata/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.datapoller.metadata
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_6" >
        
          
          <label class="md-nav__link" for="__nav_2_1_6" id="__nav_2_1_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.gateway
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_6">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.gateway
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/gateway/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/account/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.account
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.base
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/exchange/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.exchange
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/executor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.executor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/master/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.master
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/orders/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.orders
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/positions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.positions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gateway/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.gateway.utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_7" >
        
          
          <label class="md-nav__link" for="__nav_2_1_7" id="__nav_2_1_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.standards
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_7">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.standards
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/standards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.standards
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/intervals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.standards.intervals
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/markets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.standards.markets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../standards/portfolio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.standards.portfolio
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_8" >
        
          
          <label class="md-nav__link" for="__nav_2_1_8" id="__nav_2_1_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_8">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.wrappers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/wrappers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/binance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.binance
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/bybit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.bybit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/hyperliquid/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.hyperliquid
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/paradex/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.paradex
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/woox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.woox
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/polymarket/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.polymarket
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/eodhd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.eodhd
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/oanda/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.oanda
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../wrappers/yfinance/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.wrappers.yfinance
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_9" >
        
          
          <label class="md-nav__link" for="__nav_2_1_9" id="__nav_2_1_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    quantpylib.logger
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_9">
            <span class="md-nav__icon md-icon"></span>
            quantpylib.logger
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logger/logger/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.logger
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logger/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.logger.utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logger/formatters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.logger.formatters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logger/handlers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantpylib.logger.handlers
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pricing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Pricing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../pricing/pricing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pricing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/market_making/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Market Maker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/tick_archival/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tick Archival
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scripts/trend_following/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Trend Follower
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Learn
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Learn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Statistical Finance
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Statistical Finance
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#permutation-sampling" class="md-nav__link">
    <span class="md-ellipsis">
      Permutation Sampling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Permutation Sampling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#univariate-price-permutations" class="md-nav__link">
    <span class="md-ellipsis">
      Univariate (Price) Permutations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multivariate-bar-permutations" class="md-nav__link">
    <span class="md-ellipsis">
      Multivariate (Bar) Permutations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#statistical-inferencing-for-quantitative-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Statistical Inferencing for Quantitative Strategies
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Statistical Inferencing for Quantitative Strategies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monte-carlo-permutation-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Monte Carlo Permutation Methods
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monte Carlo Permutation Methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tests-for-singular-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Tests for Singular Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tests-for-strategy-families" class="md-nav__link">
    <span class="md-ellipsis">
      Tests for Strategy Families
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-python-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      A Python Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#finite-sample-probabilistic-bounds" class="md-nav__link">
    <span class="md-ellipsis">
      Finite Sample Probabilistic Bounds
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../high_frequency_trading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    High Frequency Trading
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../scientific_programming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scientific Programming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../portfolio_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Portfolio Management
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Bounties
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Bounties
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bounties/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bounties
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Statistical Finance</h1>

<h2 id="permutation-sampling">Permutation Sampling</h2>
<p>In permutation sampling, we aim to destroy local temporal structure in financial time series while preserving global statistical properties such as marginal distributions, moments of distribution, or overall market drift.</p>
<p>This technique is particularly useful in statistical hypothesis testing: for example, to evaluate whether a trading strategy performs better than chance. By comparing strategy performance on real market data (where predictability may exist) against permuted data (where predictability is fully removed), we can assess the likelihood that observed performance arises from random chance.</p>
<p>Formally, given a time series <span class="arithmatex">\(\{x_t\}_{t = 1}^T\)</span>, we apply a random permutation <span class="arithmatex">\(\pi: [T] \rightarrow [T]\)</span> to obtain</p>
<div class="arithmatex">\[
x^\pi_t = x_{\pi(t)}, \quad t \in [T].
\]</div>
<p>where <span class="arithmatex">\(x_t\)</span> denotes some stationary distribution. If only univariate values are permuted, the autocorrelation is destroyed, but the moments are preserved. In contrast, multivariate permutations (e.g., row-wise permutations of bar data) preserve cross-sectional structure and marginal distributions while eliminating temporal dependencies.</p>
<p>Even though synthetic data such as Brownian motion or Brownian bridges can be used to generate price paths, they introduce new assumptions and modify multiple statistical properties simultaneously. In scientific procedures, we aim to control all variables except the one under investigation — otherwise, conclusions are confounded by uncontrolled factors.</p>
<p>Permutation methods offer a principled alternative: they destroy temporal structure (and thus predictability) while preserving other features of the data. This makes them ideal for scientific experiments.</p>
<h3 id="univariate-price-permutations">Univariate (Price) Permutations</h3>
<p>In univariate permutation sampling, we focus on transforming a single price series — such as closing prices — by permuting its internal structure while preserving global properties such as overall trend.</p>
<p>Here, we seek a variant that preserves the initial and final price levels, ensuring the global drift remains intact. This is achieved by permuting the log returns (or equivalently, the log price differences), which are assumed to be approximately stationary, then reconstructing the price path via exponentiation.</p>
<p>Let <span class="arithmatex">\(\{P_t\}_{t = 0}^{T}\)</span> denote the original price series. Define the log returns:</p>
<div class="arithmatex">\[
D_t = \log\left(\frac{P_{t+1}}{P_t}\right) = \log P_{t+1} - \log P_t, \quad t \in [T-1].
\]</div>
<p>We apply the permutation algorithm to <span class="arithmatex">\(\{D_t\}\)</span>, obtaining a permuted sequence <span class="arithmatex">\(\{D_t'\}\)</span>. </p>
<p>To generate a member of a permutation set
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">permutation_member</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> 
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">:</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>        <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">array</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="k">return</span> <span class="n">array</span>  
</code></pre></div></p>
<p>We then reconstruct the permuted log price path by cumulative summation:</p>
<div class="arithmatex">\[
\log P_0',\ \log P_0' + D_1',\ \log P_0' + D_1' + D_2',\ \dots,
\]</div>
<p>and exponentiate the result to obtain the new permuted price series.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">permute_price</span><span class="p">(</span><span class="n">price</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    <span class="n">log_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="n">diff_logs</span> <span class="o">=</span> <span class="n">log_prices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">log_prices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="n">diff_perm</span> <span class="o">=</span> <span class="n">permutation_member</span><span class="p">(</span><span class="n">diff_logs</span><span class="p">)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="n">cum_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">diff_perm</span><span class="p">)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="n">new_log_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">log_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">log_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cum_change</span><span class="p">))</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>    <span class="n">new_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">new_log_prices</span><span class="p">)</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="k">return</span> <span class="n">new_prices</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="c1"># Example usage</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="n">permuted_price</span> <span class="o">=</span> <span class="n">permute_price</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="nb">print</span><span class="p">(</span><span class="n">permuted_price</span><span class="p">)</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="c1"># [3.0000, 6.0000, 4.8000, 9.6000, 14.399, 4.8000, 3.2000, 4.0000]</span>
</code></pre></div>
<p>This method preserves the first and last price, destroys temporal dependence, and retains the marginal distribution of log returns. It provides a robust null model for hypothesis testing when testing for time-dependent structure in univariate financial series.</p>
<p>When working with multiple price series from different instruments, we aim to preserve the inter-series structure (e.g., cross-instrument correlation) while eliminating only temporal dependencies.</p>
<p>Applying independent permutations to each price series destroys their joint distribution, including cross-asset dependencies and synchronized drawdowns. This can distort portfolio-level risk metrics and undermine hypothesis tests designed to isolate time-series predictability.</p>
<p>To address this, we generalize the permutation method by applying a single shared permutation index across all series. This preserves the joint distribution of returns across instruments while removing their individual serial structure.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">permute_price</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">permute_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    <span class="k">if</span> <span class="n">permute_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>        <span class="n">permute_index</span> <span class="o">=</span> <span class="n">permutation_member</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="n">log_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>    <span class="n">diff_logs</span> <span class="o">=</span> <span class="n">log_prices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">log_prices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>    <span class="n">diff_perm</span> <span class="o">=</span> <span class="n">diff_logs</span><span class="p">[</span><span class="n">permute_index</span><span class="p">]</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="n">cum_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">diff_perm</span><span class="p">)</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="n">new_log_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="n">log_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">log_prices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cum_change</span><span class="p">))</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="n">new_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">new_log_prices</span><span class="p">)</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="k">return</span> <span class="n">new_prices</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="k">def</span><span class="w"> </span><span class="nf">permute_multi_prices</span><span class="p">(</span><span class="n">prices</span><span class="p">):</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="n">permute_index</span> <span class="o">=</span> <span class="n">permutation_member</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="n">new_prices</span> <span class="o">=</span> <span class="p">[</span><span class="n">permute_price</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">permute_index</span><span class="o">=</span><span class="n">permute_index</span><span class="p">)</span> <span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">]</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>    <span class="k">return</span> <span class="n">new_prices</span>
</code></pre></div>
<details>
<summary>Example for Shared Index</summary>

<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pprint</span><span class="w"> </span><span class="kn">import</span> <span class="n">pprint</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="n">prices</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>    <span class="n">prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">[:])</span>  <span class="c1"># deep copy</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="n">pprint</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="n">permuted_prices</span> <span class="o">=</span> <span class="n">permute_multi_prices</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="n">pprint</span><span class="p">(</span><span class="n">permuted_prices</span><span class="p">)</span>
</code></pre></div>

</details>

<p>This shared-index approach ensures that all series undergo the same reordering of returns, thereby preserving inter-series alignment. It is suitable for evaluating the statistical significance of multi-instrument strategies, including long-short spreads, mean-reversion baskets, and cross-sectional alpha signals.</p>
<h3 id="multivariate-bar-permutations">Multivariate (Bar) Permutations</h3>
<p>In many practical settings, we work with multivariate time series data, such as OHLCV bars or engineered features per time step. Each time point <span class="arithmatex">\(t \in [T]\)</span> is associated with a vector <span class="arithmatex">\(\mathbf{x}_t \in \mathbb{R}^d\)</span>, where <span class="arithmatex">\(d\)</span> denotes the number of features (e.g., open, high, low, close, volume, technical indicators, etc.).</p>
<p>Unlike univariate series, there is no universally accepted method for permuting multivariate data. Since such data often arise from dynamic systems with complex temporal and cross-feature dependencies, care must be taken to preserve internal structure while destroying serial correlations.</p>
<p>We illustrate this using OHLCV bars, also known as candlesticks. These may be constructed using time-based sampling or entropy-based sampling schemes such as <em>information bars</em>. Our key goal is to preserve bar-level structure (intra-bar) while eliminating time dependence (inter-bar).</p>
<p><strong>Intra-bar structure.</strong> Each bar comprises price levels: open <span class="arithmatex">\(O_t\)</span>, high <span class="arithmatex">\(H_t\)</span>, low <span class="arithmatex">\(L_t\)</span>, and close <span class="arithmatex">\(C_t\)</span>. Rather than permuting absolute values, we first log-transform the prices and define:</p>
<div class="arithmatex">\[
\Delta_H = H_t - O_t, \quad 
\Delta_L = L_t - O_t, \quad 
\Delta_C = C_t - O_t.
\]</div>
<p>These deltas characterize the internal geometry of each bar and remain approximately stationary after log-transformation.</p>
<p><strong>Inter-bar structure.</strong> A natural candidate for inter-bar relationship is the jump between a bar's close and the next bar's open:</p>
<div class="arithmatex">\[
\Delta_{OC,t} = O_{t+1} - C_t, \quad t \in [T-1].
\]</div>
<p>These differences capture market microstructure effects such as gaps or jumps, and may encode serial correlation, trend, or time-dependent structure, including effects like the well-known overnight effect.</p>
<p><strong>Volume data.</strong> Volume is particularly challenging to permute. It may be stationary or non-stationary depending on the asset and sampling method, and can exhibit strong periodic effects (e.g., time-of-day, day-of-week seasonality). Since volume interacts with both price levels and bar duration, careless permutation may distort the joint distribution of intra- and inter-bar features.</p>
<p>To implement the controlled permutation of multivariate OHLCV bars, the observe the following procedure:</p>
<ul>
<li>Log-transform the OHLCV dataframe.</li>
<li>Compute the intra-bar differences <span class="arithmatex">\(\Delta_H\)</span>, <span class="arithmatex">\(\Delta_L\)</span>, <span class="arithmatex">\(\Delta_C\)</span>.</li>
<li>Permute these intra-bar differences (excluding the first row) using a common permutation index.</li>
<li>Compute the inter-bar open-to-close jumps <span class="arithmatex">\(\Delta_{OC,t} = O_{t+1} - C_t\)</span> and permute them independently.</li>
<li>Reconstruct the full price path iteratively:</li>
<li>Start from the first close.</li>
<li>Add a (permuted) <span class="arithmatex">\(\Delta_{OC,t}\)</span> to compute each new open.</li>
<li>Add (permuted) intra-bar deltas to get the high, low, and close.</li>
<li>Volume is permuted alongside the intra-bar deltas, preserving the endpoints.</li>
<li>The resulting log-prices are exponentiated and reassembled into a new dataframe with the original index.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">permute_bars</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">,</span> <span class="n">index_inter_bar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index_intra_bar</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">index_inter_bar</span><span class="p">:</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>        <span class="n">index_inter_bar</span> <span class="o">=</span> <span class="n">permutation_member</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">index_intra_bar</span><span class="p">:</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>        <span class="n">index_intra_bar</span> <span class="o">=</span> <span class="n">permutation_member</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="n">log_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ohlcv</span><span class="p">)</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="n">delta_h</span> <span class="o">=</span> <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="n">delta_l</span> <span class="o">=</span> <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>    <span class="n">delta_c</span> <span class="o">=</span> <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="n">diff_deltas_h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">delta_h</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">index_intra_bar</span><span class="p">],</span> <span class="p">[</span><span class="n">delta_h</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="n">diff_deltas_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">delta_l</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">index_intra_bar</span><span class="p">],</span> <span class="p">[</span><span class="n">delta_l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span> 
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>    <span class="n">diff_deltas_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">delta_c</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">index_intra_bar</span><span class="p">],</span> <span class="p">[</span><span class="n">delta_c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="n">new_volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        <span class="p">(</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>            <span class="p">[</span><span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>            <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">index_intra_bar</span><span class="p">],</span> 
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>            <span class="p">[</span><span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>        <span class="p">)</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="p">)</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>    <span class="n">inter_open_to_close</span> <span class="o">=</span> <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>    <span class="n">diff_inter_open_to_close</span> <span class="o">=</span> <span class="n">inter_open_to_close</span><span class="p">[</span><span class="n">index_inter_bar</span><span class="p">]</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>    <span class="n">new_opens</span><span class="p">,</span> <span class="n">new_highs</span><span class="p">,</span> <span class="n">new_lows</span><span class="p">,</span> <span class="n">new_closes</span> <span class="o">=</span> \
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="p">[</span><span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;open&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> \
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>        <span class="p">[</span><span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> \
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>        <span class="p">[</span><span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> \
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>        <span class="p">[</span><span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>    <span class="n">last_close</span> <span class="o">=</span> <span class="n">new_closes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>    <span class="k">for</span> <span class="n">i_delta_h</span><span class="p">,</span> <span class="n">i_delta_l</span><span class="p">,</span> <span class="n">i_delta_c</span><span class="p">,</span> <span class="n">inter_otc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>        <span class="n">diff_deltas_h</span><span class="p">,</span> <span class="n">diff_deltas_l</span><span class="p">,</span> <span class="n">diff_deltas_c</span><span class="p">,</span> <span class="n">diff_inter_open_to_close</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>    <span class="p">):</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>        <span class="n">new_open</span> <span class="o">=</span> <span class="n">last_close</span> <span class="o">+</span> <span class="n">inter_otc</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>        <span class="n">new_high</span> <span class="o">=</span> <span class="n">new_open</span> <span class="o">+</span> <span class="n">i_delta_h</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>        <span class="n">new_low</span> <span class="o">=</span> <span class="n">new_open</span> <span class="o">+</span> <span class="n">i_delta_l</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>        <span class="n">new_close</span> <span class="o">=</span> <span class="n">new_open</span> <span class="o">+</span> <span class="n">i_delta_c</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>        <span class="n">new_opens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_open</span><span class="p">)</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>        <span class="n">new_highs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_high</span><span class="p">)</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>        <span class="n">new_lows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_low</span><span class="p">)</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>        <span class="n">new_closes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_close</span><span class="p">)</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>        <span class="n">last_close</span> <span class="o">=</span> <span class="n">new_close</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>    <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>        <span class="p">{</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>            <span class="s2">&quot;open&quot;</span><span class="p">:</span> <span class="n">new_opens</span><span class="p">,</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>            <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="n">new_highs</span><span class="p">,</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>            <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">new_lows</span><span class="p">,</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>            <span class="s2">&quot;close&quot;</span><span class="p">:</span> <span class="n">new_closes</span><span class="p">,</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="n">new_volumes</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>        <span class="p">}</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>    <span class="p">)</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>    <span class="n">new_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">new_df</span><span class="p">)</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>    <span class="n">new_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ohlcv</span><span class="o">.</span><span class="n">index</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>    <span class="k">return</span> <span class="n">new_df</span>
</code></pre></div>
<p>When working with multiple instruments, we apply a common permutation index across all bars to maintain co-movement:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">permute_multi_bars</span><span class="p">(</span><span class="n">bars</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">bars</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">)</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">index_inter_bar</span> <span class="o">=</span> <span class="n">permutation_member</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bars</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="n">index_intra_bar</span> <span class="o">=</span> <span class="n">permutation_member</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bars</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="n">new_bars</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>        <span class="n">permute_bars</span><span class="p">(</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>            <span class="n">bar</span><span class="p">,</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>            <span class="n">index_inter_bar</span><span class="o">=</span><span class="n">index_inter_bar</span><span class="p">,</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>            <span class="n">index_intra_bar</span><span class="o">=</span><span class="n">index_intra_bar</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>        <span class="p">)</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    <span class="p">]</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>    <span class="k">return</span> <span class="n">new_bars</span>
</code></pre></div>
<p>Although the algorithm in the multiple bars permutation works well in theory, it oversimplifies the problem of shuffling real-world financial data — particularly when the testing framework involves a dynamic universe of trading instruments. In practice, portfolios are composed of assets with non-overlapping lifespans: instruments are regularly listed, delisted, or temporarily suspended from trading.</p>
<p>A common preprocessing step in backtesting is to <em>forward-fill</em> and then <em>back-fill</em> missing data so that all instruments align on a shared date axis. However, this may introduce synthetic data for inactive periods, violating the assumption that a given asset was actually tradable throughout the full time range.</p>
<p>Consider a return series for an instrument that only recently became active:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>R = 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.02 0.01
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>R&#39; = 0 0 0 0.1 0 0 0 0 0 0 0 0 0 0.2 0 0 0 0
</code></pre></div>
<p>Clearly, the permuted sequence <span class="arithmatex">\(R'\)</span> is invalid — the non-zero returns have been shifted into periods where the instrument was not alive. To ensure semantic correctness, we must avoid permuting time steps where the instrument was inactive.</p>
<p>To safely permute OHLCV bars, we must first restrict attention to time intervals where all instruments were simultaneously alive. This ensures that shared permutation indices do not introduce artefacts due to inactivity.</p>
<p>For instruments with <em>unequal lifespans</em>, we propose a more flexible method: decompose the full time axis into <em>maximally overlapping alive windows</em> of equal length, apply permutations independently within each window, and then stitch the locally permuted segments together. This preserves statistical control while respecting each asset's period of activity.</p>
<p>Since neither the first nor the last bar is modified during each local permutation, the global series remains semantically valid. However, this localized approach alters the combinatorics of the sampling procedure: rather than permuting the entire dataset globally, we now apply independent permutations within each local window.</p>
<p>Formally, let the time axis be partitioned into <span class="arithmatex">\(K\)</span> local regions, with region <span class="arithmatex">\(k \in [K]\)</span> containing <span class="arithmatex">\(n_k\)</span> permutable elements. The total number of distinct global permutations obtainable is then:</p>
<div class="arithmatex">\[
\prod_{k = 1}^{K} n_k!,
\]</div>
<p>in contrast to the global permutation count</p>
<div class="arithmatex">\[
N! \quad \text{for} \; N = \sum_{k = 1}^{K} n_k.
\]</div>
<p>Since <span class="arithmatex">\(\prod_{k=1}^K n_k! &lt; N!\)</span> for <span class="arithmatex">\(K &gt; 1\)</span>, this results in a strictly smaller permutation space. The penalty is a lower number of distinct simulated paths, which reduces entropy in the null distribution.</p>
<p>Nonetheless, for sufficiently large datasets, this reduction is unlikely to materially affect the statistical power of permutation-based inference. A more important drawback is that serial structure may not be as thoroughly destroyed — particularly across window boundaries. However, this is a reasonable trade-off to ensure the algorithm remains valid and implementable under real-world constraints of a dynamically evolving universe.</p>
<p>When these permutations are applied within a Monte Carlo permutation testing framework, the incomplete destruction of serial dependence leads to a conservative estimate of the <span class="arithmatex">\(p\)</span>-value. This manifests as a <em>loss of power</em> in the statistical test.</p>
<p>The modified algorithm for multi-bar permutations is shown below:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="sd">Input:</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="sd">    bars: list of pandas DataFrames, each containing OHLCV data for one instrument.</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="sd">        Each DataFrame must:</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="sd">            - Have columns: [&quot;open&quot;, &quot;high&quot;, &quot;low&quot;, &quot;close&quot;, &quot;volume&quot;]</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="sd">            - Be indexed by datetime (or sortable time index)</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="sd">            - Be sorted in ascending time order</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="sd">    Assumptions:</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="sd">        - bars[i] and bars[j] may have different date indices.</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="sd">        - The function handles both:</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="sd">            (i) Equal-length, aligned bars with shared time index</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="sd">            (ii) Unequal-length bars with overlapping time windows</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="k">def</span><span class="w"> </span><span class="nf">permute_multi_bars</span><span class="p">(</span><span class="n">bars</span><span class="p">):</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>    <span class="n">index_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="n">index_set</span> <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span><span class="p">):</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>        <span class="n">index_inter_bar</span> <span class="o">=</span> <span class="n">permutation_member</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bars</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>        <span class="n">index_intra_bar</span> <span class="o">=</span> <span class="n">permutation_member</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bars</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>        <span class="n">new_bars</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>            <span class="n">permute_bars</span><span class="p">(</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>                <span class="n">bar</span><span class="p">,</span> 
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>                <span class="n">index_inter_bar</span><span class="o">=</span><span class="n">index_inter_bar</span><span class="p">,</span> 
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>                <span class="n">index_intra_bar</span><span class="o">=</span><span class="n">index_intra_bar</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>            <span class="p">)</span> 
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>            <span class="k">for</span> <span class="n">bar</span> <span class="ow">in</span> <span class="n">bars</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>        <span class="p">]</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>        <span class="n">bar_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bars</span><span class="p">)))</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>        <span class="n">index_to_dates</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">index</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">bar</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bar_indices</span><span class="p">,</span> <span class="n">bars</span><span class="p">)}</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>        <span class="n">date_pool</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">index_to_dates</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>            <span class="n">date_pool</span> <span class="o">=</span> <span class="n">date_pool</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>        <span class="n">date_pool</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">date_pool</span><span class="p">)</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a>        <span class="n">date_pool</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a>        <span class="n">partitions</span><span class="p">,</span> <span class="n">partition_idxs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>        <span class="n">temp_partition</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>        <span class="n">temp_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">date_sets</span> <span class="ow">in</span> <span class="n">index_to_dates</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">date_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">date_sets</span><span class="p">])</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>        <span class="k">for</span> <span class="n">i_date</span> <span class="ow">in</span> <span class="n">date_pool</span><span class="p">:</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>            <span class="n">i_insts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>            <span class="k">for</span> <span class="n">inst</span><span class="p">,</span> <span class="n">date_sets</span> <span class="ow">in</span> <span class="n">index_to_dates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>                <span class="k">if</span> <span class="n">i_date</span> <span class="ow">in</span> <span class="n">date_sets</span><span class="p">:</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>                    <span class="n">i_insts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>            <span class="k">if</span> <span class="n">i_insts</span> <span class="o">==</span> <span class="n">temp_set</span><span class="p">:</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>                <span class="n">temp_partition</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_date</span><span class="p">)</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>                <span class="n">partitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_partition</span><span class="p">)</span>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>                <span class="n">partition_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">temp_set</span><span class="p">))</span>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a>                <span class="n">temp_partition</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_date</span><span class="p">]</span>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a>                <span class="n">temp_set</span> <span class="o">=</span> <span class="n">i_insts</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>        <span class="n">partitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_partition</span><span class="p">)</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>        <span class="n">partition_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">temp_set</span><span class="p">))</span>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a>        <span class="n">chunked_bars</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a>        <span class="k">for</span> <span class="n">partition</span><span class="p">,</span> <span class="n">idx_list</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">partitions</span><span class="p">,</span> <span class="n">partition_idxs</span><span class="p">):</span>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>            <span class="n">permuted_bars</span> <span class="o">=</span> <span class="n">permute_multi_bars</span><span class="p">(</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#__codelineno-7-60"></a>                <span class="p">[</span><span class="n">bars</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">partition</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_list</span><span class="p">]</span>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#__codelineno-7-61"></a>            <span class="p">)</span>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#__codelineno-7-62"></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">bar</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">idx_list</span><span class="p">,</span> <span class="n">permuted_bars</span><span class="p">):</span>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#__codelineno-7-63"></a>                <span class="n">chunked_bars</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#__codelineno-7-64"></a>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#__codelineno-7-65"></a>        <span class="n">new_bars</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">bars</span><span class="p">)</span>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#__codelineno-7-66"></a>        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">bar_indices</span><span class="p">:</span>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#__codelineno-7-67"></a>            <span class="n">new_bars</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">chunked_bars</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#__codelineno-7-68"></a>    <span class="k">return</span> <span class="n">new_bars</span>
</code></pre></div>
<p>In the permutation of bars at finer-than-daily granularity (i.e., intra-day data), we apply the bar permutation algorithm as a subroutine to each day independently. Additionally, we permute the sequence of overnight gaps — one per day — and use this to stitch together the full price series. This approach preserves important features of financial data: each intra-day sample is permuted independently to retain volatility heterogeneity reflective of real market behavior, while the global trend remains fixed via invariant endpoints.</p>
<p>However, like all bar permutation methods, this procedure disrupts volatility clustering — a well-documented stylized fact in asset returns. Traditional bootstrap approaches suffer from the same limitation, offering no improvement in this regard.</p>
<p>A demonstration of the algorithms are shown on real-life data.
The data are obtained from public feeds on Binance perpetual futures for BTCUSDT, ETHUSDT, and SOLUSDT.</p>
<p>We begin with OHLCV data structured as a list of <code>pandas</code> DataFrames as <code>bars</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">bars</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>  <span class="c1"># BTCUSDT sample</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>  <span class="c1"># datetime             open        high         low       close      volume</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>  <span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">08</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>   <span class="mf">10000.00</span>   <span class="mf">10412.65</span>   <span class="mf">10000.00</span>   <span class="mf">10391.63</span>     <span class="mf">3096.291</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>  <span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">09</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>   <span class="mf">10316.62</span>   <span class="mf">10475.54</span>   <span class="mf">10077.22</span>   <span class="mf">10307.00</span>    <span class="mf">14824.373</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>  <span class="mi">2019</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">10</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>   <span class="mf">10307.00</span>   <span class="mf">10382.97</span>    <span class="mf">9940.87</span>   <span class="mf">10102.02</span>     <span class="mf">9068.955</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>  <span class="o">...</span>                     <span class="o">...</span>        <span class="o">...</span>         <span class="o">...</span>        <span class="o">...</span>          <span class="o">...</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>  <span class="mi">2025</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">16</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>  <span class="mf">105534.70</span>  <span class="mf">108900.00</span>  <span class="mf">104920.00</span>  <span class="mf">106750.10</span>   <span class="mf">166813.219</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>  <span class="mi">2025</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>  <span class="mf">106750.10</span>  <span class="mf">107727.40</span>  <span class="mf">106021.70</span>  <span class="mf">106106.60</span>    <span class="mf">66846.686</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>  <span class="c1"># ETHUSDT sample</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>  <span class="c1"># datetime             open      high        low      close      volume</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>  <span class="mi">2019</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">27</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>     <span class="mf">146.00</span>     <span class="mf">155.66</span>     <span class="mf">125.03</span>     <span class="mf">152.52</span>    <span class="mf">115911.800</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>  <span class="mi">2019</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">28</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>     <span class="mf">154.29</span>     <span class="mf">156.52</span>     <span class="mf">146.41</span>     <span class="mf">150.48</span>    <span class="mf">116824.100</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>  <span class="mi">2019</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">29</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>     <span class="mf">150.56</span>     <span class="mf">157.40</span>     <span class="mf">150.55</span>     <span class="mf">154.41</span>    <span class="mf">167906.100</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>  <span class="o">...</span>                     <span class="o">...</span>        <span class="o">...</span>        <span class="o">...</span>        <span class="o">...</span>          <span class="o">...</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>  <span class="mi">2025</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">16</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">2546.32</span>    <span class="mf">2680.00</span>    <span class="mf">2513.38</span>    <span class="mf">2543.12</span>   <span class="mf">7101650.000</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>  <span class="mi">2025</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">2543.11</span>    <span class="mf">2617.74</span>    <span class="mf">2524.00</span>    <span class="mf">2566.31</span>   <span class="mf">2656882.000</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>  <span class="c1"># SOLUSDT sample</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>  <span class="c1"># datetime             open      high        low      close      volume</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>  <span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">14</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>       <span class="mf">3.2002</span>     <span class="mf">4.9100</span>     <span class="mf">3.2002</span>     <span class="mf">3.2661</span>   <span class="mf">4788171.00</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>  <span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">15</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>       <span class="mf">3.2629</span>     <span class="mf">3.3258</span>     <span class="mf">2.9001</span>     <span class="mf">2.9332</span>   <span class="mf">4318305.00</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>  <span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">16</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>       <span class="mf">2.9299</span>     <span class="mf">2.9299</span>     <span class="mf">2.4316</span>     <span class="mf">2.5395</span>   <span class="mf">5698128.00</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>  <span class="o">...</span>                       <span class="o">...</span>        <span class="o">...</span>        <span class="o">...</span>        <span class="o">...</span>         <span class="o">...</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a>  <span class="mi">2025</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">16</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>     <span class="mf">152.8800</span>   <span class="mf">158.6800</span>   <span class="mf">150.2400</span>   <span class="mf">150.6700</span>  <span class="mf">24626504.10</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>  <span class="mi">2025</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>     <span class="mf">150.6700</span>   <span class="mf">154.2900</span>   <span class="mf">147.4100</span>   <span class="mf">151.4200</span>  <span class="mf">10711158.30</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="p">]</span>
</code></pre></div>
<p>Each DataFrame records daily bars indexed by UTC timestamps.<br />
Rows are truncated for brevity. Note that the data ranges are 
not equal across instruments, but the algorithm handles dynamic changes 
in the universe.</p>
<p>We illustrate how the permutation affects marginal distributions.
For the period from 2019-09-08 to 2025-06-17, the BTCUSDT series contains 
2110 data points. After permuting jointly <span class="arithmatex">\( k = 3 \)</span> times, 
we plot the marginal price paths using a <em>Japanese candlestick plot</em>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">k</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">plot_japanese_candles</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">perms</span><span class="p">):</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orig</span><span class="p">))</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>        <span class="n">o</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">orig</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]]</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>    <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">:</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>            <span class="n">o</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">perm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">]]</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>            <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time index&quot;</span><span class="p">)</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Price&quot;</span><span class="p">)</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a>
<a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="n">perms</span> <span class="o">=</span> <span class="p">[</span><span class="n">permute_multi_bars</span><span class="p">(</span><span class="n">bars</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
<a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a>
<a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">original</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bars</span><span class="p">):</span>
<a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>    <span class="n">perm_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">perms_j</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">perms_j</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">]</span>
<a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a>    <span class="n">plot_japanese_candles</span><span class="p">(</span>
<a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a>        <span class="n">original</span><span class="p">,</span>
<a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a>        <span class="n">perms</span><span class="o">=</span><span class="n">perm_samples</span>
<a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a>    <span class="p">)</span>
</code></pre></div>
<p>We obtained the following plots
<img alt="alt text" src="../../archives/btc_perm.png" /></p>
<p>In red, we show the permuted price paths; in black, the original series.<br />
While the global drift is preserved, all temporal structure has been destroyed 
in the permuted walks. A cruel but illuminating exercise is to challenge 
<em>technical analysts</em> to identify so-called ``head-and-shoulders'' patterns 
on these purely random paths. This is no jibe to discretionary traders - 
an equally disturbing exercise would reveal that 
quantitative strategists, armed with modern machine learning tools, 
commit statistical overfitting — a sin no less severe than the 
confirmation bias found in technical analysis.</p>
<p>To illustrate the <em>Japanese candlestick</em> representation more clearly, a subsample of 25 consecutive data points is extracted from the BTCUSDT series.<br />
Figure below shows the original price path (black) 
alongside a single permuted path (red). 
We should verify that key stylized facts are preserved in our permutations.
An example we have taken care to preserve is the distribution of 
close-to-next-open jumps. Market microstructure effects such as gaps and overnight jumps 
are not inadvertently distorted. In cryptocurrency futures - this is not particularly interesting 
since the markets do not close, but would be pertinent in say, equities data.</p>
<p><img alt="alt text" src="../../archives/btc_permute_subsample.png" /></p>
<p>We also verify that the joint dependence among correlated instruments is preserved.
We take the last <span class="arithmatex">\( n = 500 \)</span> overlapping data points and plot their growth paths,
each scaled to its initial value. The dotted lines represent the permuted price paths.
We observe that the original series are jointly dependent, and so are the permuted series:
temporal structure is destroyed both locally and globally, but cross-sectional dependencies 
remain intact.
Consequently, derived models such as static factor models are invariant 
under the permutation procedure.</p>
<p><img alt="alt text" src="../../archives/majors_permute.png" /></p>
<p>The algorithms thus provides 
a robust foundation for use as a control in scientific experiments 
investigating machine learning of temporal effects.  </p>
<h2 id="statistical-inferencing-for-quantitative-strategies">Statistical Inferencing for Quantitative Strategies</h2>
<p>Let us conduct a thought experiment: suppose we wish to design a scientific experiment to test whether a hedge fund manager can truly identify anomalies and trading opportunities from market data.</p>
<p>Backed by patriotic investors, his fund is constrained by a long-only mandate in U.S. equities. He may have performed exceedingly well during an extended bull market — but is this success evidence of genuine skill, or simply the result of swimming with the tide?</p>
<p>If we were to replace his stock selection with random dice rolls, his long-only mandate would still yield respectable returns. This form of return decomposition is standard: such profits are attributed to the portfolio's exposure to market <span class="arithmatex">\(\beta\)</span>.</p>
<p>To assess genuine <em>skill</em>, we are interested in whether the manager has delivered positive risk-adjusted excess returns or has, colloquially, <em>alpha</em>:</p>
<div class="arithmatex">\[
\mathbb{E}[\alpha] &gt; 0.
\]</div>
<p>Under the factor approach, we assume</p>
<div class="arithmatex">\[
R_{it} = \alpha_i + \beta_i F_t + \varepsilon_{it},
\]</div>
<p>where <span class="arithmatex">\(\alpha_i\)</span> represents the manager's skill, <span class="arithmatex">\(\beta_i\)</span> denotes factor exposure, <span class="arithmatex">\(F_t\)</span> are systematic factor returns, and <span class="arithmatex">\(\varepsilon_{it}\)</span> is idiosyncratic noise.</p>
<p>While the factor model allows us to formalize statements about expected returns, its primary role is to decompose portfolio risk into systematic (factor) and idiosyncratic risk, rather than to establish the statistical significance of excess returns. Moreover, we wish to go beyond the restrictive <em>returns</em> framework to a more general <em>metrics</em> framework.</p>
<p>Motivated by return decomposition, we also aim to build a theoretical framework that separates trader <em>skill</em> into <em>asset selection</em> and <em>asset timing</em> components.</p>
<p>The theoretical aspects and study of statistical inferencing procedures, including both parametric and non-parametric methods, as well as the general theory of hypothesis testing.</p>
<p>Our discussion spans different phases of the quantitative trading pipeline. In particular, we examine validation procedures during early-stage model development on in-sample data, as well as rigorous downstream validation on artefacts using out-of-sample data.</p>
<p>We also address both single-strategy portfolios and multi-strategy portfolios, including validation techniques that provide strong control of the familywise error rate in the context of "alpha farms."</p>
<p>A variety of statistical tools are covered, including parametric and non-parametric tests, confidence intervals, <span class="arithmatex">\(p\)</span>-value-based tests, and <span class="arithmatex">\(\epsilon\)</span>–<span class="arithmatex">\(\delta\)</span> approaches.</p>
<p>Let's introduce some notations. A trading system typically consists of a sequence of <em>position vectors</em> (or equivalently, <em>weight vectors</em>) and the corresponding <em>return vectors</em> that generate the portfolio return series.</p>
<p>Let there be <span class="arithmatex">\(p\)</span> instruments. Denote the weight vector on day <span class="arithmatex">\(t\)</span> by <span class="arithmatex">\(\mathbf{w}_t \in \mathbb{R}^p\)</span>, and the asset return vector from day <span class="arithmatex">\(t\)</span> to <span class="arithmatex">\(t+1\)</span> by <span class="arithmatex">\(\mathbf{r}_t \in \mathbb{R}^p\)</span>. Let the portfolio leverage on day <span class="arithmatex">\(t\)</span> be the scalar <span class="arithmatex">\(\ell_t\)</span>.</p>
<p>We impose the constraint:</p>
<div class="arithmatex">\[
\| \mathbf{w}_t \|_1 
= \sum_{i=1}^p | w_{t,i} | = 1,
\quad \forall t.
\]</div>
<p>The portfolio return from day <span class="arithmatex">\(t\)</span> to <span class="arithmatex">\(t+1\)</span> is then:</p>
<div class="arithmatex">\[
R_{t+1} = \ell_t \, \mathbf{w}_t^\top \mathbf{r}_t.
\]</div>
<p>The cumulative performance over the test period is:</p>
<div class="arithmatex">\[
\prod_{t=1}^T \big( 1 + R_t \big)
= \prod_{t=1}^T \big( 1 + \ell_t \, \mathbf{w}_t^\top \mathbf{r}_t \big).
\]</div>
<h3 id="monte-carlo-permutation-methods">Monte Carlo Permutation Methods</h3>
<p>In the context of data permutations, we refer to multivariate bar permutations as discussed in <a href="#multivariate-bar-permutations">Permutation Sampling</a>. This section extends the exercise on Monte Carlo permutation testing from non-parametric statistical inferencing techniques.</p>
<p>The daily returns</p>
<div class="arithmatex">\[
R_{t+1} = \ell_t\, \mathbf{w}_t^\top \mathbf{r}_t
\]</div>
<p>are an ordered pairing between the trader’s decision logic <span class="arithmatex">\(\{\ell_t, \mathbf{w}_t\}_{t \in [T]}\)</span> and the market data sequence <span class="arithmatex">\(\{\mathbf{r}_t\}_{t \in [T]}\)</span>.</p>
<p>This pairing can be destroyed by permuting either the decision sequence or the market data series. For instance, suppose we shuffle the market data to obtain a permuted series <span class="arithmatex">\(\{\mathbf{r}_t'\}_{t \in [T]}\)</span>. The cumulative return under the original decisions but random market sequence is then:</p>
<div class="arithmatex">\[
\prod_{t=1}^T \big( 1 + \ell_t\, \mathbf{w}_t^\top \mathbf{r}_t' \big).
\]</div>
<p>This provides a principled way to compare the realized performance under the trader’s rule-based pairing against performance when the pairing is randomized.</p>
<p>We may then test the null hypothesis that the original rule-pairing is effectively random and hence has no predictive power.</p>
<p>One exercise gives the sampling distribution for such a test. In particular, if we perform <span class="arithmatex">\(M\)</span> random permutations, then under the null hypothesis, the original performance is equally likely to rank anywhere among the <span class="arithmatex">\(M+1\)</span> total outcomes. Thus, the probability that the original series ranks at least <span class="arithmatex">\(j\)</span>-th best is</p>
<div class="arithmatex">\[
\mathbb{P} \big( \text{Rank} \le j \big) = \frac{j}{M + 1}.
\]</div>
<p>Stated equivalently, there is a probability of <span class="arithmatex">\(\frac{k+1}{M+1}\)</span> that at most <span class="arithmatex">\(k\)</span> of the permuted samples achieve performance at least as good as the original.</p>
<p>At this stage, it is worth clarifying a technical subtlety that might confuse the reader. Suppose we evaluate a given performance statistic <span class="arithmatex">\(x\)</span> and run two shuffled trials, observing that the original value <span class="arithmatex">\(x\)</span> is the best among the three.</p>
<p>Under the null hypothesis of a worthless model, the probability that <span class="arithmatex">\(x\)</span> exceeds the performance of any single shuffled trial is <span class="arithmatex">\(\frac{1}{2}\)</span>. One might be tempted to multiply these pairwise probabilities, yielding <span class="arithmatex">\(\frac{1}{2}^2 = \frac{1}{4}\)</span>, which differs from the permutation rank-based p-value <span class="arithmatex">\(\frac{1}{3}\)</span>.</p>
<p>This discrepancy arises because these two p-values answer different questions. The pairwise probability <span class="arithmatex">\(\frac{1}{4}\)</span> corresponds to the sign test, which tests</p>
<div class="arithmatex">\[
H_0 : m_x = x,
\]</div>
<p>that is, whether the true median performance equals the observed value.</p>
<p>However, this is not what we test in the permutation framework. Here, we test whether the <em>specific value</em> of <span class="arithmatex">\(x\)</span> is unusually large relative to what would be expected under random pairing.</p>
<p>The permutation test conditions on the empirical distribution generated by the random reorderings, which properly accounts for finite-sample rank uncertainty rather than pairwise independence.</p>
<p>Depending on the implementation, the leverage <span class="arithmatex">\(\ell_t\)</span> may depend on the strength of the signal, the risk control component of the trading system, or both. Suppose we wish to isolate the predictive ability of the strategy independent of its risk management logic. In that case, we may fix leverage and compare the value:</p>
<div class="arithmatex">\[
\prod_{t=1}^T \big( 1 + \mathbf{w}_t^\top \mathbf{r}_t' \big)
\quad \text{against} \quad
\prod_{t=1}^T \big( 1 + \mathbf{w}_t^\top \mathbf{r}_t \big),
\]</div>
<p>where the weight sequence <span class="arithmatex">\(\{\mathbf{w}_t\}\)</span> is kept fixed and only the market return sequence is permuted.</p>
<p>More generally, the cumulative return is merely one possible performance criterion. It can be replaced by any user-defined objective function, which we shall denote:</p>
<div class="arithmatex">\[
\psi\big( \{ \ell_t, \mathbf{w}_t, \mathbf{r}_t \}_{t=1}^T \big).
\]</div>
<p>Since the permutation-based <span class="arithmatex">\(p\)</span>-value is discrete by construction, we use a large number of permutations, <span class="arithmatex">\(M \gg 0\)</span>, to better approximate the null distribution.</p>
<p>In the case of paired samples, such as the ordered sequence <span class="arithmatex">\(\{ (\mathbf{w}_t, \mathbf{r}_t) \}_{t = 1}^T\)</span>, it is a sufficient condition for exchangeability that at least one component of each pair is serially uncorrelated.</p>
<p>In practice, the weight vector sequence <span class="arithmatex">\(\{\mathbf{w}_t\}\)</span> does not generally satisfy this property, since trading decisions are typically computed using rolling windows of market data, resulting in overlap and serial dependence.</p>
<p>In contrast, the return series <span class="arithmatex">\(\{\mathbf{r}_t\}\)</span> can often be assumed to have weak or negligible serial correlation in its first moment — while it is common knowledge that their second moments <span class="arithmatex">\(\{ r_t^2 \}\)</span> exhibit serial dependence. Therefore, our permutation test remains valid in this setting.</p>
<p>If we have access to the full feature matrix <span class="arithmatex">\(\mathbf{X}\)</span> and the strategy logic,
we can pass each permuted input <span class="arithmatex">\(\mathbf{X}^{(j)}\)</span> into the strategy logic to generate a new sequence of decision and return vectors from the raw feature primitives.</p>
<p>In contrast, in the present context we assume that only the decision vectors <span class="arithmatex">\(\{ \ell_t, \mathbf{w}_t \}\)</span> and return vectors <span class="arithmatex">\(\{ \mathbf{r}_t \}\)</span> are available as artefacts of the original backtest. Consequently, the permutation test operates at a level of abstraction.</p>
<p>If we have access to the underlying strategy as a black box, we can go one step further: we permute the primitive features directly and pass each permuted input into the strategy to regenerate decisions and return vectors. This tests whether the strategy extracts genuine temporal signals from the primitive features rather than overfitting to artefactual noise.</p>
<p>In the following, we formalize hypothesis testing under these various assumptions about the availability of trading system components. The practical implementation details and code are provided in the next section: <em>A Python Implementation</em>.</p>
<h4 id="tests-for-singular-strategy">Tests for Singular Strategy</h4>
<p>In quantitative strategy development, the workflow is typically split into in-sample modeling and out-of-sample (OOS) validation. Hold-out samples are precious: once used, they lose their power as an unbiased test of real-world performance. Therefore, we aim to perform all possible fitting and stress-testing in-sample, and if we can disprove a trading strategy at this stage, we should — saving scarce OOS data for only genuinely promising models. To quantify how much in-sample performance is attributable to overfitting rather than genuine signal, we employ the following permutation test that tells us <em>how good our in-sample results</em> are in relation to <em>how good our overfitting</em> is.</p>
<div class="admonition theorem">
<p class="admonition-title">Monte Carlo Permutation Test for In-Sample Overfit Detection</p>
<p>Assume that the full trading machinery is available, including any systematic in-sample optimization procedures. Let</p>
<div class="arithmatex">\[
\psi\big(\{\ell_t, \mathbf{w}_t, \mathbf{r}_t\}_{t=1}^T \big)
\]</div>
<p>denote a scalar performance criterion (e.g., cumulative return or Sharpe ratio) computed on the original market data and decisions.</p>
<p><strong>Null hypothesis</strong></p>
<div class="arithmatex">\[
H_0 :
\psi\big( \{\ell_t, \mathbf{w}_t, \mathbf{r}_t\}_{t=1}^T \big)
\overset{d}{=}
\psi\big( \{\ell_t, \mathbf{w}_t, \mathbf{r}_{\pi(t)}\}_{t=1}^T \big)
\quad
\forall \; \pi \in \mathfrak{S}_T,
\]</div>
<p>where <span class="arithmatex">\(\mathfrak{S}_T\)</span> denotes the set of all permutations of <span class="arithmatex">\([T]\)</span>.</p>
<p>Equivalently, the trading system possesses no genuine predictive power: any apparent in-sample performance arises purely from overfitting to noise.</p>
<p><strong>Permutation procedure</strong></p>
<ul>
<li>
<p>Generate <span class="arithmatex">\(M\)</span> i.i.d. permutations of the market data sequence using a valid shuffling method (e.g., price or bar permutation).</p>
</li>
<li>
<p>For each permuted sequence, re-run the full trading machinery (including the optimizer) to obtain new decisions and compute:</p>
</li>
</ul>
<div class="arithmatex">\[
\psi^{(i)}
= \psi \Big( (\ell_t^{(i)},\, \mathbf{w}_t^{(i)},\, \mathbf{r}_t^{(i)})_{t=1}^T \Big),
\quad i \in [M].
\]</div>
<ul>
<li>Let <span class="arithmatex">\(\psi_{\mathrm{obs}}\)</span> be the value obtained on the original (unshuffled) data.</li>
</ul>
<p><strong>Test statistic</strong></p>
<p>The permutation-based <span class="arithmatex">\(p\)</span>-value is:</p>
<div class="arithmatex">\[
\hat{p}
= \frac{
1 + \sum_{i=1}^M
\mathbf{1} \big\{
\psi^{(i)} \ge \psi_{\mathrm{obs}}
\big\}
}{
M + 1 }.
\]</div>
<p>Under <span class="arithmatex">\(H_0\)</span>, this is the probability that a random realization of the strategy on permuted data produces performance at least as good as the original in-sample value.</p>
</div>
<p>Now, assume we have access to the realized leverage, weight, and return series <span class="arithmatex">\(\{\ell_t, \mathbf{w}_t, \mathbf{r}_t\}_{t=1}^T\)</span> produced by running a model on out-of-sample (OOS) data. These may come from a fully out-of-sample run using a fixed specification, from an in-sample calibrated model evaluated on a hold-out set, or from a walk-forward procedure.</p>
<p>In this setting, we have an unbiased estimate <span class="arithmatex">\(\psi(\{\ell_t, \mathbf{w}_t, \mathbf{r}_t\})\)</span> of performance. We wish to test whether the observed OOS performance is due to true <em>asset timing skill</em> rather than passive exposure to market drift or persistent positive returns in individual assets.</p>
<p>To do so, we permute the return sequence while holding the decision vectors fixed, efficiently simulating a world with no predictable timing signal. This requires neither the original strategy logic nor its optimizer, making the test computationally simple and general.</p>
<p>The procedure isolates timing skill: the weight assigned to each asset over the entire period remains fixed, while its allocation in time is shuffled. This controls for asset picking ability and tests whether the manager effectively timed changes in exposure.</p>
<div class="admonition theorem">
<p class="admonition-title">Monte Carlo Permutation Test for Out-of-Sample Asset Timing Skill</p>
<p>Let</p>
<div class="arithmatex">\[
\psi\big( \{\ell_t, \mathbf{w}_t, \mathbf{r}_t\}_{t=1}^T \big)
\]</div>
<p>denote a scalar performance criterion (e.g., cumulative return or Sharpe ratio) computed from a model applied to out-of-sample data.</p>
<p><strong>Null hypothesis</strong></p>
<div class="arithmatex">\[
H_0 :
\psi\big( \{\ell_t, \mathbf{w}_t, \mathbf{r}_t\}_{t=1}^T \big)
\overset{d}{=}
\psi\big( \{\ell_t, \mathbf{w}_t, \mathbf{r}_{\pi(t)}\}_{t=1}^T \big)
\quad
\forall \; \pi \in \mathfrak{S}_T,
\]</div>
<p>where <span class="arithmatex">\(\mathfrak{S}_T\)</span> denotes the set of all permutations of <span class="arithmatex">\([T]\)</span>.</p>
<p>Equivalently, the strategy possesses no true timing skill: its performance arises purely from exposure to drift and asset-level return persistence.</p>
<p><strong>Permutation procedure</strong></p>
<ul>
<li>
<p>Generate <span class="arithmatex">\(M\)</span> i.i.d. permutations of the time index by sampling <span class="arithmatex">\(\pi_i \in \mathfrak{S}_T\)</span> for <span class="arithmatex">\(i \in [M]\)</span>.</p>
</li>
<li>
<p>For each <span class="arithmatex">\(\pi_i\)</span>, define the permuted returns <span class="arithmatex">\(\mathbf{r}_t^{(i)} = \mathbf{r}_{\pi_i(t)}\)</span>, and compute:</p>
</li>
</ul>
<div class="arithmatex">\[
\psi^{(i)}
= \psi\big( \{\ell_t, \mathbf{w}_t, \mathbf{r}_t^{(i)}\}_{t=1}^T \big),
\quad i \in [M].
\]</div>
<p>The decision vectors <span class="arithmatex">\(\{\ell_t, \mathbf{w}_t\}\)</span> remain unchanged.</p>
<ul>
<li>Let <span class="arithmatex">\(\psi_{\mathrm{obs}}\)</span> be the original value on unshuffled data.</li>
</ul>
<p><strong>Test statistic</strong></p>
<p>The permutation-based <span class="arithmatex">\(p\)</span>-value is:</p>
<div class="arithmatex">\[
\hat{p}
= \frac{
1 + \sum_{i=1}^M
\mathbf{1} \big\{
\psi^{(i)} \ge \psi_{\mathrm{obs}}
\big\}
}{
M + 1 }.
\]</div>
<p>Under <span class="arithmatex">\(H_0\)</span>, this is the probability that the strategy achieves performance at least as good as <span class="arithmatex">\(\psi_{\mathrm{obs}}\)</span> purely by chance, with no timing skill beyond static asset exposure. We refer to this value as the <em>timer's <span class="arithmatex">\(p\)</span>-value</em>.</p>
</div>
<p>To see more clearly that this test isolates <em>asset timing</em> rather than <em>asset picking</em>, consider a simple example. Suppose the universe consists of ten assets indexed <span class="arithmatex">\(1, \ldots, 10\)</span>. The first five assets have consistent positive returns over the test period, while the last five consistently decline, so that the aggregate market drift is zero.</p>
<p>Assume the strategy has perfect asset selection: it remains long the first five and short the last five throughout, with a constant weight vector, for example,</p>
<div class="arithmatex">\[
\mathbf{w} = (0.1,\, 0.1,\, 0.1,\, 0.1,\, 0.1,\,
-0.1,\,-0.1,\,-0.1,\,-0.1,\,-0.1).
\]</div>
<p>Since the weights do not change over time, permuting the return sequence in time does not affect the average exposure to each asset: the strategy stays systematically long the winners and short the losers, regardless of how time indices are shuffled.</p>
<p>As a result, the test statistic remains large under permutation, and the permutation <span class="arithmatex">\(p\)</span>-value is not small. We therefore fail to reject the null hypothesis, concluding that there is no evidence of timing skill — correctly so, because all excess return arises purely from static asset picking, not from dynamic variation over time.</p>
<p>Thus, this test specifically quantifies the value added by changing the weights through time — the <em>asset timing</em> component — conditional on the given cross-sectional exposures.</p>
<p>In a similar setting, to test whether our performance reflects genuine <em>asset picking skill</em> rather than random allocation, we permute the cross-sectional mapping of returns at each time step while holding the decision series fixed in time. This leaves the timing structure intact but disrupts which instruments are linked to each weight. The resulting statistic quantifies the value added by selecting the right assets to hold — the <em>asset picking</em> component. We skip the formal theory-fication of this, since it is 
nearly identical, except the shuffling occurs on row-wise/cross-sectionally on the artefacts.</p>
<p>Assume we have access to the full trading machinery, including all systematic decision rules, signal generation, and risk controls. On out-of-sample (OOS) data, this machinery produces <span class="arithmatex">\(\{\ell_t, \mathbf{w}_t, \mathbf{r}_t\}_{t=1}^T\)</span>, yielding an unbiased estimate <span class="arithmatex">\(\psi(\{\ell_t, \mathbf{w}_t, \mathbf{r}_t\})\)</span> of the chosen performance criterion.</p>
<p>To test whether the observed OOS performance reflects genuine trader skill — encompassing both <em>asset picking</em> and <em>asset timing</em> — we permute the raw data itself using multivariate feature shuffling, then re-run the entire machinery on each permuted dataset. This destroys temporal effects in the feature matrix, such as pricing anomalies.</p>
<p>Because the full machinery must be rerun for each permutation, this test can be computationally demanding (but fortunately <em>embarrassingly parallel</em>). A practical approximation is to combine a time shuffle and a cross-sectional shuffle sequentially as in the permutation tests for out-of-sample asset timing and asset picking. Again - we skip the theory-fication and move on to a new setting involving a family of strategies.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>A practical example:</strong> For example, the tests discussed thus far can help distinguish whether a profitable long momentum strategy on a stock pick derives its profit from genuine momentum or simply from net positive drift. Although related, momentum and drift are distinct: momentum implies persistent, autocorrelative, predictable effects in returns, whereas drift alone is just a location parameter.</p>
</div>
<h4 id="tests-for-strategy-families">Tests for Strategy Families</h4>
<p>When selecting among multiple signal families or competing strategies, an additional statistical pitfall arises: the <em>selection bias</em>. During model development, the primary concern is the <em>training bias</em> — performance appears inflated because we iteratively tune parameters on the same dataset until we find an appealing result. This overfitting can be detected and quantified using Monte Carlo permutation methods as described earlier for in-sample testing.</p>
<p>However, once multiple candidates have been optimized in isolation, a new risk emerges: comparing these strategies against each other can be invalid if the degrees of freedom in their parameter spaces differ. An unconstrained signal family naturally has more flexibility to fit random noise than a tightly parameterized one. Comparing their in-sample performance metrics directly thus confounds model complexity with genuine predictive power.</p>
<p>In out-of-sample (OOS) evaluation, however, this asymmetry is mitigated: each strategy’s reported performance is an unbiased estimate of its true expected return under the chosen validation framework. At this point, it is tempting for a practitioner to pick the top <span class="arithmatex">\( k \)</span> strategies from a larger family of <span class="arithmatex">\( n \)</span> tested candidates, assuming the best-performing signals will maintain their edge in production.</p>
<p>This is a classic form of <em>selection bias</em>: once we select based on the observed OOS performance, we are working with the joint distribution of <em>order statistics</em>, not the marginal distribution of each candidate’s true mean performance. Failure to adjust for this can lead to systematic overestimation of true returns.</p>
<p>To address this, we extend the permutation testing framework to the signal family setting and combine it with robust multiple hypothesis testing controls. At this stage, several practical questions arise:<br />
1. Is our single best-performing strategy statistically significant?<br />
2. More generally, what is the largest value of <span class="arithmatex">\( k \)</span> such that each of our top <span class="arithmatex">\( k \)</span> strategies remains individually significant when tested against its permuted null?</p>
<p>We aim to answer these questions using the same Monte Carlo permutation approach, now applied systematically across an entire candidate pool. This provides a principled means to mitigate selection bias and quantify how many signals demonstrate genuine predictive power beyond random chance.</p>
<p>We assume the reader is familiar with the definition of the <em>familywise error rate</em> (FWER) and the distinction between <em>weak</em> and <em>strong</em> FWER control.</p>
<div class="admonition note">
<p class="admonition-title">Practical Implication for Multiple Strategy Testing</p>
<p>In quantitative research, selecting the best signals from a large candidate pool without multiple testing adjustment inflates the probability of false discoveries. Ensuring strong FWER control guarantees that the chance of selecting even a single spurious signal remains bounded by the chosen significance level <span class="arithmatex">\( \alpha \)</span>, regardless of the number of strategies tested or the proportion that truly outperform. This aligns with robust out-of-sample validation and guards against overstating edge due to chance alone.</p>
</div>
<div class="admonition theorem">
<p class="admonition-title">Permutation Test for the Best Signal in a Strategy Family</p>
<p>Let</p>
<div class="arithmatex">\[
\big\{
\psi^{(i)}(\{\ell_t, \mathbf{w}_t, \mathbf{r}_t\}_{t=1}^T)
\big\}_{i=1}^n
\]</div>
<p>denote the performance criteria for <span class="arithmatex">\( n \)</span> candidate strategies, computed on the same out-of-sample dataset. Let their ordered realizations be:</p>
<div class="arithmatex">\[
\psi_{\mathrm{obs}}^{(1)} \ge \psi_{\mathrm{obs}}^{(2)} 
\ge \dots \ge \psi_{\mathrm{obs}}^{(n)}.
\]</div>
<p>We wish to test whether the single best signal <span class="arithmatex">\( \psi_{\mathrm{obs}}^{(1)} \)</span> is statistically significant relative to a null model with no predictive power.</p>
<p><strong>Permutation procedure</strong></p>
<ul>
<li>
<p>Generate <span class="arithmatex">\( M \)</span> permuted bar datasets using a valid multivariate shuffling method.</p>
</li>
<li>
<p>For each permutation <span class="arithmatex">\( j \in [M] \)</span>, re-run the full trading machinery for all <span class="arithmatex">\( n \)</span> strategies, and record the maximum observed performance:</p>
</li>
</ul>
<div class="arithmatex">\[
\psi^{(1)}_{(j)} = \max_{i \in [n]} 
\psi^{(i)}(\{\ell_t^{(j,i)}, \mathbf{w}_t^{(j,i)}, \mathbf{r}_t^{(j,i)}\}_{t=1}^T).
\]</div>
<ul>
<li>Let <span class="arithmatex">\( \psi_{\mathrm{obs}}^{(1)} \)</span> be the best performance on unshuffled data.</li>
</ul>
<p><strong>Test statistic</strong></p>
<p>The selection-bias adjusted <span class="arithmatex">\( p \)</span>-value for the best signal is:</p>
<div class="arithmatex">\[
\hat{p}^{(1)} 
= 
\frac{
1 + \sum_{j=1}^M 
\mathbf{1} \big\{
\psi^{(1)}_{(j)} \ge \psi_{\mathrm{obs}}^{(1)}
\big\}
}{
M + 1 }.
\]</div>
<p>This tests the probability that a worthless model could produce a maximum performance at least as good as the observed best signal.</p>
</div>
<div class="admonition theorem">
<p class="admonition-title">Upper Bound for <span class="arithmatex">\( p \)</span>-values of Top <span class="arithmatex">\( k \)</span>-Best Signals</p>
<p>In the same setting as the permutation test for the best signal, consider the <span class="arithmatex">\( k \)</span>-th best signal with ordered performance <span class="arithmatex">\( \psi_{\mathrm{obs}}^{(k)} \)</span> for any <span class="arithmatex">\( k \in [n] \)</span>.</p>
<p><strong>Upper bound</strong></p>
<p>An unbiased upper bound for the <span class="arithmatex">\( p \)</span>-value adjusted for selection bias is:</p>
<div class="arithmatex">\[
p_0^{(k)}
=
\frac{
1 + \sum_{j=1}^M
\mathbf{1} \big\{
\psi^{(1)}_{(j)} \ge \psi_{\mathrm{obs}}^{(k)}
\big\}
}{
M + 1 }.
\]</div>
<p>By construction:</p>
<div class="arithmatex">\[
p^{(k)} \le p_0^{(k)},
\quad \text{and} \quad
p^{(1)} = p_0^{(1)}.
\]</div>
<p>This bound uses the same permuted maximum from each trial and is conservative for lower ranks. For optimal inference with monotonicity and strong familywise control, apply the <a href="https://www.jstor.org/stable/2669893">Romano–Wolf stepdown procedure</a>.</p>
</div>
<p>The bound above provides a general limit for the probability value of the top <span class="arithmatex">\( k \)</span> signals, generalizing the single best signal test. However, this bound is conservative because the critical region is defined by the maximum order statistic over all <span class="arithmatex">\( n \)</span> candidate strategies. Consequently, its statistical <em>power</em> is lower than desirable: we may fail to detect strategies that would be deemed significant if their exact probability values were known, leading to a potential dismissal of exploitable edge.</p>
<p>To address this, the <a href="https://www.jstor.org/stable/2669893">Romano–Wolf stepdown</a> procedure introduces a principled multiple testing method with strong familywise error control and asymptotically exact inference. This guarantees that each rank-ordered strategy's p-value reflects its own marginal significance, not just an upper bound.</p>
<p>Below is the general algorithm for its application to multiple strategy selection. The application of stepdown testing to quantitative trading was first suggested by <a href="https://www.amazon.com/Permutation-Randomization-Trading-Development-Algorithms/dp/0934380583">Masters</a>.
An algorithm for the permutation (more generally, resampling based) stepdown multiple testing is as follows:</p>
<div class="admonition theorem">
<p class="admonition-title">Romano–Wolf Stepdown Multiple Testing with Resampling</p>
<p>Let</p>
<div class="arithmatex">\[
T_1(\mathbf{X}), \; T_2(\mathbf{X}), \; \dots, \; T_m(\mathbf{X})
\]</div>
<p>be test statistics for null hypotheses<br />
<span class="arithmatex">\( H_{0,1}, \dots, H_{0,m} \)</span><br />
computed on the same dataset<br />
<span class="arithmatex">\( \mathbf{X} \)</span>.<br />
Assume the joint null distribution is invariant under a valid resampling scheme, such as permutation or bootstrap.</p>
<p>Order the observed statistics in descending order:</p>
<div class="arithmatex">\[
T_{(1),\mathrm{obs}} \ge T_{(2),\mathrm{obs}} \ge \dots \ge T_{(m),\mathrm{obs}}.
\]</div>
<p>Let<br />
<span class="arithmatex">\( \{ \mathbf{X}^{(1)}, \dots, \mathbf{X}^{(M)} \} \)</span><br />
be <span class="arithmatex">\( M \)</span> resamples under the null distribution. For each resample, compute the vector of test statistics:</p>
<div class="arithmatex">\[
T_k^{(i)} = T_k(\mathbf{X}^{(i)}), 
\quad k = 1,\dots,m, 
\; i = 1,\dots,M.
\]</div>
<p>Define the resampled stepdown maxima:</p>
<div class="arithmatex">\[
V_j^{(i)} 
= \max_{\,j \le k \le m} T_{(k)}^{(i)},
\quad i = 1,\dots,M, \;
j = 1,\dots,m.
\]</div>
<p>The stepdown adjusted <span class="arithmatex">\( p \)</span>-values are computed recursively:</p>
<div class="arithmatex">\[
\tilde{p}_{(j)} 
= \frac{
1 + \#\{ V_j^{(i)} \ge T_{(j),\mathrm{obs}} : i=1,\dots,M \}
}{
M + 1 },
\quad j = 1,\dots,m,
\]</div>
<p>and enforce monotonicity:</p>
<div class="arithmatex">\[
\hat{p}_{(1)} = \tilde{p}_{(1)}, 
\quad 
\hat{p}_{(j)} = \max\{ \hat{p}_{(j-1)}, \, \tilde{p}_{(j)} \}, 
\quad j = 2,\dots,m.
\]</div>
<p>Then <span class="arithmatex">\( \hat{p}_{(j)} \)</span> is the Romano–Wolf adjusted <span class="arithmatex">\( p \)</span>-value for hypothesis <span class="arithmatex">\( H_{(j)} \)</span>.</p>
<p>Reject <span class="arithmatex">\( H_{(j)} \)</span> at familywise level <span class="arithmatex">\( \alpha \)</span> if and only if <span class="arithmatex">\( \hat{p}_{(j)} \le \alpha \)</span>.</p>
<p>This procedure provides strong control of the familywise error rate under general dependence, using the joint resampling distribution.</p>
</div>
<p>We can use the multiple testing method for selecting <span class="arithmatex">\( k \leq n \)</span> familywise signals:</p>
<div class="admonition theorem">
<p class="admonition-title">Stepdown Algorithm for Familywise Signal Selection</p>
<p>Consider <span class="arithmatex">\( n \)</span> competing strategies evaluated on the same dataset, producing ordered performance estimates</p>
<div class="arithmatex">\[
X_{(1)} \ge X_{(2)} \ge \dots \ge X_{(n)}.
\]</div>
<p>Assume that permutation tests yield consistent estimators of the null distribution for each candidate.</p>
<p>Define the upper-bound p-values <span class="arithmatex">\( \{ p^{(j)}_0 \}_{j=1}^n \)</span> according to the upper-bound result.</p>
<p><strong>Romano–Wolf style stepdown procedure:</strong></p>
<ol>
<li><strong>Initialize.</strong> Compute all <span class="arithmatex">\( \{ p^{(j)}_0 \} \)</span> and order the statistics accordingly so that</li>
</ol>
<p>$$
   X_{(1)} \ge X_{(2)} \ge \dots \ge X_{(n)}.
   $$</p>
<ol>
<li>
<p><strong>Reject.</strong> Reject all hypotheses with <span class="arithmatex">\( p^{(j)}_0 &lt; \alpha \)</span>. If none can be rejected, stop.</p>
</li>
<li>
<p><strong>Prune.</strong> Remove all rejected candidates from the set under consideration.</p>
</li>
<li>
<p><strong>Repeat.</strong> Recompute the bounded p-values for the remaining candidates and repeat steps 2–3 until no more rejections occur.</p>
</li>
<li>
<p><strong>Output.</strong> Declare all rejected null hypotheses as significant. The remaining ones cannot be rejected.</p>
</li>
</ol>
<p>Optionally, to obtain an exact adjusted p-value for each rejected hypothesis, remove only the highest-ranking candidate at each step, repeating until no further rejections occur.</p>
<p>This algorithm provides asymptotically strong control of the familywise error rate and is uniformly more powerful than the simple maximum-bound test.</p>
</div>
<p>At each stepdown, we approximate the joint null distribution restricted to those which have not yet rejected the null hypothesis, thus shrinking the number of competing distributions.</p>
<p>Note that we need to terminate the algorithm once the best candidate no longer rejects the null hypothesis to ensure monotonicity.</p>
<p>In practice, the permutation samples used to approximate the null distribution can be computed once and cached. The stepdown iterations can then be performed by referencing these cached samples, avoiding redundant re-evaluation of the full trading machinery.</p>
<h4 id="a-python-implementation">A Python Implementation</h4>
<p>This section provides a concrete reference implementation for the permutation-based hypothesis tests discussed above. Most tests share the same structure: they differ only in the specific experimental design used to retrieve or resample the input artefacts.</p>
<p>Since including an entire trading machinery in text is impractical, we demonstrate the core steps using:
- the timer’s <span class="arithmatex">\( p \)</span>-value test,
- the picker’s <span class="arithmatex">\( p \)</span>-value test, and
- the stepdown algorithm for familywise selection.</p>
<p>All other tests follow the same structural pattern, with the stepdown procedure as an extension.</p>
<p><strong>Artefacts</strong></p>
<p>We assume the artefacts available to us are as follows:</p>
<div class="arithmatex">\[
\ell_t, \quad 
\mathbf{w}_t, \quad 
\mathbf{r}_t, \quad 
\mathbf{e}_t,
\]</div>
<p>where:
- <code>retdf</code> stores <span class="arithmatex">\(\mathbf{r}_t\)</span> (asset returns),
- <code>leverages</code> stores <span class="arithmatex">\(\ell_t\)</span> (scalar leverage),
- <code>weights</code> stores <span class="arithmatex">\(\mathbf{w}_t\)</span> (portfolio weights),
- <code>eligs</code> stores <span class="arithmatex">\(\mathbf{e}_t\)</span> (indicator matrix of which assets are tradable).</p>
<p>A sample Binance perpetual futures dataset is used for illustration (BTCUSDT, ETHUSDT, SOLUSDT) with about 1,500 daily observations. The typical strategy equity curve is presented in the figure below:</p>
<p><img alt="Momentum strategy equity curve" src="../../archives/momentum_majors.png" /></p>
<p>Below is an example snapshot of the artefacts:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="s2">&quot;Example artefacts for permutation tests&quot;</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="c1"># retdf: daily returns</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>                           <span class="n">BTCUSDT</span>   <span class="n">ETHUSDT</span>   <span class="n">SOLUSDT</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>  <span class="mf">0.005954</span> <span class="o">-</span><span class="mf">0.055886</span> <span class="o">-</span><span class="mf">0.197734</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">23</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span><span class="mf">0.074293</span> <span class="o">-</span><span class="mf">0.086495</span> <span class="o">-</span><span class="mf">0.214828</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">24</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>  <span class="mf">0.119130</span>  <span class="mf">0.263585</span>  <span class="mf">0.281437</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="o">...</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="mi">2025</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span><span class="mf">0.006028</span>  <span class="mf">0.009119</span>  <span class="mf">0.004978</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="c1"># leverages: scalar leverage per day</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.018014</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">23</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.016389</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">24</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.016349</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="o">...</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="mi">2025</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>    <span class="mf">0.618555</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="c1"># weights: per-asset weights</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>                           <span class="n">BTCUSDT</span> <span class="n">w</span>  <span class="n">ETHUSDT</span> <span class="n">w</span>  <span class="n">SOLUSDT</span> <span class="n">w</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>  <span class="o">-</span><span class="mf">0.484909</span>  <span class="o">-</span><span class="mf">0.366374</span>  <span class="o">-</span><span class="mf">0.148717</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">23</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>  <span class="o">-</span><span class="mf">0.398883</span>  <span class="o">-</span><span class="mf">0.324146</span>  <span class="o">-</span><span class="mf">0.276971</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">24</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>  <span class="o">-</span><span class="mf">0.444401</span>  <span class="o">-</span><span class="mf">0.285676</span>  <span class="o">-</span><span class="mf">0.269924</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="o">...</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="mi">2025</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>   <span class="mf">0.341388</span>  <span class="o">-</span><span class="mf">0.376209</span>  <span class="o">-</span><span class="mf">0.282403</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="c1"># eligs: eligibility flags (True = tradable)</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>                           <span class="n">BTCUSDT</span>  <span class="n">ETHUSDT</span>  <span class="n">SOLUSDT</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>     <span class="kc">True</span>     <span class="kc">True</span>     <span class="kc">True</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">23</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>     <span class="kc">True</span>     <span class="kc">True</span>     <span class="kc">True</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">24</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>     <span class="kc">True</span>     <span class="kc">True</span>     <span class="kc">True</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="o">...</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="mi">2025</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">17</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>     <span class="kc">True</span>     <span class="kc">True</span>     <span class="kc">True</span>
</code></pre></div>
<p>The permutation tests share the same skeleton:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="s2">&quot;Permutation test template&quot;</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">permutation_shuffler_test</span><span class="p">(</span><span class="n">metric_func</span><span class="p">,</span> <span class="n">permuter</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="n">unpermuted</span> <span class="o">=</span> <span class="n">metric_func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="n">criterions</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>        <span class="n">artefacts</span> <span class="o">=</span> <span class="n">permuter</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>        <span class="n">criterions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_func</span><span class="p">(</span><span class="o">**</span><span class="n">artefacts</span><span class="p">))</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="n">k</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">criterions</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="n">unpermuted</span><span class="p">)</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>    <span class="n">p_value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="k">return</span> <span class="n">p_value</span>
</code></pre></div>
<p>Where:
- <code>metric_func</code> computes a scalar performance criterion <span class="arithmatex">\(\psi\)</span>.
- <code>permuter</code> reshuffles artefacts under the null hypothesis.
- <code>M</code> is the number of permutations.</p>
<p>A simple metric function might compute the Sharpe ratio:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="s2">&quot;Example metric function&quot;</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">metric</span><span class="p">(</span><span class="n">levs</span><span class="p">,</span> <span class="n">rets</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>    <span class="n">capital_ret</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>        <span class="n">l</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">levs</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rets</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="p">]</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">capital_ret</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">capital_ret</span><span class="p">)</span>
</code></pre></div>
<p>A generic permuter shuffles either the time or cross-sectional axis while respecting eligibility constraints. The time-shuffle needs to ensure that the one-norm of weights equals <span class="arithmatex">\( 1 \)</span>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="s2">&quot;Generic shuffler&quot;</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">shuffle_weights_on_eligs</span><span class="p">(</span><span class="n">weights_df</span><span class="p">,</span> <span class="n">eligs_df</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">):</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>    <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;xs&quot;</span><span class="p">]</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>        <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>        <span class="k">for</span> <span class="n">wc</span><span class="p">,</span> <span class="n">ec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">eligs_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>            <span class="n">msk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ec</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>            <span class="n">prm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">wc</span><span class="p">[</span><span class="n">msk</span><span class="p">])</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>            <span class="n">nwc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wc</span><span class="p">))</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>            <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">nwc</span><span class="p">,</span> <span class="n">msk</span><span class="p">,</span> <span class="n">prm</span><span class="p">)</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">nwc</span><span class="p">))</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>        <span class="n">nweight</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>        <span class="n">nweight</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">columns</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>        <span class="n">nweight</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">index</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>        <span class="n">nweight</span> <span class="o">=</span> <span class="n">nweight</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nweight</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>        <span class="k">return</span> <span class="n">nweight</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;xs&quot;</span><span class="p">:</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="k">for</span> <span class="n">wr</span><span class="p">,</span> <span class="n">er</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weights_df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">eligs_df</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>            <span class="n">msk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">er</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>            <span class="n">prm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">wr</span><span class="p">[</span><span class="n">msk</span><span class="p">])</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>            <span class="n">nwr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wr</span><span class="p">))</span>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>            <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">nwr</span><span class="p">,</span> <span class="n">msk</span><span class="p">,</span> <span class="n">prm</span><span class="p">)</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">nwr</span><span class="p">))</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>        <span class="n">nweight</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>        <span class="n">nweight</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">columns</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>        <span class="n">nweight</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">weights_df</span><span class="o">.</span><span class="n">index</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>        <span class="k">return</span> <span class="n">nweight</span>
</code></pre></div>
<p>Specific permuters for timer and picker tests are then trivial:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="s2">&quot;Specific permuters for timer/picker&quot;</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">time_shuffler</span><span class="p">(</span><span class="n">levs</span><span class="p">,</span> <span class="n">rets</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">eligibles</span><span class="p">):</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>    <span class="n">weights</span> <span class="o">=</span> <span class="n">shuffle_weights_on_eligs</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">eligibles</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;levs&quot;</span><span class="p">:</span> <span class="n">levs</span><span class="p">,</span> <span class="s2">&quot;rets&quot;</span><span class="p">:</span> <span class="n">rets</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">weights</span><span class="p">}</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">pick_shuffler</span><span class="p">(</span><span class="n">levs</span><span class="p">,</span> <span class="n">rets</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">eligibles</span><span class="p">):</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="n">weights</span> <span class="o">=</span> <span class="n">shuffle_weights_on_eligs</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">eligibles</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;xs&quot;</span><span class="p">)</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;levs&quot;</span><span class="p">:</span> <span class="n">levs</span><span class="p">,</span> <span class="s2">&quot;rets&quot;</span><span class="p">:</span> <span class="n">rets</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="n">weights</span><span class="p">}</span>
</code></pre></div>
Finally, run the tests and obtain timer’s and picker’s <span class="arithmatex">\( p \)</span>-values:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="s2">&quot;Running the permutation tests&quot;</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">timer_p</span> <span class="o">=</span> <span class="n">permutation_shuffler_test</span><span class="p">(</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="n">metric_func</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="n">permuter</span><span class="o">=</span><span class="n">time_shuffler</span><span class="p">,</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="n">M</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="n">levs</span><span class="o">=</span><span class="n">leverages</span><span class="p">,</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>    <span class="n">rets</span><span class="o">=</span><span class="n">retdf</span><span class="p">,</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>    <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>    <span class="n">eligibles</span><span class="o">=</span><span class="n">eligs</span><span class="p">,</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="p">)</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="n">picker_p</span> <span class="o">=</span> <span class="n">permutation_shuffler_test</span><span class="p">(</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="n">metric_func</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>    <span class="n">permuter</span><span class="o">=</span><span class="n">pick_shuffler</span><span class="p">,</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>    <span class="n">M</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>    <span class="n">levs</span><span class="o">=</span><span class="n">leverages</span><span class="p">,</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>    <span class="n">rets</span><span class="o">=</span><span class="n">retdf</span><span class="p">,</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>    <span class="n">eligibles</span><span class="o">=</span><span class="n">eligs</span><span class="p">,</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="p">)</span>
</code></pre></div>
<p>The Sharpe ratio of the original strategy is approximately <span class="arithmatex">\( 0.49 \)</span>. The permutation tests yield <span class="arithmatex">\( p \)</span>-values of about <span class="arithmatex">\( 0.1129 \)</span> for timing skill and <span class="arithmatex">\( 0.1998 \)</span> for picking skill, respectively. This indicates a fair chance that the observed performance arose largely from noise. One might also interpret this to mean that, for momentum-based strategies, timing the exposures contributes more to significance than picking the exact assets, since market returns are time-varying and individual returns are strongly correlated.</p>
<p>Additionally, we demonstrate the <em>stepdown procedure</em> for testing multiple competing strategies simultaneously. The function takes the following arguments, assuming we have already obtained the cached values of their permuted and unpermuted performance statistics:</p>
<ul>
<li><code>unpermuted_criterions</code>: a 1D array of length <span class="arithmatex">\( n \)</span> containing the observed performance statistics (e.g., Sharpe ratios) for each of the <span class="arithmatex">\( n \)</span> strategies.</li>
<li><code>round_criterions</code>: a list of length <span class="arithmatex">\( M \)</span>, where each element is itself a 1D array of length <span class="arithmatex">\( n \)</span> giving the permuted performance statistics for all strategies in that permutation trial.</li>
<li><code>alpha</code>: the familywise significance level used as the rejection threshold in the stepdown procedure.</li>
</ul>
<p>The output consists of:</p>
<ul>
<li><code>pvalues</code>: an array of length <span class="arithmatex">\( n \)</span> containing the final Romano–Wolf stepdown adjusted <span class="arithmatex">\( p \)</span>-values for each strategy.</li>
<li><code>exact</code>: a boolean array indicating for each strategy whether its final <span class="arithmatex">\( p \)</span>-value is exact (determined at its rejection step) or only bounded.</li>
</ul>
<p>The implementation follows the stepdown logic and ensures monotonicity and strong familywise error rate control.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="s2">&quot;Stepdown procedure for multiple strategies&quot;</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">stepdown_algorithm</span><span class="p">(</span><span class="n">unpermuted_criterions</span><span class="p">,</span> <span class="n">round_criterions</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="n">pvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">unpermuted_criterions</span><span class="p">))</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="n">exact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">unpermuted_criterions</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unpermuted_criterions</span><span class="p">))))</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="k">while</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">exact</span><span class="p">):</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>        <span class="n">stepwise_indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="o">~</span><span class="n">exact</span><span class="p">]</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>        <span class="n">stepwise_criterions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unpermuted_criterions</span><span class="p">)[</span><span class="n">stepwise_indices</span><span class="p">]</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>        <span class="n">member_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stepwise_criterions</span><span class="p">))</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>        <span class="k">for</span> <span class="nb">round</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">round_criterions</span><span class="p">)):</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>            <span class="n">round_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">round_criterions</span><span class="p">[</span><span class="nb">round</span><span class="p">])[</span><span class="n">stepwise_indices</span><span class="p">])</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>            <span class="n">member_count</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">+</span> <span class="n">round_max</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stepwise_criterions</span><span class="p">))</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>        <span class="n">bounded_pvals</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">member_count</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">round_criterions</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>        <span class="n">best_member</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">bounded_pvals</span><span class="p">)</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>        <span class="n">exact</span><span class="p">[</span><span class="n">stepwise_indices</span><span class="p">[</span><span class="n">best_member</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>        <span class="n">pvalues</span><span class="p">[</span><span class="n">stepwise_indices</span><span class="p">[</span><span class="n">best_member</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bounded_pvals</span><span class="p">)</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bounded_pvals</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">alpha</span><span class="p">:</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>            <span class="k">for</span> <span class="n">bounded_p</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bounded_pvals</span><span class="p">,</span> <span class="n">stepwise_indices</span><span class="p">):</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>                <span class="n">pvalues</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounded_p</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>            <span class="k">break</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>    <span class="k">return</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">exact</span>
</code></pre></div>
<h3 id="finite-sample-probabilistic-bounds">Finite Sample Probabilistic Bounds</h3>
<p>While the permutation tests and stepdown procedures provide empirical control of false discoveries under minimal assumptions, it is equally important to establish theoretical guarantees for performance estimates in finite samples.</p>
<p>In this section, we study non-asymptotic probabilistic inequalities that bound the deviation of popular estimators such as Sharpe ratios.</p>
<p>The mathematical foundations for these statements require standard inequalities (Hoeffding, Bernstein, and related concentration bounds), but we focus on the results apart from the technical details. These were first introduced as the <em>Rademacher Anti-Serum</em> (RAS) technique by <a href="https://www.wiley.com/en-us/The+Elements+of+Quantitative+Investing-p-9781394265466">Paleologo</a>.</p>
<p>While our empirical permutation tests provide robust control of overfitting and false discoveries, they do not directly yield closed-form guarantees on the estimation error of a given statistic at a fixed sample size. Finite-sample concentration inequalities address this gap by providing explicit, non-asymptotic probability bounds.</p>
<p>A <em>finite-sample probabilistic bound</em> is a quantitative guarantee on the deviation of a statistic or estimator from its true population value, valid for a fixed sample size <span class="arithmatex">\( n \)</span>. More precisely, for a parameter <span class="arithmatex">\( \theta \)</span> and an estimator <span class="arithmatex">\( \hat{\theta}_n \)</span> computed from <span class="arithmatex">\( n \)</span> samples, one seeks a bound of the form:</p>
<div class="arithmatex">\[
\mathbb{P}\big( \lvert \hat{\theta}_n - \theta \rvert \ge \epsilon \big) \le \delta,
\]</div>
<p>where <span class="arithmatex">\( \epsilon \)</span> is a prescribed tolerance and <span class="arithmatex">\( \delta \)</span> is the chosen probability level (e.g., 5%).</p>
<p>The RAS method provides a mathematically <em>robust lower bound</em> on the true (out-of-sample) performance of a strategy, given its in-sample performance. RAS “haircuts” the empirical Sharpe to account for multiple testing and model complexity.</p>
<p>In RAS, the <strong>Sharpe ratio</strong> is defined on a <em>per-period basis</em> using <em>standardized returns</em>. Suppose a strategy (portfolio) has weight vector <span class="arithmatex">\( w_{t,n} \)</span> at time <span class="arithmatex">\( t \)</span>, asset return vector <span class="arithmatex">\( r_t \)</span>, and covariance matrix <span class="arithmatex">\( \Omega_t \)</span>. Then the one-period standardized return is:</p>
<div class="arithmatex">\[
\hat{\zeta}_{t,n} = \frac{w_{t,n}^\top r_t}{\sqrt{w_{t,n}^\top \Omega_t w_{t,n}}}.
\]</div>
<p>By <em>standardizing</em> returns each period, we ensure these performance observations are comparable and (approximately) i.i.d. over time. Using standardized returns as building blocks means that over <span class="arithmatex">\( T \)</span> periods, a strategy’s sequence</p>
<div class="arithmatex">\[
\hat{\zeta}_{1,n}, \; \hat{\zeta}_{2,n}, \; \ldots, \; \hat{\zeta}_{T,n}
\]</div>
<p>can be treated as samples from a distribution whose mean equals the <em>true Sharpe ratio</em>.</p>
<p>Essentially, instead of computing a single Sharpe over the whole sample, we decompose it into <span class="arithmatex">\( T \)</span> observations of “Sharpe units” for statistical analysis.</p>
<p>The data is then organized into a matrix <span class="arithmatex">\( \mathbf{X} \in \mathbb{R}^{T \times N} \)</span>, where <span class="arithmatex">\( T \)</span> is the number of time periods and <span class="arithmatex">\( N \)</span> is the number of strategies, with each entry given by:</p>
<div class="arithmatex">\[
\hat{\zeta}_{t,n}.
\]</div>
<p>Each row vector <span class="arithmatex">\( x_t \)</span> can be viewed as an independent draw from some distribution, implying no serial correlation — a reasonable approximation in practice. Each column vector corresponds to a strategy, with strategy <span class="arithmatex">\( n \)</span> having some true mean:</p>
<div class="arithmatex">\[
\theta_n = \mathbb{E}[\, x_{t,n} \,].
\]</div>
<p>The sample mean vector <span class="arithmatex">\( \hat{\theta} \)</span> is then the empirical performance estimate:</p>
<div class="arithmatex">\[
\hat{\theta} = \frac{1}{T} \sum_{t=1}^T x_t.
\]</div>
<div class="admonition defn">
<p class="admonition-title">Rademacher Random Vector</p>
<p>A <em>Rademacher random vector</em> is<br />
$$
\epsilon = (\epsilon_1, \ldots, \epsilon_T),<br />
\quad \epsilon_t \in {+1, -1} \text{ i.i.d.}.
$$</p>
</div>
<p>The RAS framework uses the Rademacher random vector to quantify the capacity of a strategy to fit random noise, known as the <em>Rademacher complexity</em>.</p>
<p>For a simple 2-period problem, the set of possible Rademacher vectors corresponds to the corners of the Cartesian plane.</p>
<p><img src="../archives/cartesian_poles.jpeg" alt="Rademacher vectors for a two-step problem" width="300" /></p>
<div class="admonition defn">
<p class="admonition-title">Empirical Rademacher Complexity</p>
<p>Given a finite sample matrix <span class="arithmatex">\( \mathbf{X} \in \mathbb{R}^{T \times N} \)</span> with <span class="arithmatex">\( N \)</span> strategies (columns), the <em>empirical Rademacher complexity</em> is</p>
<div class="arithmatex">\[
\hat{R} 
= \mathbb{E}_{\epsilon} 
\Bigg[
\sup_{1 \le n \le N} 
\frac{\epsilon^\top x^n}{T}
\Bigg],
\]</div>
<p>where <span class="arithmatex">\( \epsilon \)</span> is a Rademacher random vector and <span class="arithmatex">\( x^n \)</span> denotes the <span class="arithmatex">\( n \)</span>-th strategy column of <span class="arithmatex">\( \mathbf{X} \)</span>.</p>
</div>
<div class="admonition note">
<p>Since the entries are standardized returns, the norm of any strategy column satisfies</p>
<div class="arithmatex">\[
\| x^n \| 
= \sqrt{ 
\sum_{i=1}^T x_i^2 
} 
\approx \sqrt{T}.
\]</div>
<p>The Rademacher vector norm is exactly</p>
<div class="arithmatex">\[
\| \epsilon \| 
= \sqrt{ 
\sum_{i=1}^T \epsilon_i^2 
} 
= \sqrt{T},
\]</div>
<p>since each <span class="arithmatex">\( \epsilon_i \in \{ +1, -1 \} \)</span>.</p>
<p>Therefore, a rough approximation is</p>
<div class="arithmatex">\[
\hat{R} 
\approx 
\sup_{n} 
\frac{ 
\epsilon^\top x^n 
}{
\| \epsilon \| \, \| x^n \|
},
\]</div>
<p>which is the maximum cosine of the angle between the random noise vector and each strategy vector.</p>
</div>
<p>Geometrically, <span class="arithmatex">\( \epsilon \)</span> is a random direction in the <span class="arithmatex">\( T \)</span>-dimensional time-series space. The Rademacher complexity quantifies how well the family of strategy vectors aligns with an arbitrary noise direction. If the strategies are maximally orthogonal, they span a large subspace in <span class="arithmatex">\( T \)</span>-dimensional space, and thus can align with many directions. Conversely, if the strategies are highly similar (e.g., all pairwise highly correlated), then they span a narrow subspace and cannot easily align with arbitrary noise, implying a lower chance of overfitting.</p>
<p>The RAS bounds make the following guarantee:</p>
<blockquote>
<p><em>“With high confidence, the true Sharpe or Information Coefficient (IC) of strategy <span class="arithmatex">\( n \)</span> is at least its backtested Sharpe/IC minus a complexity penalty (data-snooping haircut) and minus a statistical sampling error term.”</em></p>
</blockquote>
<div class="admonition theorem">
<p class="admonition-title">Finite-Sample Rademacher Bound for the Sharpe Ratio</p>
<p>Let <span class="arithmatex">\( \hat{\theta}_n \)</span> be the empirical Sharpe ratio for strategy <span class="arithmatex">\( n \)</span>, and <span class="arithmatex">\( \hat{R} \)</span> its empirical Rademacher complexity. Then, with probability at least <span class="arithmatex">\( 1 - \delta \)</span>:</p>
<div class="arithmatex">\[
\theta_n \geq \underbrace{\hat{\theta}_n}_{\text{Empirical}} - \underbrace{2 \hat{R}}_{\text{Overfitting penalty}} - \underbrace{3 \sqrt{\frac{2 \ln(2/\delta)}{T}}}_{\text{Finite sampling}} - \underbrace{\sqrt{\frac{2 \ln(2N/\delta)}{T}}}_{\text{Multiple testing}}.
\]</div>
<p>The last two terms reflect finite-sample uncertainty and multiple-testing correction. Both vanish asymptotically as the sample size <span class="arithmatex">\( T \)</span> increases.</p>
</div>
<p><strong>RAS</strong> applies a <em>global penalty</em> term <span class="arithmatex">\( 2 \hat{R} \)</span> that depends on the complexity of the entire set of strategies, but the final lower bound is <em>computed individually for each strategy</em>.</p>
<p>We demonstrate a Python implementation — for the retrieval of data and strategy backtests, we assume the reader has access to <a href="https://quantpylib.hangukquant.com">quantpylib</a>. An alternative simulation engine may be used — the interpretations should be no different and modification of the code should be trivial.</p>
<p>In practice, we have <span class="arithmatex">\( n \)</span> strategies, each with its own return vector. We compute <strong>standardised returns</strong> by normalising each strategy’s raw return by an estimate of instantaneous volatility.</p>
<p>We assume we have a list of <code>DataFrames</code> <code>dfs</code>, each with indices for different time ranges. We use maximally overlapping joint periods along the time axis. To demonstrate that the complexity penalty depends on the orthogonality of the strategies, we choose <span class="arithmatex">\( N = 6 \)</span> and compare a set of <span class="arithmatex">\( N \)</span> momentum strategies with <span class="arithmatex">\( N \)</span> random strategies as follows:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">strategies</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>    <span class="s2">&quot;tszscore_12(close)&quot;</span><span class="p">,</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>    <span class="s2">&quot;tszscore_24(close)&quot;</span><span class="p">,</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    <span class="s2">&quot;logret_5(close)&quot;</span><span class="p">,</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    <span class="s2">&quot;logret_20(close)&quot;</span><span class="p">,</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    <span class="s2">&quot;ite(gt(ema_20(close), ema_50(close)), const_1, neg(const_1))&quot;</span><span class="p">,</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="s2">&quot;ite(gt(ema_50(close), ema_100(close)), const_1, neg(const_1))&quot;</span><span class="p">,</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="p">]</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="n">random_strategies</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    <span class="s2">&quot;random_-1/1&quot;</span><span class="p">,</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    <span class="s2">&quot;random_-1/1&quot;</span><span class="p">,</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>    <span class="s2">&quot;random_-1/1&quot;</span><span class="p">,</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="s2">&quot;random_-1/1&quot;</span><span class="p">,</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>    <span class="s2">&quot;random_-1/1&quot;</span><span class="p">,</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>    <span class="s2">&quot;random_-1/1&quot;</span><span class="p">,</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="p">]</span>
</code></pre></div>
<p>The momentum strategies trade on rolling time-series <span class="arithmatex">\( k \)</span>-day <span class="arithmatex">\( z \)</span>-scores, log returns, and moving average pairs. The random strategies act as simple random voting machines.</p>
<p>All strategies are tested under the <em>GeneticAlpha</em> engine of the <a href="https://quantpylib.hangukquant.com">quantpylib</a> library. This engine maps arbitrary raw signals to valid position sizes using a volatility targeting scheme.</p>
<p>Therefore, although each trading strategy has a different signal domain, their portfolio sizing and allocations are commensurate due to matching in volatility space. The simulation runs as follows:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pytz</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.standards</span><span class="w"> </span><span class="kn">import</span> <span class="n">Period</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.datapoller.master</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataPoller</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">quantpylib.simulator.gene</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeneticAlpha</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="n">keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;binance&quot;</span><span class="p">:</span> <span class="p">{}}</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="n">datapoller</span> <span class="o">=</span> <span class="n">DataPoller</span><span class="p">(</span><span class="n">config_keys</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="n">interval</span> <span class="o">=</span> <span class="n">Period</span><span class="o">.</span><span class="n">DAILY</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>    <span class="n">period_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>    <span class="n">period_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>    <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>        <span class="s2">&quot;BTCUSDT&quot;</span><span class="p">,</span><span class="s2">&quot;ETHUSDT&quot;</span><span class="p">,</span><span class="s2">&quot;SOLUSDT&quot;</span><span class="p">,</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>        <span class="s2">&quot;BNBUSDT&quot;</span><span class="p">,</span><span class="s2">&quot;XRPUSDT&quot;</span><span class="p">,</span><span class="s2">&quot;LTCUSDT&quot;</span><span class="p">,</span><span class="s2">&quot;DOGEUSDT&quot;</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>    <span class="p">]</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>    <span class="n">ticker_dfs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>        <span class="o">*</span><span class="p">[</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a>            <span class="n">datapoller</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">get_trade_bars</span><span class="p">(</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>                <span class="n">ticker</span><span class="o">=</span><span class="n">ticker</span><span class="p">,</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>                <span class="n">start</span><span class="o">=</span><span class="n">period_start</span><span class="p">,</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>                <span class="n">end</span><span class="o">=</span><span class="n">period_end</span><span class="p">,</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>                <span class="n">granularity</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a>                <span class="n">granularity_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a>                <span class="n">src</span><span class="o">=</span><span class="s2">&quot;binance&quot;</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>            <span class="p">)</span>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>            <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a>        <span class="p">]</span>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a>    <span class="p">)</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a>    <span class="n">dfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">ticker</span><span class="p">:</span> <span class="n">df</span> <span class="k">for</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">ticker_dfs</span><span class="p">)}</span>
<a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>
<a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a>    <span class="n">configs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a>        <span class="s2">&quot;dfs&quot;</span><span class="p">:</span> <span class="n">dfs</span><span class="p">,</span>
<a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a>        <span class="s2">&quot;instruments&quot;</span><span class="p">:</span> <span class="n">tickers</span><span class="p">,</span>
<a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a>        <span class="s2">&quot;granularity&quot;</span><span class="p">:</span> <span class="n">interval</span><span class="p">,</span>
<a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a>        <span class="s2">&quot;around_the_clock&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a>        <span class="s2">&quot;weekend_trading&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a>    <span class="p">}</span>
<a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a>
<a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a>    <span class="k">for</span> <span class="n">_strategies</span> <span class="ow">in</span> <span class="p">[</span><span class="n">strategies</span><span class="p">,</span> <span class="n">random_strategies</span><span class="p">]:</span>
<a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a>        <span class="n">alphas</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a>            <span class="n">GeneticAlpha</span><span class="p">(</span><span class="n">genome</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span> <span class="o">**</span><span class="n">configs</span><span class="p">)</span>
<a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a>            <span class="k">for</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="n">_strategies</span>
<a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a>        <span class="p">]</span>
<a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a>        <span class="n">sim_dfs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
<a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a>            <span class="n">alpha</span><span class="o">.</span><span class="n">run_simulation</span><span class="p">()</span> <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphas</span>
<a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a>        <span class="p">])</span>
<a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a>        <span class="n">r_series</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a>            <span class="n">alpha</span><span class="o">.</span><span class="n">_get_zero_filtered_stats</span><span class="p">()[</span><span class="s1">&#39;capital_ret&#39;</span><span class="p">]</span>
<a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a>            <span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphas</span>
<a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a>        <span class="p">]</span>
<a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alphas</span><span class="p">):</span>
<a id="__codelineno-18-58" name="__codelineno-18-58" href="#__codelineno-18-58"></a>            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sim_dfs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">capital</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">_strategies</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-18-59" name="__codelineno-18-59" href="#__codelineno-18-59"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-18-60" name="__codelineno-18-60" href="#__codelineno-18-60"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-18-61" name="__codelineno-18-61" href="#__codelineno-18-61"></a>
<a id="__codelineno-18-62" name="__codelineno-18-62" href="#__codelineno-18-62"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-18-63" name="__codelineno-18-63" href="#__codelineno-18-63"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-18-64" name="__codelineno-18-64" href="#__codelineno-18-64"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
<p>For the correlated, momentum strategies, the results are presented in the figure below:
<img alt="Log-Equity curves and standardized returns for momentum strategies" src="../../archives/correlated_strategies.jpeg" /></p>
<p>For the uncorrelated, random strategies, the results are presented in the figure below:
<img alt="Log-Equity curves and standardized returns for random strategies" src="../../archives/random_strategies.jpeg" /></p>
<p>For each of these <span class="arithmatex">\( r\_series \)</span>, we can compute the matrix <span class="arithmatex">\( \mathbf{X} \)</span>:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">construct_matrix_from_series</span><span class="p">(</span><span class="n">rets_list</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>    <span class="n">z_scores</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">rets_list</span><span class="p">:</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>        <span class="n">vol</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>        <span class="n">z</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">vol</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>        <span class="n">z_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>    <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">z_scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>    <span class="n">X</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;strat_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rets_list</span><span class="p">))]</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>    <span class="k">return</span> <span class="n">X</span>
</code></pre></div>
for something like this:
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>                      strat_0   strat_1   strat_2   strat_3   strat_4   strat_5
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>2019-11-16 00:00:00 -0.101047 -0.092185 -0.106894 -0.094918  0.094017 -0.083680
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>2019-11-17 00:00:00 -0.081593 -0.072605 -0.084810  0.074504  0.075649 -0.065085
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>2019-11-18 00:00:00  1.919402  1.713399  1.970364  1.750723 -1.790322  1.619088
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>2019-11-19 00:00:00  0.343418  0.296737  0.345931  0.302118 -0.318470  0.275414
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>2019-11-20 00:00:00  0.258819  0.219747  0.261856  0.224155 -0.236699  0.200970
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>...
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>2025-05-25 00:00:00  0.053872  0.162611  0.056206  0.086591  0.089944  0.162315
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>2025-05-26 00:00:00  0.185495  0.124115  0.061297  0.218383  0.002774  0.065411
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>2025-05-27 00:00:00  0.195299  0.252760  0.014410  0.208231  0.207958  0.375513
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>2025-05-28 00:00:00 -0.018980 -0.238806  0.517930 -0.326797  0.379941 -0.057888
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>2025-05-29 00:00:00 -0.229638 -0.441048 -0.344558 -0.435272 -0.332848 -0.502409
</code></pre></div>
and estimate the empirical Rademacher complexity:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">estimate_rademacher_complexity</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">n_sim</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="sd">    Empirical Rademacher complexity: E[max_n (epsilon^T x_n) / T]</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>    <span class="n">T</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>    <span class="n">X_vals</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    <span class="n">R_vals</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sim</span><span class="p">):</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>        <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>        <span class="n">max_proj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eps</span> <span class="o">@</span> <span class="n">X_vals</span><span class="p">)</span> <span class="o">/</span> <span class="n">T</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>        <span class="n">R_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_proj</span><span class="p">)</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R_vals</span><span class="p">)</span>
</code></pre></div>
and the RAS bounds are given as such:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">ras_bounds</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">R_hat</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>    <span class="n">T</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>    <span class="n">theta_hat</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="c1"># Penalty terms</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>    <span class="n">term_statistical</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="n">delta</span><span class="p">)</span> <span class="o">/</span> <span class="n">T</span><span class="p">)</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>    <span class="n">term_multiple</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">N</span> <span class="o">/</span> <span class="n">delta</span><span class="p">)</span> <span class="o">/</span> <span class="n">T</span><span class="p">)</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="n">theta_lower</span> <span class="o">=</span> <span class="n">theta_hat</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">R_hat</span> <span class="o">-</span> <span class="n">term_statistical</span> <span class="o">-</span> <span class="n">term_multiple</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>        <span class="s1">&#39;theta_hat&#39;</span><span class="p">:</span> <span class="n">theta_hat</span><span class="p">,</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>        <span class="s1">&#39;theta_rademacher&#39;</span><span class="p">:</span> <span class="n">theta_hat</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">R_hat</span><span class="p">,</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>        <span class="s1">&#39;theta_lower_bound&#39;</span><span class="p">:</span> <span class="n">theta_lower</span><span class="p">,</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>        <span class="s1">&#39;rademacher_penalty&#39;</span><span class="p">:</span> <span class="n">R_hat</span><span class="p">,</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>    <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</code></pre></div>
Putting everything together:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">X</span> <span class="o">=</span> <span class="n">construct_matrix_from_series</span><span class="p">(</span><span class="n">r_series</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">R_hat</span> <span class="o">=</span> <span class="n">estimate_rademacher_complexity</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">n_sim</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="n">bounds_df</span> <span class="o">=</span> <span class="n">ras_bounds</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">R_hat</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span>
</code></pre></div>
<p>For the momentum group, we obtained the following results:
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>           theta_hat  theta_rademacher  theta_lower_bound  rademacher_penalty
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>strat_0     0.743323         0.033509           -4.011982           0.354907
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>strat_1     0.961611         0.251796           -3.793695           0.354907
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>strat_2     0.562140        -0.147674           -4.193165           0.354907
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>strat_3     0.779618         0.069804           -3.975687           0.354907
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>strat_4     0.815287         0.105473           -3.940018           0.354907
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>strat_5     0.124336        -0.585478           -4.630969           0.354907
</code></pre></div>
For the random voting machine group, we obtained the following:
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>           theta_hat  theta_rademacher  theta_lower_bound  rademacher_penalty
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>strat_0     0.423142        -0.483364           -4.484577           0.453253
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>strat_1    -0.676016        -1.582522           -5.583734           0.453253
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>strat_2    -0.020618        -0.927124           -4.928336           0.453253
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>strat_3    -0.700718        -1.607225           -5.608437           0.453253
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>strat_4    -0.887466        -1.793972           -5.795184           0.453253
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>strat_5    -0.262616        -1.169123           -5.170335           0.453253
</code></pre></div></p>
<p>The first column is the empirical point estimate of the Sharpe ratio, the second column 
is the adjusted estimate incorporating the Rademacher complexity penalty, 
and the third column is the finite-sample lower bound with the chosen confidence level. 
The last column is (half) the complexity penalty.</p>
<p>Notably, the complexity coefficient is higher in the random set due to the greater orthogonality of the random voting signals. Strategies for which the theta_rademacher value is positive can be interpreted as "Rademacher positive" — meaning they are less likely to be overfit. Strategies with a positive theta_lower_bound would be regarded as statistically significant under the chosen risk tolerance. In this example, none of the random strategies pass this threshold, and only a subset of the momentum strategies remain Rademacher positive after accounting for complexity.</p>
<p>Rademacher bounds are often conservative in practice. A large part of this conservativeness stems from the limited sample size available: one may mitigate this by computing the bounds on higher-frequency data when appropriate. Moreover, the bounds are derived from a chain of standard but generally loose inequalities, resulting in wider intervals than necessary for any specific model. For rigorous derivations and theoretical justifications, refer to the cited reference text.</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2024 <a href="https://hangukquant.com"  target="_blank" rel="noopener">Quanta Global Pte. Ltd. 202328387H - All Rights Reserved.</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/hangukquant" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1M480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2m-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3m-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>